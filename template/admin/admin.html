<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
<title>{{.title}} - 管理员</title>
<style>
:root {
  --navbar-glass-color: {{.Settings.NavbarGlassColor}};
  --card-glass-color: {{.Settings.CardGlassColor}};
  --footer-glass-color: {{.Settings.FooterGlassColor}};
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

a {
  color: rgba(255, 255, 255, 0.9);
  text-decoration: none;
}

a:hover {
  color: #fff;
}

html, body {
  height: 100%;
  width: 100%;
  overflow-x: hidden;
}

body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  position: relative;
  background-image: url('{{.Settings.BackgroundImage}}');
  background-size: {{.Settings.BackgroundSize}};
  background-position: {{.Settings.BackgroundPosition}};
  background-repeat: {{.Settings.BackgroundRepeat}};
  background-attachment: {{.Settings.BackgroundAttachment}};
  --global-opacity: {{.Settings.GlobalOpacity}};
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(5px);
  z-index: -1;
}

/* 导航栏样式 */
nav {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  position: fixed;
  top: env(safe-area-inset-top);
  right: 0;
  padding: 15px env(safe-area-inset-right) 15px env(safe-area-inset-left);
  width: 100%;
  background: var(--navbar-glass-color, rgba(255, 255, 255, 0.85));
  backdrop-filter: blur(10px) saturate(180%);
  -webkit-backdrop-filter: blur(10px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 100;
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
              opacity 0.4s ease;
  transform: translateY(0);
  opacity: 1;
}

nav.hidden {
  transform: translateY(-100%);
  opacity: 0;
}

nav a {
  color: rgba(255, 255, 255, 0.9);
  text-decoration: none;
  margin: 0 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  position: relative;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
}

nav a:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

nav a::after {
  display: none;
}

nav a.current {
  color: #fff;
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.6);
}

/* 登录按钮样式 */
#loginBtn {
  display: flex;
  align-items: center;
  gap: 8px;
  color: rgba(255, 255, 255, 0.9);
  text-decoration: none;
  margin: 0 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  cursor: pointer;
}

#loginBtn:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

/* 个人中心样式 */
#userCenterToggle {
  display: none;
  align-items: center;
  gap: 8px;
  color: rgba(255, 255, 255, 0.9);
  text-decoration: none;
  margin: 0 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  cursor: pointer;
}

#userCenterToggle:hover {
  color: #fff;
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #333;
  font-weight: bold;
  font-size: 14px;
}

/* 个人中心下拉菜单 */
#userCenter {
  display: none;
  position: fixed;
  top: calc(env(safe-area-inset-top) + 70px);
  left: 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  z-index: 101;
  min-width: 200px;
  overflow: hidden;
  animation: slideDown 0.3s ease;
}

#userCenter.active {
  display: block;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.user-center-header {
  padding: 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.user-center-header h3 {
  font-size: 1.2em;
  margin-bottom: 5px;
}

.user-center-header p {
  font-size: 0.9em;
  opacity: 0.7;
  color: rgba(255, 255, 255, 0.9);
}

.user-center-menu {
  padding: 10px 0;
}

.user-center-menu a {
  display: block;
  padding: 12px 20px;
  color: #333;
  text-decoration: none;
  transition: all 0.3s ease;
  background: transparent;
  border: none;
  border-radius: 0;
  text-shadow: none;
  margin: 0;
}

.user-center-menu a:hover {
  background: rgba(0, 123, 255, 0.1);
  color: #007bff;
  transform: none;
  box-shadow: none;
}

.user-center-menu .divider {
  height: 1px;
  background: rgba(0, 0, 0, 0.1);
  margin: 10px 20px;
}

#logoutBtn {
  display: block;
  padding: 12px 20px;
  color: #e74c3c;
  text-decoration: none;
  transition: all 0.3s ease;
  background: transparent;
  border: none;
  border-radius: 0;
  text-shadow: none;
  margin: 0;
  cursor: pointer;
  width: 100%;
  text-align: left;
  font-size: 1em;
}

#logoutBtn:hover {
  background: rgba(231, 76, 60, 0.1);
  color: #c0392b;
  transform: none;
  box-shadow: none;
}

/* 主内容区域 */
main {
  flex: 1;
  padding: 120px 20px 60px;
  position: relative;
  z-index: 1;
}

.title-container {
  position: relative;
  display: inline-block;
  margin: 30px 0 40px;
  text-align: center;
  width: 100%;
}

.h1 {
  text-align: center;
  color: #222;
  font-size: 3.5em;
  font-weight: 800;
  text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1), 
               0 0 15px rgba(255, 255, 255, 0.8);
  letter-spacing: 1.5px;
  line-height: 1.1;
  position: relative;
  padding-bottom: 20px;
  font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
  display: inline-block;
}

.h1::after {
  content: '';
  position: absolute;
  right: -15px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 1.2em;
  background-color: #222;
  opacity: 0.9;
  box-shadow: 0 0 8px rgba(0, 123, 255, 0.7);
  animation: blink 1s step-end infinite;
  border-radius: 2px;
}

.title-container::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 150px;
  height: 4px;
  background: rgba(255, 255, 255, 0.5);
  border-radius: 3px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

@keyframes blink {
  0%, 50% {
    opacity: 1;
  }
  51%, 100% {
    opacity: 0;
  }
}

/* 管理员仪表板容器 */
.admin-container {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 30px;
}

/* 欢迎卡片 */
.welcome-card {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 30px;
  border-radius: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

.welcome-text h2 {
  color: #222;
  font-size: 2em;
  margin-bottom: 10px;
}

.welcome-text p {
  color: #666;
  font-size: 1.1em;
}

.admin-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  color: #333;
  font-size: 2em;
  font-weight: bold;
}

.admin-avatar .avatar-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

/* 仪表板网格 */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 25px;
}

/* 统计卡片 */
.stat-card {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 25px;
  border-radius: 15px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  transform: translateY(-5px);
  border-color: rgba(255, 255, 255, 0.5);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: rgba(255, 255, 255, 0.5);
}

.stat-card:nth-child(2)::before {
  background: rgba(255, 255, 255, 0.5);
}

.stat-card:nth-child(3)::before {
  background: rgba(255, 255, 255, 0.5);
}

.stat-card:nth-child(4)::before {
  background: rgba(255, 255, 255, 0.5);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* 统计分析 */
.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 25px;
  margin-top: 25px;
}

.analytics-card {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 25px;
  border-radius: 15px;
  transition: all 0.3s ease;
}

.analytics-card:hover {
  transform: translateY(-3px);
  border-color: rgba(255, 255, 255, 0.5);
}

.analytics-card.full-width {
  grid-column: 1 / -1;
}

.analytics-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.analytics-header h4 {
  margin: 0;
  font-size: 1.2em;
  color: rgba(255, 255, 255, 0.95);
}

.analytics-content {
  min-height: 200px;
}

.analytics-content table {
  width: 100%;
  border-collapse: collapse;
}

.analytics-content table th,
.analytics-content table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.analytics-content table th {
  color: rgba(255, 255, 255, 0.8);
  font-weight: 600;
  font-size: 0.9em;
}

.analytics-content table td {
  color: rgba(255, 255, 255, 0.9);
  font-size: 0.95em;
}

.analytics-content table tr:hover {
  background: rgba(255, 255, 255, 0.05);
}

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.stat-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  background: rgba(0, 123, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5em;
  color: #007bff;
}

.stat-card:nth-child(2) .stat-icon {
  background: rgba(0, 184, 148, 0.1);
  color: #00b894;
}

.stat-card:nth-child(3) .stat-icon {
  background: rgba(108, 92, 231, 0.1);
  color: #6c5ce7;
}

.stat-card:nth-child(4) .stat-icon {
  background: rgba(253, 126, 20, 0.1);
  color: #fd7e14;
}

.stat-title {
  font-size: 1.1em;
  color: #666;
  font-weight: 500;
}

.stat-value {
  font-size: 2.5em;
  font-weight: 700;
  color: #222;
  line-height: 1;
  margin-bottom: 10px;
}

.stat-change {
  display: flex;
  align-items: center;
  font-size: 0.9em;
}

.stat-change.positive {
  color: #00b894;
}

.stat-change.negative {
  color: #e74c3c;
}

.stat-change.neutral {
  color: #6c757d;
}

/* 管理面板 */
.admin-panel {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  overflow: hidden;
  margin-top: 20px;
}

.panel-header {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  padding: 20px 30px;
  color: #333;
}

.panel-header h2 {
  font-size: 1.8em;
  font-weight: 600;
}

/* 标签页导航 */
.tab-nav {
  display: flex;
  background: rgba(255, 255, 255, 0.9);
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  flex-wrap: wrap;
}

.tab-btn {
  padding: 18px 30px;
  background: transparent;
  border: none;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.tab-btn:hover {
  color: #007bff;
  background: rgba(0, 123, 255, 0.05);
}

.tab-btn.active {
  color: #007bff;
  font-weight: 600;
}

.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: rgba(255, 255, 255, 0.6);
}

/* 快速操作按钮 */
.quick-actions {
  display: flex;
  gap: 15px;
  padding: 10px 30px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.action-btn:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.action-btn.secondary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.action-btn.secondary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

/* 标签页内容 */
.tab-content {
  padding: 30px;
}

.tab-pane {
  display: none;
}

.tab-pane.active {
  display: block;
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 表格样式 */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.data-table th {
  text-align: left;
  padding: 15px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.data-table td {
  padding: 15px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.data-table tr:hover {
  background: rgba(255, 255, 255, 0.2);
}

.data-table .status {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.85em;
  font-weight: 500;
}

.status.published {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.status.draft {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.status.pending {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.status.scheduled {
  background: rgba(255, 193, 7, 0.2);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 193, 7, 0.4);
  color: rgba(255, 193, 7, 0.9);
  font-size: 0.85em;
  margin-left: 5px;
}

/* 可见性标签 */
.visibility {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: 500;
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
}

.visibility-public {
  background: rgba(0, 184, 148, 0.2);
  border: 1px solid rgba(0, 184, 148, 0.4);
  color: rgba(0, 184, 148, 0.9);
}

.visibility-private {
  background: rgba(253, 203, 110, 0.2);
  border: 1px solid rgba(253, 203, 110, 0.4);
  color: rgba(253, 203, 110, 0.9);
}

/* 操作按钮 */
.action-buttons {
  display: flex;
  gap: 8px;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-sm {
  padding: 5px 12px;
  font-size: 0.85em;
}

.btn-edit {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-edit:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-delete {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-delete:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-view {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-view:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-upload {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
}

.btn-upload:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

/* 按钮组 */
.btn-group {
  display: flex;
  gap: 15px;
  margin-top: 30px;
}

/* 分页组件 */
.pagination-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
}

.pagination-info {
  color: #333;
  font-size: 0.95em;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 10px;
}

.pagination-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pagination-btn:hover:not(:disabled) {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination-pages {
  display: flex;
  gap: 5px;
}

.pagination-page {
  min-width: 36px;
  height: 36px;
  padding: 0 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pagination-page:hover:not(.active):not(.ellipsis) {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.pagination-page.active {
  background: rgba(255, 255, 255, 0.35);
  border-color: rgba(255, 255, 255, 0.7);
  font-weight: 600;
}

.pagination-page.ellipsis {
  background: transparent;
  border: none;
  cursor: default;
  color: rgba(255, 255, 255, 0.9);
}

.btn-primary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-primary:disabled:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.3);
  transform: none;
}

.btn-danger {
  background: rgba(231, 76, 60, 0.2);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(231, 76, 60, 0.4);
  color: rgba(255, 255, 255, 0.95);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
}

.btn-danger:hover {
  background: rgba(231, 76, 60, 0.35);
  border-color: rgba(231, 76, 60, 0.6);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
}

.btn-danger:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
}

.btn-danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-danger:disabled:hover {
  background: rgba(231, 76, 60, 0.2);
  border-color: rgba(231, 76, 60, 0.4);
  transform: none;
  box-shadow: none;
}

.btn-secondary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-secondary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

/* 模态框样式 */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideIn 0.3s ease;
  position: relative;
}

.modal-content::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: linear-gradient(90deg, #007bff, #00b894);
  width: 0%;
  transition: width 3s linear;
}

.modal.active .modal-content::after {
  width: 100%;
}

@keyframes slideIn {
  from { transform: translateY(-50px) scale(0.9); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

@keyframes slideOutFade {
  from { transform: translateY(0) scale(1); opacity: 1; }
  to { transform: translateY(-50px) scale(0.9); opacity: 0; }
}

.modal.closing .modal-content {
  animation: slideOutFade 0.3s ease forwards;
}

.modal-header {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  padding: 20px 30px;
  color: rgba(255, 255, 255, 0.9);
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 1.5em;
  font-weight: 600;
}

.modal-close {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.5em;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: rotate(90deg);
}

.modal-body {
  padding: 30px;
}

/* 表单样式 */
.form-group {
  margin-bottom: 25px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  font-size: 1em;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(30px) saturate(200%);
  -webkit-backdrop-filter: blur(30px) saturate(200%);
  color: #333;
  transition: all 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: #007bff;
  background: rgba(255, 255, 255, 0.2);
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
}

textarea.form-control {
  min-height: 150px;
  resize: vertical;
}

/* 上传区域 */
.upload-area {
  border: 2px dashed rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
}

.upload-area:hover {
  border-color: rgba(255, 255, 255, 0.5);
  background: rgba(0, 0, 0, 0);
}

.upload-area.dragover {
  border-color: rgba(255, 255, 255, 0.7);
  background: rgba(255, 255, 255, 0.35);
}

.upload-icon {
  font-size: 3em;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 15px;
}

.upload-text h4 {
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 10px;
}

.upload-text p {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.95em;
}

.upload-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 20px;
}

.upload-item {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.upload-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.upload-remove {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 25px;
  height: 25px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  font-size: 0.8em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.upload-remove:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

/* 标签选择器 */
.tag-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.tag-option {
  padding: 8px 16px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  color: rgba(255, 255, 255, 0.9);
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.3s ease;
}

.tag-option:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
}

.tag-option.selected {
  background: rgba(255, 255, 255, 0.35);
  color: rgba(255, 255, 255, 0.9);
  border-color: rgba(255, 255, 255, 0.7);
}

.tag-input-container {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.tag-input {
  flex: 1;
}

/* 页脚 */
footer {
  text-align: center;
  padding: 30px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-top: 1px solid rgba(255, 255, 255, 0.3);
  margin-top: auto;
  position: relative;
  z-index: 1;
}

footer p {
  color: #666;
  font-size: 1.1em;
  margin-top: 10px;
}

/* 滚动指示器 */
.scroll-indicator {
  position: fixed;
  top: calc(env(safe-area-inset-top) + 70px);
  right: 20px;
  width: 4px;
  height: 60px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 2px;
  z-index: 99;
  overflow: hidden;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.scroll-indicator.active {
  opacity: 1;
}

.scroll-progress {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 0%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 2px;
  transition: height 0.1s ease;
}

/* 音乐拖拽上传区域样式 */
.music-drop-zone {
  border: 2px dashed rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 50px 30px;
  text-align: center;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
  position: relative;
}

.music-drop-zone:hover {
  border-color: rgba(255, 255, 255, 0.5);
  background: rgba(255, 255, 255, 0.05);
  transform: translateY(-2px);
}

.music-drop-zone.dragover {
  border-color: rgba(255, 255, 255, 0.7);
  background: rgba(255, 255, 255, 0.15);
  transform: scale(1.02);
}

.drop-zone-content {
  pointer-events: none;
}

.drop-zone-icon {
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

.music-drop-zone:hover .drop-zone-icon {
  transform: translateY(-5px);
}

.music-drop-zone h4 {
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.3em;
  margin-bottom: 10px;
  font-weight: 600;
}

.music-drop-zone p {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.95em;
  margin: 5px 0;
}

.browse-link {
  color: rgba(255, 255, 255, 0.9);
  text-decoration: underline;
  cursor: pointer;
  font-weight: 500;
}

.browse-link:hover {
  color: #fff;
}

.upload-hint {
  font-size: 0.85em;
  color: rgba(255, 255, 255, 0.5);
  margin-top: 15px;
}

.hidden-input {
  display: none;
}

/* 音乐上传列表样式 */
.music-upload-list {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
}

.upload-list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.05);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.upload-list-title {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
  font-size: 1.1em;
}

.clear-upload-btn {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 6px 16px;
  border-radius: 6px;
  font-size: 0.9em;
  cursor: pointer;
  transition: all 0.3s ease;
}

.clear-upload-btn:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-1px);
}

.upload-items {
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
}

.upload-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.upload-item:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.3);
}

.upload-item-icon {
  width: 50px;
  height: 50px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.5em;
}

.upload-item-info {
  flex: 1;
  min-width: 0;
}

.upload-item-name {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
  margin-bottom: 5px;
  word-break: break-all;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.upload-item-meta {
  display: flex;
  gap: 15px;
  font-size: 0.85em;
  color: rgba(255, 255, 255, 0.6);
}

.upload-item-progress {
  width: 150px;
  flex-shrink: 0;
}

.progress-bar {
  height: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 5px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.8));
  border-radius: 3px;
  transition: width 0.3s ease;
  width: 0%;
}

.progress-text {
  font-size: 0.8em;
  color: rgba(255, 255, 255, 0.7);
  text-align: right;
}

.upload-item-status {
  font-size: 0.85em;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: 500;
  flex-shrink: 0;
}

.upload-item-status.pending {
  background: rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.8);
}

.upload-item-status.uploading {
  background: rgba(0, 123, 255, 0.2);
  color: #007bff;
}

.upload-item-status.success {
  background: rgba(0, 184, 148, 0.2);
  color: #00b894;
}

.upload-item-status.error {
  background: rgba(231, 76, 60, 0.2);
  color: #e74c3c;
}

.upload-item-action {
  flex-shrink: 0;
}

.remove-upload-btn {
  width: 32px;
  height: 32px;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  color: rgba(255, 255, 255, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1.1em;
}

.remove-upload-btn:hover {
  background: rgba(231, 76, 60, 0.3);
  border-color: rgba(231, 76, 60, 0.5);
  color: #e74c3c;
}

.remove-upload-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.upload-actions {
  display: flex;
  gap: 15px;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.05);
  border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.upload-actions .btn-primary,
.upload-actions .btn-secondary {
  flex: 1;
}

/* 滚动条样式 */
.upload-items::-webkit-scrollbar {
  width: 6px;
}

.upload-items::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 3px;
}

.upload-items::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}

.upload-items::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* 音乐封面上传样式 */
.upload-item-cover {
  width: 60px;
  height: 60px;
  flex-shrink: 0;
  position: relative;
}

.cover-preview {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.1);
  border: 2px dashed rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  overflow: hidden;
  position: relative;
}

.cover-preview:hover {
  border-color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.15);
}

.cover-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
}

.cover-preview.has-cover {
  border-style: solid;
}

.cover-preview .cover-placeholder {
  color: rgba(255, 255, 255, 0.5);
  font-size: 1.5em;
}

.cover-preview .cover-upload-hint {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.8em;
  opacity: 0;
  transition: opacity 0.3s ease;
  border-radius: 6px;
  text-align: center;
  padding: 5px;
}

.cover-preview:hover .cover-upload-hint {
  opacity: 1;
}

.cover-input {
  display: none;
}

.cover-remove-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 20px;
  height: 20px;
  background: rgba(231, 76, 60, 0.9);
  border: 2px solid white;
  border-radius: 50%;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 10;
}

.cover-preview.has-cover:hover .cover-remove-btn {
  opacity: 1;
}

.cover-remove-btn:hover {
  background: rgba(231, 76, 60, 1);
  transform: scale(1.1);
}

/* 响应式设计 */
@media (max-width: 1024px) {
  .dashboard-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .modal-content {
    max-width: 90%;
  }
}

@media (max-width: 768px) {
  .h1 {
    font-size: 2.5em;
  }
  
  .welcome-card {
    flex-direction: column;
    text-align: center;
    gap: 20px;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .tab-nav, .quick-actions {
    flex-wrap: wrap;
  }
  
  .tab-btn {
    flex: 1;
    min-width: 120px;
    text-align: center;
    padding: 15px 10px;
  }
  
  .data-table {
    display: block;
    overflow-x: auto;
  }
  
  .action-buttons {
    flex-wrap: wrap;
  }
  
  nav {
    padding: 12px 15px;
  }
  
  nav a {
    margin: 0 10px;
    font-size: 0.95em;
  }
  
  .modal-content {
    max-width: 95%;
    margin: 10px;
  }
  
  .modal-body {
    padding: 20px;
  }
}

@media (max-width: 480px) {
  main {
    padding: 100px 15px 40px;
  }

  .tab-content {
    padding: 20px;
  }

  .btn-group, .tag-input-container {
    flex-direction: column;
  }

  .btn-primary, .btn-secondary {
    width: 100%;
  }
}

/* 设置相关样式 */
.settings-section {
  margin-bottom: 30px;
}

.settings-section h4 {
  font-size: 1.3em;
  color: #333;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.settings-grid .form-group {
  margin-bottom: 0;
}

input[type="range"].form-control {
  width: 100%;
  padding: 10px 0;
  background: transparent;
}

input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
}

input[type="range"]::-webkit-slider-thumb:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: scale(1.1);
}

input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 50%;
  cursor: pointer;
  border: none;
  transition: all 0.3s ease;
}

input[type="range"]::-moz-range-thumb:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: scale(1.1);
}

.settings-preview {
  margin-top: 30px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.settings-preview h5 {
  font-size: 1.1em;
  color: #333;
  margin-bottom: 15px;
}

.preview-box {
  min-height: 150px;
  padding: 30px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.1em;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.preview-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('/img/test.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  z-index: -1;
}

.preview-box p {
  position: relative;
  z-index: 1;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

/* Toast 通知样式 */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 400px;
  width: 100%;
}

.toast {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  display: flex;
  align-items: center;
  gap: 12px;
  animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
  min-width: 280px;
  max-width: 100%;
}

.toast.success {
  border-left: 4px solid #10b981;
}

.toast.error {
  border-left: 4px solid #ef4444;
}

.toast.warning {
  border-left: 4px solid #f59e0b;
}

.toast-icon {
  font-size: 24px;
  flex-shrink: 0;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast-message {
  flex: 1;
  color: #1f2937;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
}

.toast-close {
  background: none;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 18px;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
  flex-shrink: 0;
}

.toast-close:hover {
  color: #4b5563;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

@media (max-width: 768px) {
  .toast-container {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
  }

  .toast {
    padding: 14px 16px;
    min-width: auto;
  }

  .toast-message {
    font-size: 13px;
  }
}

/* 文件管理器样式 */
.fm-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.fm-header h3 {
  margin: 0;
  color: #333;
}

.fm-actions {
  display: flex;
  gap: 10px;
}

.fm-container {
  display: flex;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 15px;
  overflow: hidden;
  height: 600px;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.fm-sidebar {
  width: 280px;
  background: rgba(248, 249, 250, 0.95);
  border-right: 1px solid rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
}

.fm-sidebar-header {
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0.02);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  font-weight: 600;
  color: #333;
}

.fm-tree {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.fm-tree-item {
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
  color: #555;
  font-size: 0.95em;
}

.fm-tree-item:hover {
  background: rgba(0, 123, 255, 0.1);
  color: #007bff;
}

.fm-tree-item.active {
  background: rgba(0, 123, 255, 0.15);
  color: #007bff;
  font-weight: 500;
}

.fm-tree-item .fm-tree-icon {
  font-size: 1.1em;
}

.fm-tree-children {
  margin-left: 20px;
  display: none;
}

.fm-tree-children.expanded {
  display: block;
}

.fm-main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.fm-toolbar {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px 20px;
  background: rgba(0, 0, 0, 0.02);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.fm-tool-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 0, 0, 0.15);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 1.2em;
  color: #555;
}

.fm-tool-btn:hover:not(:disabled) {
  background: rgba(0, 123, 255, 0.1);
  border-color: rgba(0, 123, 255, 0.3);
  color: #007bff;
}

.fm-tool-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.fm-breadcrumb {
  flex: 1;
  font-size: 0.95em;
  color: #555;
  font-weight: 500;
}

.fm-info {
  font-size: 0.9em;
  color: #888;
}

.fm-file-list {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 15px;
  align-content: start;
}

.fm-file-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 15px 10px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.fm-file-item:hover {
  background: rgba(0, 123, 255, 0.05);
  border-color: rgba(0, 123, 255, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.fm-file-icon {
  font-size: 3em;
  margin-bottom: 8px;
}

.fm-file-icon img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
}

.fm-file-name {
  font-size: 0.9em;
  color: #333;
  text-align: center;
  word-break: break-all;
  line-height: 1.3;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.fm-file-meta {
  font-size: 0.8em;
  color: #888;
  margin-top: 5px;
}

.fm-empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #888;
}

.fm-empty-icon {
  font-size: 4em;
  margin-bottom: 15px;
  opacity: 0.5;
}

.fm-context-menu {
  position: fixed;
  background: rgba(255, 255, 255, 0.98);
  border: 1px solid rgba(0, 0, 0, 0.15);
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  min-width: 180px;
  display: none;
}

.fm-context-menu.active {
  display: block;
}

.fm-context-menu-item {
  padding: 10px 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.2s ease;
  color: #333;
  font-size: 0.95em;
}

.fm-context-menu-item:hover {
  background: rgba(0, 123, 255, 0.1);
  color: #007bff;
}

.fm-context-menu-item.danger {
  color: #e74c3c;
}

.fm-context-menu-item.danger:hover {
  background: rgba(231, 76, 60, 0.1);
}

.fm-context-menu-divider {
  height: 1px;
  background: rgba(0, 0, 0, 0.1);
  margin: 5px 0;
}

@media (max-width: 1024px) {
  .fm-container {
    flex-direction: column;
    height: auto;
  }
  
  .fm-sidebar {
    width: 100%;
    max-height: 200px;
  }
  
  .fm-main {
    min-height: 400px;
  }
}

/* 附件管理样式 */
.am-header {
  margin-bottom: 20px;
}

.am-header h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.am-header p {
  margin: 0;
  color: #666;
  font-size: 0.95em;
}

.am-filter-section {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.am-filter-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  align-items: end;
}

.am-filter-row .form-group {
  margin-bottom: 0;
}

.am-filter-row label {
  display: block;
  margin-bottom: 5px;
  font-size: 0.9em;
  font-weight: 500;
  color: #555;
}

.am-stats {
  display: flex;
  gap: 20px;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.am-stat-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95em;
}

.am-stat-label {
  color: #666;
}

.am-stat-value {
  font-weight: 600;
  color: #333;
}

.am-list-container {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
}

.am-list-container table {
  margin: 0;
  border-collapse: collapse;
  width: 100%;
}

.am-list-container thead {
  background: rgba(0, 123, 255, 0.1);
}

.am-list-container th {
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
  color: #333;
  font-size: 0.9em;
  border-bottom: 2px solid rgba(0, 123, 255, 0.2);
}

.am-list-container td {
  padding: 12px 15px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  vertical-align: middle;
}

.am-list-container tr:hover {
  background: rgba(0, 123, 255, 0.05);
}

.am-list-container tr.selected {
  background: rgba(0, 123, 255, 0.15);
}

.am-list-container input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.am-empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #888;
}

.am-empty-icon {
  font-size: 4em;
  margin-bottom: 15px;
  opacity: 0.5;
}

.am-empty-state p {
  font-size: 1.1em;
  margin-bottom: 20px;
}

.am-batch-actions {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px 20px;
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(0, 123, 255, 0.3);
  border-radius: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  animation: slideDown 0.3s ease;
}

.am-batch-actions strong {
  color: #007bff;
  font-size: 1.1em;
}

/* 上传模态框样式增强 */
.upload-area {
  border: 2px dashed rgba(0, 123, 255, 0.3);
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  background: rgba(0, 123, 255, 0.02);
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 20px;
}

.upload-area:hover {
  border-color: rgba(0, 123, 255, 0.6);
  background: rgba(0, 123, 255, 0.05);
}

.upload-area.dragover {
  border-color: rgba(0, 123, 255, 0.8);
  background: rgba(0, 123, 255, 0.1);
  transform: scale(1.02);
}

.upload-icon {
  font-size: 3em;
  color: #007bff;
  margin-bottom: 15px;
}

.upload-text h4 {
  color: #333;
  margin-bottom: 8px;
  font-size: 1.1em;
}

.upload-text p {
  color: #666;
  font-size: 0.9em;
}

.upload-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 20px;
  min-height: 0;
}

.upload-item {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 2px solid rgba(0, 123, 255, 0.2);
  transition: all 0.3s ease;
}

.upload-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  border-color: rgba(0, 123, 255, 0.4);
}

.upload-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.upload-remove {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 28px;
  height: 28px;
  background: rgba(231, 76, 60, 0.9);
  color: white;
  border-radius: 50%;
  font-size: 1.2em;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  border: 2px solid white;
  z-index: 10;
}

.upload-remove:hover {
  background: rgba(231, 76, 60, 1);
  transform: scale(1.1);
}

/* 响应式设计 */
@media (max-width: 768px) {
  .am-filter-row {
    grid-template-columns: 1fr;
  }

  .am-stats {
    flex-direction: column;
    gap: 10px;
  }

  .am-list-container {
    overflow-x: auto;
  }

  .am-list-container table {
    min-width: 800px;
  }

  .am-batch-actions {
    flex-direction: column;
    align-items: stretch;
  }

  .am-batch-actions button {
    width: 100%;
  }
}
</style>

<!-- 键盘快捷键样式 -->
<link rel="stylesheet" href="/css/keyboard-shortcuts.css">
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<nav id="mainNav">
  <a href="/">主页</a>
  <a href="/passage">文章</a>
  <a href="/collect">归档</a>
  <a href="/about">关于</a>
  <a href="/markdown-editor">编辑器<span class="shortcut-hint">6</span></a>
  <a class="navbtn current" href="/admin">管理员设置</a>
  <button id="loginBtn">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
      <polyline points="10 17 15 12 10 7"></polyline>
      <line x1="15" y1="12" x2="3" y2="12"></line>
    </svg>
    登录
  </button>
</nav>

<div class="scroll-indicator" id="scrollIndicator">
  <div class="scroll-progress" id="scrollProgress"></div>
</div>

<main>
  <div class="title-container">
    <h1 class="h1" id="main-title">管理员控制台</h1>
  </div>
  
  <div class="admin-container">
    <!-- 欢迎卡片 -->
    <div class="welcome-card">
      <div class="welcome-text">
        <h2>欢迎回来，管理员</h2>
      </div>
      <div class="admin-avatar">AD</div>
    </div>
    
    <!-- 统计卡片 -->
    <div class="dashboard-grid">
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-title">总文章数</div>
          <div class="stat-icon">📝</div>
        </div>
        <div class="stat-value" id="totalArticles">0</div>
        <div class="stat-change positive">本月新增</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-title">总用户数</div>
          <div class="stat-icon">👥</div>
        </div>
        <div class="stat-value" id="totalUsers">0</div>
        <div class="stat-change positive">本周新增</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-title">今日访问量</div>
          <div class="stat-icon">📊</div>
        </div>
        <div class="stat-value" id="todayVisits">0</div>
        <div class="stat-change">较昨日</div>
      </div>
    </div>
    
    <!-- 管理面板 -->
    <div class="admin-panel">
      <div class="panel-header">
        <h2>管理控制台</h2>
      </div>
      
      <!-- 快速操作按钮 -->
      <div class="quick-actions">
        <button class="action-btn" id="uploadArticleBtn">
          <span>📤</span> 上传文章
        </button>
        <button class="action-btn" id="newArticleBtn">
          <span>📝</span> 新建文章
        </button>
      </div>
      
      <!-- 标签页导航 -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="articles">文章管理</button>
        <button class="tab-btn" data-tab="users">用户管理</button>
        <button class="tab-btn" data-tab="comments">评论管理</button>
        <button class="tab-btn" data-tab="categories">分类管理</button>
        <button class="tab-btn" data-tab="tags">标签管理</button>
        <button class="tab-btn" data-tab="analytics">统计分析</button>
        <button class="tab-btn" data-tab="about">关于页面</button>
        <button class="tab-btn" data-tab="filemanager">文件管理</button>
        <button class="tab-btn" data-tab="attachments">附件管理</button>
        <button class="tab-btn" data-tab="settings">系统设置</button>
      </div>
      
      <!-- 标签页内容 -->
      <div class="tab-content">
        <!-- 文章管理 -->
        <div class="tab-pane active" id="articles">
          <h3>文章管理</h3>
          <p>管理已发布的文章，可以编辑、删除或更改状态。</p>

          <table class="data-table" id="articles">
            <thead>
              <tr>
                <th>ID</th>
                <th>标题</th>
                <th>作者</th>
                <th>日期</th>
                <th>状态</th>
                <th>可见性</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="articlesTableBody">
              <!-- 数据将通过JavaScript动态加载 -->
            </tbody>
          </table>

          <!-- 分页组件 -->
          <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="paginationInfo">显示 1-10 条，共 0 条</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                上一页
              </button>
              <div class="pagination-pages" id="paginationPages">
                <!-- 页码按钮将通过JavaScript动态生成 -->
              </div>
              <button class="pagination-btn" id="nextPageBtn" disabled>
                下一页
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-secondary">导出数据</button>
            <button class="btn-primary" id="refreshArticlesBtn">刷新列表</button>
          </div>
        </div>
        
        <!-- 用户管理 -->
        <div class="tab-pane" id="users">
          <h3>用户管理</h3>
          <p>管理注册用户，可以查看用户信息、调整权限或删除用户。</p>

          <table class="data-table" id="users">
            <thead>
              <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>邮箱</th>
                <th>注册时间</th>
                <th>角色</th>
                <th>状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- 数据将通过JavaScript动态加载 -->
            </tbody>
          </table>

          <!-- 用户分页组件 -->
          <div class="pagination-container" id="userPaginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="userPaginationInfo">显示 1-10 条，共 0 条</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevUserPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                上一页
              </button>
              <div class="pagination-pages" id="userPaginationPages">
                <!-- 页码按钮将通过JavaScript动态生成 -->
              </div>
              <button class="pagination-btn" id="nextUserPageBtn" disabled>
                下一页
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-secondary">导出用户列表</button>
            <button class="btn-primary" id="addUserBtn">添加新用户</button>
          </div>
        </div>
        
        <!-- 评论管理 -->
        <div class="tab-pane" id="comments">
          <h3>评论管理</h3>
          <p>管理文章评论，可以审核、编辑或删除评论。</p>

          <table class="data-table" id="comments">
            <thead>
              <tr>
                <th>ID</th>
                <th>内容</th>
                <th>文章</th>
                <th>用户</th>
                <th>时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="commentsTableBody">
              <!-- 数据将通过JavaScript动态加载 -->
            </tbody>
          </table>

          <!-- 评论分页组件 -->
          <div class="pagination-container" id="commentsPaginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="commentsPaginationInfo">显示 1-10 条，共 0 条</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="prevCommentsPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                上一页
              </button>
              <div class="pagination-pages" id="commentsPaginationPages">
                <!-- 页码按钮将通过JavaScript动态生成 -->
              </div>
              <button class="pagination-btn" id="nextCommentsPageBtn" disabled>
                下一页
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-secondary">批量审核</button>
            <button class="btn-primary" id="refreshCommentsBtn">刷新评论</button>
          </div>
        </div>

        <!-- 分类管理 -->
        <div class="tab-pane" id="categories">
          <h3>分类管理</h3>
          <p>管理文章分类，可以创建、编辑、删除分类。</p>

          <div class="quick-actions">
            <button class="btn-primary" id="addCategoryBtn">添加分类</button>
            <button class="btn-secondary" id="refreshCategoriesBtn">刷新</button>
          </div>

          <table class="data-table" id="categories">
            <thead>
              <tr>
                <th>排序</th>
                <th>图标</th>
                <th>名称</th>
                <th>描述</th>
                <th>状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="categoriesTableBody">
              <!-- 数据将通过JavaScript动态加载 -->
            </tbody>
          </table>
        </div>

        <!-- 标签管理 -->
        <div class="tab-pane" id="tags">
          <h3>标签管理</h3>
          <p>管理文章标签，可以创建、编辑、删除标签。</p>

          <div class="quick-actions">
            <button class="btn-primary" id="addTagBtn">添加标签</button>
            <button class="btn-secondary" id="refreshTagsBtn">刷新</button>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <label for="tagCategoryFilter">筛选分类</label>
            <select id="tagCategoryFilter" class="form-control">
              <option value="">全部标签</option>
            </select>
          </div>

          <table class="data-table" id="tags" style="margin-top: 15px;">
            <thead>
              <tr>
                <th>排序</th>
                <th>颜色</th>
                <th>名称</th>
                <th>描述</th>
                <th>所属分类</th>
                <th>状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tagsTableBody">
              <!-- 数据将通过JavaScript动态加载 -->
            </tbody>
          </table>
        </div>

        <!-- 关于页面 -->
        <div class="tab-pane" id="about">
          <h3>关于页面管理</h3>
          <p>管理关于页面的主卡片和次卡片内容。</p>

          <div class="quick-actions">
            <button class="btn-primary" id="addMainCardBtn">添加主卡片</button>
            <button class="btn-secondary" id="refreshAboutCardsBtn">刷新</button>
          </div>

          <!-- 主卡片列表 -->
          <div style="margin-top: 30px;">
            <h4>主卡片列表</h4>
            <table class="data-table" id="mainCards">
              <thead>
                <tr>
                  <th>排序</th>
                  <th>图标</th>
                  <th>标题</th>
                  <th>布局类型</th>
                  <th>次卡片数</th>
                  <th>状态</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="mainCardsTableBody">
                <!-- 数据将通过JavaScript动态加载 -->
              </tbody>
            </table>
          </div>

          <!-- 次卡片列表 -->
          <div style="margin-top: 30px;">
            <h4>次卡片列表</h4>
            <div class="form-group">
              <label for="subCardMainCardFilter">选择主卡片</label>
              <select id="subCardMainCardFilter" class="form-control">
                <option value="">全部主卡片</option>
              </select>
            </div>
            <button class="btn-primary" id="addSubCardBtn" style="margin-top: 10px;">添加次卡片</button>
            <table class="data-table" id="subCards" style="margin-top: 15px;">
              <thead>
                <tr>
                  <th>排序</th>
                  <th>图标</th>
                  <th>标题</th>
                  <th>描述</th>
                  <th>链接</th>
                  <th>状态</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="subCardsTableBody">
                <!-- 数据将通过JavaScript动态加载 -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- 文件管理 -->
        <div class="tab-pane" id="filemanager">
          <div class="fm-header">
            <h3>文件管理</h3>
            <div class="fm-actions">
              <button class="btn-primary" id="fmUploadBtn">
                <span style="margin-right: 5px;">↑</span>上传文件
              </button>
              <button class="btn-secondary" id="fmCreateDirBtn">
                <span style="margin-right: 5px;">+</span>新建文件夹
              </button>
            </div>
          </div>

          <div class="fm-container">
            <!-- 左侧目录树 -->
            <div class="fm-sidebar">
              <div class="fm-sidebar-header">
                <span>目录结构</span>
              </div>
              <div class="fm-tree" id="fmTree">
                <!-- 目录树将通过 JavaScript 动态生成 -->
              </div>
            </div>

            <!-- 右侧文件列表 -->
            <div class="fm-main">
              <div class="fm-toolbar">
                <button class="fm-tool-btn" id="fmBackBtn" disabled>
                  <span>←</span>
                </button>
                <div class="fm-breadcrumb" id="fmBreadcrumb">img</div>
                <div class="fm-info" id="fmInfo">0 个项目</div>
              </div>

              <div class="fm-file-list" id="fmFileList">
                <!-- 文件列表将通过 JavaScript 动态生成 -->
              </div>

              <div class="fm-empty-state" id="fmEmptyState" style="display: none;">
                <div class="fm-empty-icon">📭</div>
                <p>此文件夹为空</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 统计分析 -->
        <div class="tab-pane" id="analytics">
          <h3>📊 统计分析</h3>
          <p>查看文章阅读统计、热门分析和访问来源数据。</p>

          <!-- 统计图表区域 -->
          <div class="analytics-grid">
            <!-- 热门文章 -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h4>🔥 热门文章</h4>
                <select id="mostViewedLimit" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="5">前5篇</option>
                  <option value="10" selected>前10篇</option>
                  <option value="20">前20篇</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="mostViewedTable">
                  <thead>
                    <tr>
                      <th>排名</th>
                      <th>文章标题</th>
                      <th>作者</th>
                      <th>阅读次数</th>
                    </tr>
                  </thead>
                  <tbody id="mostViewedTableBody">
                    <tr><td colspan="4" style="text-align: center;">加载中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 访问来源 -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h4>🌍 访问来源（按国家）</h4>
                <select id="viewSourcesDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">近7天</option>
                  <option value="30" selected>近30天</option>
                  <option value="90">近90天</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="viewSourcesTable">
                  <thead>
                    <tr>
                      <th>排名</th>
                      <th>国家/地区</th>
                      <th>访问次数</th>
                    </tr>
                  </thead>
                  <tbody id="viewSourcesTableBody">
                    <tr><td colspan="3" style="text-align: center;">加载中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 访问来源（按城市） -->
            <div class="analytics-card">
              <div class="analytics-header">
                <h4>🏙️ 访问来源（按城市）</h4>
                <select id="viewByCityDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">近7天</option>
                  <option value="30" selected>近30天</option>
                  <option value="90">近90天</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="viewByCityTable">
                  <thead>
                    <tr>
                      <th>排名</th>
                      <th>城市</th>
                      <th>地区</th>
                      <th>访问次数</th>
                    </tr>
                  </thead>
                  <tbody id="viewByCityTableBody">
                    <tr><td colspan="4" style="text-align: center;">加载中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 访问来源（按IP） -->
            <div class="analytics-card full-width">
              <div class="analytics-header">
                <h4>🖥️ 访问来源（按IP）</h4>
                <select id="viewByIPDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">近7天</option>
                  <option value="30" selected>近30天</option>
                  <option value="90">近90天</option>
                </select>
              </div>
              <div class="analytics-content">
                <table class="data-table" id="viewByIPTable">
                  <thead>
                    <tr>
                      <th>排名</th>
                      <th>IP地址</th>
                      <th>国家</th>
                      <th>城市</th>
                      <th>地区</th>
                      <th>访问次数</th>
                      <th>首次访问</th>
                      <th>最后访问</th>
                    </tr>
                  </thead>
                  <tbody id="viewByIPTableBody">
                    <tr><td colspan="8" style="text-align: center;">加载中...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 阅读趋势 -->
            <div class="analytics-card full-width">
              <div class="analytics-header">
                <h4>📈 阅读趋势</h4>
                <select id="viewTrendDays" class="form-control" style="width: 100px; padding: 5px;">
                  <option value="7">近7天</option>
                  <option value="30" selected>近30天</option>
                  <option value="90">近90天</option>
                </select>
              </div>
              <div class="analytics-content">
                <canvas id="viewTrendChart" style="width: 100%; height: 300px;"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- 附件管理 -->
        <div class="tab-pane" id="attachments">
          <div class="am-header">
            <h3>📎 附件管理</h3>
            <p>管理所有上传的附件，支持上传、查看、下载、删除和权限设置。</p>
          </div>

          <!-- 操作栏 -->
          <div class="quick-actions">
            <button class="btn-primary" id="amUploadBtn">
              <span style="margin-right: 5px;">📤</span>上传附件
            </button>
            <button class="btn-secondary" id="amRefreshBtn">
              <span style="margin-right: 5px;">🔄</span>刷新列表
            </button>
          </div>

          <!-- 筛选区域 -->
          <div class="am-filter-section">
            <div class="am-filter-row">
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amFileTypeFilter">文件类型</label>
                <select id="amFileTypeFilter" class="form-control">
                  <option value="">全部类型</option>
                  <option value="image">图片</option>
                  <option value="document">文档</option>
                  <option value="video">视频</option>
                  <option value="audio">音频</option>
                  <option value="archive">压缩包</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amVisibilityFilter">可见性</label>
                <select id="amVisibilityFilter" class="form-control">
                  <option value="">全部</option>
                  <option value="public">公开</option>
                  <option value="private">私密</option>
                  <option value="protected">受保护</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amPassageFilter">关联文章</label>
                <select id="amPassageFilter" class="form-control">
                  <option value="">全部文章</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label for="amSearchInput">搜索</label>
                <input type="text" id="amSearchInput" class="form-control" placeholder="搜索文件名...">
              </div>
            </div>
          </div>

          <!-- 统计信息 -->
          <div class="am-stats">
            <div class="am-stat-item">
              <span class="am-stat-label">总附件数:</span>
              <span class="am-stat-value" id="amTotalCount">0</span>
            </div>
            <div class="am-stat-item">
              <span class="am-stat-label">总大小:</span>
              <span class="am-stat-value" id="amTotalSize">0 KB</span>
            </div>
            <div class="am-stat-item">
              <span class="am-stat-label">图片:</span>
              <span class="am-stat-value" id="amImageCount">0</span>
            </div>
            <div class="am-stat-item">
              <span class="am-stat-label">文档:</span>
              <span class="am-stat-value" id="amDocumentCount">0</span>
            </div>
          </div>

          <!-- 附件列表 -->
          <div class="am-list-container">
            <table class="data-table" id="attachmentsTable">
              <thead>
                <tr>
                  <th width="40">
                    <input type="checkbox" id="amSelectAll">
                  </th>
                  <th width="60">预览</th>
                  <th>文件名</th>
                  <th>类型</th>
                  <th>大小</th>
                  <th>可见性</th>
                  <th>关联文章</th>
                  <th>上传时间</th>
                  <th width="150">操作</th>
                </tr>
              </thead>
              <tbody id="attachmentsTableBody">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 40px;">
                    <div class="am-empty-state">
                      <div class="am-empty-icon">📭</div>
                      <p>暂无附件</p>
                      <button class="btn-primary" id="amEmptyUploadBtn" style="margin-top: 15px;">
                        上传第一个附件
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 分页组件 -->
          <div class="pagination-container" id="amPaginationContainer" style="display: none;">
            <div class="pagination-info">
              <span id="amPaginationInfo">显示 1-10 条，共 0 条</span>
            </div>
            <div class="pagination-controls">
              <button class="pagination-btn" id="amPrevPageBtn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                上一页
              </button>
              <div class="pagination-pages" id="amPaginationPages">
                <!-- 页码按钮将通过JavaScript动态生成 -->
              </div>
              <button class="pagination-btn" id="amNextPageBtn" disabled>
                下一页
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
            </div>
          </div>

          <!-- 批量操作 -->
          <div class="am-batch-actions" id="amBatchActions" style="display: none;">
            <span style="margin-right: 15px;">已选择 <strong id="amSelectedCount">0</strong> 项</span>
            <button class="btn-danger" id="amBatchDeleteBtn">
              <span style="margin-right: 5px;">🗑️</span>批量删除
            </button>
            <button class="btn-secondary" id="amBatchSetPublicBtn">
              设为公开
            </button>
            <button class="btn-secondary" id="amBatchSetPrivateBtn">
              设为私密
            </button>
            <button class="btn-secondary" id="amCancelSelectionBtn">
              取消选择
            </button>
          </div>
        </div>

        <!-- 系统设置 -->
        <div class="tab-pane" id="settings">
          <h3>系统设置</h3>
          <p>配置网站参数和功能设置。</p>

          <!-- 外观设置 -->
          <div class="settings-section">
            <h4>🎨 外观设置</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="backgroundImage">背景图片路径</label>
                <input type="text" id="backgroundImage" class="form-control" placeholder="/img/test.png">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">支持相对路径或绝对URL</p>
              </div>

              <div class="form-group">
                <label for="globalOpacity">全局透明度 (0-1)</label>
                <input type="range" id="globalOpacity" class="form-control" min="0" max="1" step="0.05" value="0.15">
                <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85em; color: #666;">
                  <span>0 (不透明)</span>
                  <span id="opacityValue">0.15</span>
                  <span>1 (完全透明)</span>
                </div>
              </div>

              <div class="form-group">
                <label for="backgroundSize">背景尺寸</label>
                <select id="backgroundSize" class="form-control">
                  <option value="cover">cover (覆盖)</option>
                  <option value="contain">contain (包含)</option>
                  <option value="auto">auto (自动)</option>
                  <option value="100% 100%">100% 100% (拉伸)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="backgroundPosition">背景位置</label>
                <select id="backgroundPosition" class="form-control">
                  <option value="center">center (居中)</option>
                  <option value="top">top (顶部)</option>
                  <option value="bottom">bottom (底部)</option>
                  <option value="left">left (左侧)</option>
                  <option value="right">right (右侧)</option>
                  <option value="top left">top left (左上)</option>
                  <option value="top right">top right (右上)</option>
                  <option value="bottom left">bottom left (左下)</option>
                  <option value="bottom right">bottom right (右下)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="backgroundRepeat">背景重复</label>
                <select id="backgroundRepeat" class="form-control">
                  <option value="no-repeat">no-repeat (不重复)</option>
                  <option value="repeat">repeat (重复)</option>
                  <option value="repeat-x">repeat-x (水平重复)</option>
                  <option value="repeat-y">repeat-y (垂直重复)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="backgroundAttachment">背景滚动</label>
                <select id="backgroundAttachment" class="form-control">
                  <option value="fixed">fixed (固定)</option>
                  <option value="scroll">scroll (滚动)</option>
                  <option value="local">local (本地)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="blurAmount">背景模糊程度</label>
                <input type="text" id="blurAmount" class="form-control" placeholder="20px">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">例如: 0px, 10px, 20px</p>
              </div>

              <div class="form-group">
                <label for="saturateAmount">背景饱和度</label>
                <input type="text" id="saturateAmount" class="form-control" placeholder="180%">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">例如: 100%, 150%, 200%</p>
              </div>
            </div>

            <!-- 预览区域 -->
            <div class="settings-preview">
              <h5>效果预览</h5>
              <div id="previewBox" class="preview-box">
                <p>这是预览效果区域</p>
              </div>
            </div>

            <!-- 暗色模式 -->
            <div class="form-group">
              <label for="darkModeEnabled">
                <input type="checkbox" id="darkModeEnabled" style="margin-right: 8px;">
                启用暗色模式
              </label>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">为整个网站启用暗色主题，减少眼部疲劳</p>
            </div>

            <!-- 毛玻璃颜色设置 -->
            <div class="form-group">
              <label for="navbarGlassColor">导航栏毛玻璃颜色</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="navbarGlassColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="navbarGlassColor" class="form-control" placeholder="rgba(255, 255, 255, 0.85)">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">导航栏背景毛玻璃效果颜色（支持 rgba 格式）</p>
            </div>

            <div class="form-group">
              <label for="navbarTextColor">导航栏文字颜色</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="navbarTextColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="navbarTextColor" class="form-control" placeholder="#333333">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">导航栏文字颜色（支持 hex、rgb 格式）</p>
            </div>

            <div class="form-group">
              <label for="cardGlassColor">页面卡片毛玻璃颜色</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="cardGlassColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="cardGlassColor" class="form-control" placeholder="rgba(255, 255, 255, 0.75)">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">页面卡片背景毛玻璃效果颜色（支持 rgba 格式）</p>
            </div>

            <div class="form-group">
              <label for="footerGlassColor">底栏毛玻璃颜色</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="color" id="footerGlassColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="footerGlassColor" class="form-control" placeholder="rgba(255, 255, 255, 0.9)">
              </div>
              <p style="font-size: 0.85em; color: #666; margin-top: 5px;">底栏背景毛玻璃效果颜色（支持 rgba 格式）</p>
            </div>
          </div>

          <!-- 音乐设置 -->
          <div class="settings-section">
            <h4>🎵 音乐设置</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="musicEnabled">
                  <input type="checkbox" id="musicEnabled" style="margin-right: 8px;">
                  启用音乐播放器
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">在页面显示音乐播放器控件</p>
              </div>

              <div class="form-group">
                <label for="musicAutoPlay">
                  <input type="checkbox" id="musicAutoPlay" style="margin-right: 8px;">
                  自动播放
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">页面加载时自动播放音乐</p>
              </div>

              <div class="form-group">
                <label for="musicControlSize">控件大小</label>
                <select id="musicControlSize" class="form-control">
                  <option value="small">小</option>
                  <option value="medium">中</option>
                  <option value="large">大</option>
                </select>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">音乐播放器控件的大小</p>
              </div>

              <div class="form-group">
                <label for="musicPlayerColor">播放器颜色</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="color" id="musicPlayerColorPicker" class="color-picker" style="width: 50px; height: 40px; border: none; cursor: pointer;">
                  <input type="text" id="musicPlayerColor" class="form-control" placeholder="rgba(66, 133, 244, 0.9)">
                </div>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">音乐播放器颜色（支持 rgba 格式）</p>
              </div>

              <div class="form-group">
                <label for="musicPosition">显示位置</label>
                <select id="musicPosition" class="form-control">
                  <option value="top-left">左上角</option>
                  <option value="top-right">右上角</option>
                  <option value="bottom-left">左下角</option>
                  <option value="bottom-right">右下角</option>
                </select>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">音乐播放器在页面中的显示位置</p>
              </div>

              <div class="form-group">
                <label for="musicCustomCSS">自定义 CSS 样式</label>
                <textarea id="musicCustomCSS" class="form-control" rows="4" placeholder="/* 自定义音乐播放器样式 */"></textarea>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">为音乐播放器添加自定义 CSS 样式</p>
              </div>
            </div>

            <!-- 音乐文件管理 -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0, 0, 0, 0.1);">
              <h5>📁 音乐文件管理</h5>

              <!-- 拖拽上传区域 -->
              <div id="musicDropZone" class="music-drop-zone">
                <div class="drop-zone-content">
                  <div class="drop-zone-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="17 8 12 3 7 8"></polyline>
                      <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                  </div>
                  <h4>拖拽音频文件到此处上传</h4>
                  <p>或者 <span class="browse-link">点击选择文件</span></p>
                  <p class="upload-hint">支持 MP3、WAV、OGG、M4A 等音频格式，支持批量上传</p>
                </div>
                <input type="file" id="musicFileUpload" accept="audio/*" multiple class="hidden-input">
              </div>

              <!-- 上传文件列表 -->
              <div id="musicUploadList" class="music-upload-list" style="display: none;">
                <div class="upload-list-header">
                  <div class="upload-list-title">上传队列</div>
                  <button class="clear-upload-btn" id="clearUploadBtn">清空列表</button>
                </div>
                <div id="musicUploadItems" class="upload-items"></div>
                <div class="upload-actions">
                  <button class="btn-primary" id="uploadAllMusicBtn">开始上传</button>
                  <button class="btn-secondary" id="cancelUploadBtn">取消上传</button>
                </div>
              </div>

              <!-- 封面上传提示 -->
              <div style="margin-top: 15px; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.15);">
                <p style="font-size: 0.9em; color: rgba(255, 255, 255, 0.8); margin: 0;">
                  💡 <strong>提示：</strong>可以在上传队列中为每个音乐文件单独添加封面图片（支持 JPG、PNG、GIF、WebP 格式）
                </p>
              </div>

              <!-- 音乐播放列表 -->
              <div style="margin-top: 20px;">
                <h5>🎼 播放列表</h5>
                <div id="musicPlaylistContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 8px; padding: 10px;">
                  <div style="text-align: center; color: #999; padding: 20px;">暂无音乐文件</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 模板设置 -->
          <div class="settings-section">
            <h4>📝 模板设置</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="templateName">个人主页标题</label>
                <input type="text" id="templateName" class="form-control" placeholder="欢迎来到我的博客">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">显示在首页的标题文字</p>
              </div>

              <div class="form-group">
                <label for="templateGreting">欢迎语</label>
                <textarea id="templateGreting" class="form-control" rows="3" placeholder="这是一个使用 Go 语言构建的个人博客系统..."></textarea>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">显示在首页的欢迎文字</p>
              </div>

              <div class="form-group">
                <label for="templateYear">年份</label>
                <input type="text" id="templateYear" class="form-control" placeholder="2026">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">用于版权信息</p>
              </div>

              <div class="form-group">
                <label for="templateFoodes">页脚信息</label>
                <input type="text" id="templateFoodes" class="form-control" placeholder="我的博客">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">显示在页脚的信息</p>
              </div>

              <div class="form-group">
                <label for="globalAvatar">全局头像路径</label>
                <input type="text" id="globalAvatar" class="form-control" placeholder="/img/avatar.png">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">全局用户头像图片路径（支持相对路径或绝对URL）</p>
              </div>
            </div>
          </div>

          <!-- 文章标题设置 -->
          <div class="settings-section">
            <h4>📄 文章标题设置</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="templateArticleTitle">
                  <input type="checkbox" id="templateArticleTitle" style="margin-right: 8px;">
                  显示文章标题
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">是否在文章页面显示标题</p>
              </div>

              <div class="form-group">
                <label for="templateArticleTitlePrefix">文章标题前缀</label>
                <input type="text" id="templateArticleTitlePrefix" class="form-control" placeholder="文章">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">显示在文章标题前的文字（如：文章、阅读等）</p>
              </div>
            </div>
          </div>

          <!-- 切换界面提示设置 -->
          <div class="settings-section">
            <h4>💡 切换界面提示设置</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="templateSwitchNotice">
                  <input type="checkbox" id="templateSwitchNotice" style="margin-right: 8px;">
                  显示切换标签页提示
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">用户切换到其他标签页时，在标签页标题显示提示文字</p>
              </div>

              <div class="form-group">
                <label for="templateSwitchNoticeText">提示文字</label>
                <input type="text" id="templateSwitchNoticeText" class="form-control" placeholder="回来继续阅读">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">切换标签页时在标题栏显示的文字（如：回来继续阅读、别忘记回来哦等）</p>
              </div>
            </div>
          </div>

          <!-- 外部链接设置 -->
          <div class="settings-section">
            <h4>🔗 外部链接设置</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="externalLinkWarning">
                  <input type="checkbox" id="externalLinkWarning" style="margin-right: 8px;">
                  启用外部链接跳转警告
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">用户点击外部链接时，显示警告提示</p>
              </div>

              <div class="form-group">
                <label for="externalLinkWhitelist">白名单域名</label>
                <input type="text" id="externalLinkWhitelist" class="form-control" placeholder="github.com,gitee.com,stackoverflow.com">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">不需要警告的域名，用逗号分隔（如：github.com,gitee.com）</p>
              </div>

              <div class="form-group">
                <label for="externalLinkWarningText">警告提示文字</label>
                <input type="text" id="externalLinkWarningText" class="form-control" placeholder="您即将离开本站，前往外部链接">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">外部链接警告提示文字</p>
              </div>

              <div class="form-group">
                <label for="live2dEnabled">
                  <input type="checkbox" id="live2dEnabled" style="margin-right: 8px;">
                  启用 Live2D 看板娘
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">在页面显示 Live2D 看板娘</p>
              </div>
            </div>
          </div>

          <!-- Live2D 详细配置 -->
          <div id="live2dConfig" class="settings-section" style="display: none;">
            <div class="settings-grid">
              <div class="form-group">
                <label>显示页面</label>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 5px;">
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnIndex" style="margin-right: 6px;">
                    首页
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnPassage" style="margin-right: 6px;">
                    文章页
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnCollect" style="margin-right: 6px;">
                    归档页
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnAbout" style="margin-right: 6px;">
                    关于页
                  </label>
                  <label style="display: flex; align-items: center;">
                    <input type="checkbox" id="live2dShowOnAdmin" style="margin-right: 6px;">
                    管理页
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label for="live2dPosition">显示位置</label>
                <select id="live2dPosition" class="form-control">
                  <option value="right">右下角</option>
                  <option value="left">左下角</option>
                </select>
              </div>

              <div class="form-group">
                <label for="live2dModelId">模型 ID</label>
                <input type="text" id="live2dModelId" class="form-control" placeholder="1">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">CDN 模型的 ID（如：1, 2, 3 等）</p>
              </div>

              <div class="form-group">
                <label for="live2dModelPath">自定义模型路径</label>
                <input type="text" id="live2dModelPath" class="form-control" placeholder="/live2d/model/">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">留空则使用 CDN 模型。填写时使用相对路径（如：/live2d/model/）</p>
              </div>

              <div class="form-group">
                <label for="live2dCDNPath">CDN 路径</label>
                <input type="text" id="live2dCDNPath" class="form-control" placeholder="https://unpkg.com/live2d-widget-model@1.0.5/">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">CDN 模型的基础路径</p>
              </div>

              <div class="form-group">
                <label for="live2dWidth">宽度</label>
                <input type="text" id="live2dWidth" class="form-control" placeholder="280px">
              </div>

              <div class="form-group">
                <label for="live2dHeight">高度</label>
                <input type="text" id="live2dHeight" class="form-control" placeholder="250px">
              </div>
            </div>
          </div>

          <!-- 赞助设置 -->
          <div class="settings-section">
            <h4>💰 赞助设置</h4>
            <div class="settings-grid">
              <div class="form-group">
                <label for="sponsorEnabled">
                  <input type="checkbox" id="sponsorEnabled" style="margin-right: 8px;">
                  启用赞助功能
                </label>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">在文章末尾显示赞助按钮</p>
              </div>

              <div class="form-group">
                <label for="sponsorTitle">赞助标题</label>
                <input type="text" id="sponsorTitle" class="form-control" placeholder="感谢您的支持">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">赞助模态框的标题</p>
              </div>

              <div class="form-group">
                <label for="sponsorImage">赞助图片路径</label>
                <input type="text" id="sponsorImage" class="form-control" placeholder="/img/avatar.png">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">赞助二维码图片的路径</p>
              </div>

              <div class="form-group">
                <label for="sponsorDescription">赞助描述</label>
                <textarea id="sponsorDescription" class="form-control" rows="3" placeholder="如果您觉得这个博客对您有帮助，欢迎赞助支持！"></textarea>
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">赞助说明文字</p>
              </div>

              <div class="form-group">
                <label for="sponsorButtonText">赞助按钮文字</label>
                <input type="text" id="sponsorButtonText" class="form-control" placeholder="❤️ 赞助支持">
                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">显示在文章中的赞助按钮文字</p>
              </div>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn-secondary" id="resetSettingsBtn">重置为默认</button>
            <button class="btn-primary" id="saveMusicSettingsBtn">保存音乐设置</button>
            <button class="btn-primary" id="saveSettingsBtn">保存外观设置</button>
            <button class="btn-primary" id="saveTemplateSettingsBtn">保存模板设置</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- 上传文章模态框 -->
<div class="modal" id="uploadModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>上传文章</h3>
      <button class="modal-close" data-modal="uploadModal">×</button>
    </div>
    <div class="modal-body">
      <form id="uploadForm">
        <div class="form-group">
          <label for="uploadTitle">文章标题</label>
          <input type="text" id="uploadTitle" class="form-control" placeholder="请输入文章标题" required>
        </div>
        
        <div class="form-group">
          <label for="uploadAuthor">作者</label>
          <input type="text" id="uploadAuthor" class="form-control" value="管理员">
        </div>
        
        <div class="form-group">
          <label>发布日期（仅对Markdown文件有效）</label>
          <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
              <input type="number" id="uploadYear" class="form-control" placeholder="年" min="2020" max="2030">
            </div>
            <div style="flex: 1;">
              <input type="number" id="uploadMonth" class="form-control" placeholder="月" min="1" max="12">
            </div>
            <div style="flex: 1;">
              <input type="number" id="uploadDay" class="form-control" placeholder="日" min="1" max="31">
            </div>
          </div>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">留空则使用当前日期</p>
        </div>
        
        <div class="form-group">
          <label for="uploadCategory">分类</label>
          <select id="uploadCategory" class="form-control">
            <option value="frontend">前端开发</option>
            <option value="backend">后端开发</option>
            <option value="design">设计</option>
            <option value="ai">人工智能</option>
            <option value="tools">工具推荐</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>标签</label>
          <div class="tag-selector" id="uploadTagSelector">
            <!-- 标签将通过JavaScript动态加载 -->
          </div>
          <div class="tag-input-container">
            <input type="text" class="form-control tag-input" id="uploadTagInput" placeholder="添加自定义标签">
            <button type="button" class="btn-secondary" id="addUploadTagBtn">添加</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="uploadContent">文章内容</label>
          <textarea id="uploadContent" class="form-control" placeholder="请输入文章内容（支持Markdown格式）" rows="10"></textarea>
        </div>
        
        <div class="form-group">
          <label>上传附件</label>
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📁</div>
            <div class="upload-text">
              <h4>点击或拖拽文件到此处</h4>
              <p>支持图片、文档、压缩包等文件格式，单个文件最大10MB</p>
            </div>
            <input type="file" id="fileInput" multiple style="display: none;">
          </div>
          <div class="upload-preview" id="uploadPreview"></div>
        </div>
        
        <div class="form-group">
          <label for="uploadStatus">发布状态</label>
          <select id="uploadStatus" class="form-control">
            <option value="draft">草稿</option>
            <option value="pending">待审核</option>
            <option value="published">立即发布</option>
          </select>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="uploadModal">取消</button>
          <button type="submit" class="btn-primary">上传文章</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 新建文章模态框 -->
<div class="modal" id="articleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>新建文章</h3>
      <button class="modal-close" data-modal="articleModal">×</button>
    </div>
    <div class="modal-body">
      <form id="articleForm">
        <div class="form-group">
          <label for="articleTitle">文章标题</label>
          <input type="text" id="articleTitle" class="form-control" placeholder="请输入文章标题" required>
        </div>
        
        <div class="form-group">
          <label for="articleAuthor">作者</label>
          <input type="text" id="articleAuthor" class="form-control" value="管理员">
        </div>
        
        <div class="form-group">
          <label for="articleCategory">分类</label>
          <select id="articleCategory" class="form-control">
            <!-- 分类将通过JavaScript动态加载 -->
          </select>
        </div>

        <div class="form-group">
          <label>标签</label>
          <div id="articleTagSelector" class="tag-selector">
            <!-- 标签选项将通过JavaScript动态加载 -->
          </div>
          <input type="hidden" id="articleTags" name="tags">
        </div>

        <div class="form-group">
          <label for="articleContent">文章内容</label>
          <textarea id="articleContent" class="form-control" placeholder="请输入文章内容（支持Markdown格式）" rows="15"></textarea>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="articleModal">取消</button>
          <button type="submit" class="btn-primary">保存文章</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 编辑文章模态框 -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>编辑文章</h3>
      <button class="modal-close" data-modal="editModal">×</button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group">
          <label for="editTitle">文章标题</label>
          <input type="text" id="editTitle" class="form-control" placeholder="请输入文章标题" required>
        </div>
        
        <div class="form-group">
          <label for="editAuthor">作者</label>
          <input type="text" id="editAuthor" class="form-control" placeholder="请输入作者">
        </div>

        <div class="form-group">
          <label for="editShowTitle">
            <input type="checkbox" id="editShowTitle" checked>
            显示标题（防止出现两次标题）
          </label>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">取消勾选后，文章内容将不显示标题，适用于标题已在内容中包含的情况</p>
        </div>

        <div class="form-group">
          <label for="editCategory">分类</label>
          <select id="editCategory" class="form-control">
            <option value="">加载中...</option>
          </select>
        </div>

        <div class="form-group">
          <label>标签</label>
          <div id="editTagSelector" class="tag-selector">
            <!-- 标签选项将通过JavaScript动态加载 -->
          </div>
          <input type="hidden" id="editTags" name="tags">
        </div>

        <div class="form-group">
          <label for="editStatus">文章状态</label>
          <select id="editStatus" class="form-control">
            <option value="draft">草稿</option>
            <option value="published">已发布</option>
            <option value="pending">待审核</option>
          </select>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            草稿：仅管理员可见<br>
            已发布：公开可见（如果可见性为公开）
          </p>
        </div>

        <div class="form-group">
          <label for="editVisibility">可见性</label>
          <select id="editVisibility" class="form-control">
            <option value="public">公开</option>
            <option value="private">私密</option>
          </select>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            公开：所有用户可见<br>
            私密：仅管理员可见
          </p>
        </div>

        <div class="form-group">
          <label for="editIsScheduled">
            <input type="checkbox" id="editIsScheduled">
            定时发布
          </label>
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            勾选后，文章将在指定时间自动发布
          </p>
        </div>

        <div class="form-group" id="editPublishedAtGroup" style="display: none;">
          <label for="editPublishedAt">发布时间</label>
          <input type="datetime-local" id="editPublishedAt" class="form-control">
          <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
            设置文章的定时发布时间
          </p>
        </div>

        <div class="form-group">
          <label for="editContent">文章内容</label>
          <textarea id="editContent" class="form-control" placeholder="请输入文章内容（支持Markdown格式）" rows="15"></textarea>
        </div>
        
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="editModal">取消</button>
          <button type="submit" class="btn-primary">保存修改</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 添加用户模态框 -->
<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>添加用户</h3>
      <button class="modal-close" data-modal="userModal">×</button>
    </div>
    <div class="modal-body">
      <form id="userForm">
        <div class="form-group">
          <label for="userName">用户名</label>
          <input type="text" id="userName" class="form-control" placeholder="请输入用户名" required>
        </div>

        <div class="form-group">
          <label for="userEmail">邮箱</label>
          <input type="email" id="userEmail" class="form-control" placeholder="请输入邮箱地址" required>
        </div>

        <div class="form-group">
          <label for="userPassword">密码</label>
          <input type="password" id="userPassword" class="form-control" placeholder="请输入密码" required>
        </div>

        <div class="form-group">
          <label for="userRole">角色</label>
          <select id="userRole" class="form-control">
            <option value="user">普通用户</option>
            <option value="editor">编辑</option>
            <option value="admin">管理员</option>
          </select>
        </div>

        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="userModal">取消</button>
          <button type="submit" class="btn-primary">创建用户</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 编辑用户模态框 -->
<div class="modal" id="editUserModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>编辑用户</h3>
      <button class="modal-close" data-modal="editUserModal">×</button>
    </div>
    <div class="modal-body">
      <form id="editUserForm">
        <div class="form-group">
          <label for="editUserName">用户名</label>
          <input type="text" id="editUserName" class="form-control" placeholder="请输入用户名" required>
        </div>

        <div class="form-group">
          <label for="editUserEmail">邮箱</label>
          <input type="email" id="editUserEmail" class="form-control" placeholder="请输入邮箱地址" required>
        </div>

        <div class="form-group">
          <label for="editUserPassword">密码</label>
          <input type="password" id="editUserPassword" class="form-control" placeholder="留空则不修改密码">
        </div>

        <div class="form-group">
          <label for="editUserRole">角色</label>
          <select id="editUserRole" class="form-control">
            <option value="user">普通用户</option>
            <option value="editor">编辑</option>
            <option value="admin">管理员</option>
          </select>
        </div>

        <div class="form-group">
          <label for="editUserStatus">状态</label>
          <select id="editUserStatus" class="form-control">
            <option value="active">正常</option>
            <option value="restricted">受限</option>
            <option value="banned">禁用</option>
          </select>
        </div>

        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="editUserModal">取消</button>
          <button type="submit" class="btn-primary">保存修改</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 文章详情模态框 -->
<div class="modal" id="viewArticleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>文章详情</h3>
      <button class="modal-close" data-modal="viewArticleModal">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>文章ID</label>
        <div id="viewArticleId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>标题</label>
        <div id="viewArticleTitle" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>作者</label>
        <div id="viewArticleAuthor" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>状态</label>
        <div id="viewArticleStatus" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>创建时间</label>
        <div id="viewArticleDate" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>内容</label>
        <div id="viewArticleContent" class="form-control" style="background: rgba(0,0,0,0.03); min-height: 200px; white-space: pre-wrap;"></div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="viewArticleModal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- 上传附件模态框 -->
<div class="modal" id="uploadAttachmentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>上传附件</h3>
      <button class="modal-close" data-modal="uploadAttachmentModal">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>文章ID</label>
        <div id="uploadAttachmentArticleId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>选择文件</label>
        <input type="file" id="attachmentFile" class="form-control" accept=".svg,.bmp,.pdf,.docx,.mp4,.mp3,.flac,.zip,.tar,.7z,.gz,.tar.gz">
        <small style="color: rgba(255,255,255,0.6); display: block; margin-top: 5px;">
          支持的文件类型：SVG, BMP, PDF, DOCX, MP4, MP3, FLAC, ZIP, TAR, 7Z, GZ, TAR.GZ
        </small>
      </div>
      <div id="uploadAttachmentProgress" style="display: none; margin-top: 15px;">
        <div style="background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden;">
          <div id="uploadAttachmentProgressBar" style="width: 0%; height: 20px; background: #007bff; transition: width 0.3s;"></div>
        </div>
        <div id="uploadAttachmentStatus" style="margin-top: 5px; font-size: 0.9em;"></div>
      </div>
      <div id="uploadAttachmentResult" style="display: none; margin-top: 15px;">
        <div style="background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3); border-radius: 8px; padding: 15px;">
          <div style="color: #00b894; font-weight: 500;">上传成功！</div>
          <div id="uploadAttachmentFileInfo" style="margin-top: 10px; font-size: 0.9em;"></div>
        </div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-primary" id="uploadAttachmentBtn">上传</button>
        <button type="button" class="btn-secondary" data-modal="uploadAttachmentModal">取消</button>
      </div>
    </div>
  </div>
</div>

<!-- 用户详情模态框 -->
<div class="modal" id="viewUserModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>用户详情</h3>
      <button class="modal-close" data-modal="viewUserModal">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>用户ID</label>
        <div id="viewUserId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>用户名</label>
        <div id="viewUserName" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>邮箱</label>
        <div id="viewUserEmail" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>角色</label>
        <div id="viewUserRole" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>状态</label>
        <div id="viewUserStatus" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>注册时间</label>
        <div id="viewUserDate" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="viewUserModal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- 评论详情模态框 -->
<div class="modal" id="viewCommentModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>评论详情</h3>
      <button class="modal-close" data-modal="viewCommentModal">×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>评论ID</label>
        <div id="viewCommentId" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>评论内容</label>
        <div id="viewCommentContent" class="form-control" style="background: rgba(0,0,0,0.03); min-height: 100px; white-space: pre-wrap;"></div>
      </div>
      <div class="form-group">
        <label>所属文章</label>
        <div id="viewCommentArticle" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>评论用户</label>
        <div id="viewCommentUser" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>状态</label>
        <div id="viewCommentStatus" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="form-group">
        <label>评论时间</label>
        <div id="viewCommentDate" class="form-control" style="background: rgba(0,0,0,0.03);"></div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="viewCommentModal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- 添加/编辑分类模态框 -->
<div class="modal" id="categoryModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="categoryModalTitle">添加分类</h3>
      <button class="modal-close" data-modal="categoryModal">×</button>
    </div>
    <div class="modal-body">
      <form id="categoryForm">
        <div class="form-group">
          <label for="categoryName">分类名称</label>
          <input type="text" id="categoryName" class="form-control" placeholder="请输入分类名称" required>
        </div>
        <div class="form-group">
          <label for="categoryDescription">描述</label>
          <textarea id="categoryDescription" class="form-control" rows="3" placeholder="请输入分类描述"></textarea>
        </div>
        <div class="form-group">
          <label for="categoryIcon">图标</label>
          <input type="text" id="categoryIcon" class="form-control" placeholder="请输入图标（emoji或图标类名）">
        </div>
        <div class="form-group">
          <label for="categorySortOrder">排序</label>
          <input type="number" id="categorySortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="categoryEnabled">
            <input type="checkbox" id="categoryEnabled" checked>
            启用
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="categoryModal">取消</button>
          <button type="submit" class="btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 添加/编辑标签模态框 -->
<div class="modal" id="tagModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="tagModalTitle">添加标签</h3>
      <button class="modal-close" data-modal="tagModal">×</button>
    </div>
    <div class="modal-body">
      <form id="tagForm">
        <div class="form-group">
          <label for="tagName">标签名称</label>
          <input type="text" id="tagName" class="form-control" placeholder="请输入标签名称" required>
        </div>
        <div class="form-group">
          <label for="tagDescription">描述</label>
          <textarea id="tagDescription" class="form-control" rows="3" placeholder="请输入标签描述"></textarea>
        </div>
        <div class="form-group">
          <label for="tagColor">颜色</label>
          <input type="color" id="tagColor" class="form-control" value="#007bff">
        </div>
        <div class="form-group">
          <label for="tagCategory">所属分类</label>
          <select id="tagCategory" class="form-control">
            <option value="0">无分类</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tagSortOrder">排序</label>
          <input type="number" id="tagSortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="tagEnabled">
            <input type="checkbox" id="tagEnabled" checked>
            启用
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="tagModal">取消</button>
          <button type="submit" class="btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 确认删除模态框 -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>确认操作</h3>
      <button class="modal-close" data-modal="confirmModal">×</button>
    </div>
    <div class="modal-body">
      <p id="confirmMessage">确定要执行此操作吗？此操作不可撤销。</p>
      <div class="btn-group">
        <button type="button" class="btn-secondary" data-modal="confirmModal">取消</button>
        <button type="button" class="btn-primary" id="confirmAction">确认</button>
      </div>
    </div>
  </div>
</div>

<!-- 编辑主卡片模态框 -->
<div class="modal" id="mainCardModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="mainCardModalTitle">编辑主卡片</h3>
      <button class="modal-close" data-modal="mainCardModal">×</button>
    </div>
    <div class="modal-body">
      <form id="mainCardForm">
        <input type="hidden" id="mainCardId">
        <div class="form-group">
          <label for="mainCardTitle">标题</label>
          <input type="text" id="mainCardTitle" class="form-control" placeholder="请输入主卡片标题" required>
        </div>
        <div class="form-group">
          <label for="mainCardIcon">图标</label>
          <input type="text" id="mainCardIcon" class="form-control" placeholder="请输入图标（如：📚）">
        </div>
        <div class="form-group">
          <label for="mainCardLayoutType">布局类型</label>
          <select id="mainCardLayoutType" class="form-control">
            <option value="grid">网格布局</option>
            <option value="flex">弹性布局</option>
            <option value="team">团队布局</option>
          </select>
        </div>
        <div class="form-group">
          <label for="mainCardCustomCss">自定义CSS</label>
          <textarea id="mainCardCustomCss" class="form-control" rows="3" placeholder="可选：输入自定义CSS样式"></textarea>
        </div>
        <div class="form-group">
          <label for="mainCardSortOrder">排序</label>
          <input type="number" id="mainCardSortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="mainCardEnabled">
            <input type="checkbox" id="mainCardEnabled" checked>
            启用
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="mainCardModal">取消</button>
          <button type="submit" class="btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 编辑次卡片模态框 -->
<div class="modal" id="subCardModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="subCardModalTitle">编辑次卡片</h3>
      <button class="modal-close" data-modal="subCardModal">×</button>
    </div>
    <div class="modal-body">
      <form id="subCardForm">
        <input type="hidden" id="subCardId">
        <div class="form-group">
          <label for="subCardMainCardId">所属主卡片</label>
          <select id="subCardMainCardId" class="form-control" required>
            <option value="">请选择主卡片</option>
          </select>
        </div>
        <div class="form-group">
          <label for="subCardTitle">标题</label>
          <input type="text" id="subCardTitle" class="form-control" placeholder="请输入次卡片标题" required>
        </div>
        <div class="form-group">
          <label for="subCardDescription">描述</label>
          <textarea id="subCardDescription" class="form-control" rows="3" placeholder="请输入描述"></textarea>
        </div>
        <div class="form-group">
          <label for="subCardIcon">图标</label>
          <input type="text" id="subCardIcon" class="form-control" placeholder="请输入图标（如：⭐）">
        </div>
        <div class="form-group">
          <label for="subCardLinkUrl">链接URL</label>
          <input type="text" id="subCardLinkUrl" class="form-control" placeholder="请输入链接URL（可选）">
        </div>
        <div class="form-group">
          <label for="subCardCustomCss">自定义CSS</label>
          <textarea id="subCardCustomCss" class="form-control" rows="3" placeholder="可选：输入自定义CSS样式"></textarea>
        </div>
        <div class="form-group">
          <label for="subCardSortOrder">排序</label>
          <input type="number" id="subCardSortOrder" class="form-control" placeholder="0" min="0" value="0">
        </div>
        <div class="form-group">
          <label for="subCardEnabled">
            <input type="checkbox" id="subCardEnabled" checked>
            启用
          </label>
        </div>
        <div class="btn-group">
          <button type="button" class="btn-secondary" data-modal="subCardModal">取消</button>
          <button type="submit" class="btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer>
  <div>&copy; {{.year}} {{.foodes}}</div>
</footer>

<script>
// Toast 通知系统
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  if (!container) {
    console.error('Toast container not found');
    return;
  }

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  let icon = '';
  switch (type) {
    case 'success':
      icon = '⭕';
      break;
    case 'error':
      icon = '❌';
      break;
    case 'warning':
      icon = '⚠️';
      break;
    default:
      icon = '⭕';
  }

  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-message">${message}</div>
    <button class="toast-close" onclick="this.parentElement.remove()">×</button>
  `;

  container.appendChild(toast);

  // 3秒后自动移除
  setTimeout(() => {
    if (toast.parentElement) {
      toast.remove();
    }
  }, 3000);
}

// 获取分类列表
async function fetchCategories() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/admin/categories', {
      headers: headers
    });
    const result = await response.json();

    if (result.success && result.data) {
      return result.data;
    } else {
      console.error('获取分类列表失败:', result.message);
      return [];
    }
  } catch (error) {
    console.error('获取分类列表失败:', error);
    return [];
  }
}

// 获取标签列表
async function fetchTags(categoryID = null) {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    let url = '/api/admin/tags';
    if (categoryID !== null && categoryID !== '') {
      url += `?category_id=${categoryID}`;
    }

    const response = await fetch(url, {
      headers: headers
    });
    const result = await response.json();

    if (result.success && result.data) {
      return result.data;
    } else {
      console.error('获取标签列表失败:', result.message);
      return [];
    }
  } catch (error) {
    console.error('获取标签列表失败:', error);
    return [];
  }
}

// 更新分类表格
function updateCategoriesTable(categories) {
  const tbody = document.querySelector('#categories tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (categories.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
          <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
          <div>暂无分类</div>
        </td>
      </tr>
    `;
    return;
  }

  categories.forEach(category => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${category.sort_order}</td>
      <td>${category.icon || ''}</td>
      <td>${category.name}</td>
      <td>${category.description || '-'}</td>
      <td><span style="color: ${category.is_enabled ? '#00b894' : '#e74c3c'};">${category.is_enabled ? '启用' : '禁用'}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-edit" data-action="edit-category" data-id="${category.id}">编辑</button>
        <button class="btn btn-sm btn-delete" data-action="delete-category" data-id="${category.id}">删除</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // 重新绑定事件
  bindActionButtons();
}

// 更新标签表格
function updateTagsTable(tags) {
  const tbody = document.querySelector('#tags tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (tags.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
          <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
          <div>暂无标签</div>
        </td>
      </tr>
    `;
    return;
  }

  tags.forEach(tag => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${tag.sort_order}</td>
      <td><span style="display: inline-block; width: 20px; height: 20px; background-color: ${tag.color}; border-radius: 4px;"></span></td>
      <td>${tag.name}</td>
      <td>${tag.description || '-'}</td>
      <td>${tag.category_id === 0 ? '无分类' : tag.category_id}</td>
      <td><span style="color: ${tag.is_enabled ? '#00b894' : '#e74c3c'};">${tag.is_enabled ? '启用' : '禁用'}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-edit" data-action="edit-tag" data-id="${tag.id}">编辑</button>
        <button class="btn btn-sm btn-delete" data-action="delete-tag" data-id="${tag.id}">删除</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // 重新绑定事件
  bindActionButtons();
}

// 加载分类和标签数据
async function loadCategoriesAndTags() {
  // 加载分类数据
  const categories = await fetchCategories();
  updateCategoriesTable(categories);

  // 填充分类筛选下拉框
  const tagCategoryFilter = document.getElementById('tagCategoryFilter');
  if (tagCategoryFilter) {
    tagCategoryFilter.innerHTML = '<option value="">全部标签</option>';
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      tagCategoryFilter.appendChild(option);
    });
  }

  // 填充标签分类下拉框
  const tagCategorySelect = document.getElementById('tagCategory');
  if (tagCategorySelect) {
    tagCategorySelect.innerHTML = '<option value="0">无分类</option>';
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      tagCategorySelect.appendChild(option);
    });
  }

  // 加载标签数据
  const tags = await fetchTags();
  updateTagsTable(tags);
}

// 填充分类下拉框
async function populateCategorySelect(selectId, selectedValue = '') {
  const select = document.getElementById(selectId);
  if (!select) return;

  // 获取分类列表
  const categories = await fetchCategories();

  // 清空现有选项
  select.innerHTML = '';

  // 添加默认选项
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '未分类';
  if (selectedValue === '' || selectedValue === '未分类') {
    defaultOption.selected = true;
  }
  select.appendChild(defaultOption);

  if (categories.length > 0) {
    // 添加分类选项
    categories.forEach(category => {
      const option = document.createElement('option');
      // 使用分类名称作为值
      option.value = category.name;
      option.textContent = category.name;
      // 如果有图标，在文本前添加图标
      if (category.icon) {
        option.textContent = `${category.icon} ${category.name}`;
      }
      if (category.name === selectedValue) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }
}

// 获取标签列表
async function fetchTags() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/admin/tags', {
      headers: headers
    });
    const result = await response.json();

    if (result.success && result.data) {
      return result.data;
    }
    return [];
  } catch (error) {
    console.error('获取标签列表失败:', error);
    return [];
  }
}

// 填充标签选择器
async function populateTagSelector(selectedTags = []) {
  const selector = document.getElementById('editTagSelector');
  if (!selector) return;

  // 获取标签列表
  const tags = await fetchTags();

  // 清空现有选项
  selector.innerHTML = '';

  if (tags.length === 0) {
    selector.innerHTML = '<div style="color: #999; font-size: 0.9em;">暂无标签</div>';
    return;
  }

  // 添加标签选项
  tags.forEach(tag => {
    if (!tag.is_enabled) return; // 只显示启用的标签

    const tagOption = document.createElement('div');
    tagOption.className = 'tag-option';
    tagOption.dataset.tagId = tag.id;
    tagOption.dataset.tagName = tag.name;
    tagOption.innerHTML = `
      <span style="display: inline-block; width: 12px; height: 12px; background-color: ${tag.color}; border-radius: 2px; margin-right: 6px;"></span>
      ${tag.name}
    `;

    // 检查是否已选中
    if (selectedTags.includes(tag.name)) {
      tagOption.classList.add('selected');
    }

    // 点击切换选中状态
    tagOption.addEventListener('click', function() {
      this.classList.toggle('selected');
      updateSelectedTags();
    });

    selector.appendChild(tagOption);
  });

  // 初始化选中的标签
  updateSelectedTags();
}

// 更新选中的标签
function updateSelectedTags() {
  const selectedTags = [];
  document.querySelectorAll('#editTagSelector .tag-option.selected').forEach(option => {
    selectedTags.push(option.dataset.tagName);
  });

  // 更新隐藏的输入框
  const tagsInput = document.getElementById('editTags');
  if (tagsInput) {
    tagsInput.value = JSON.stringify(selectedTags);
  }
}

// 填充新建文章的标签选择器
async function populateTagSelectorForNewArticle() {
  const selector = document.getElementById('articleTagSelector');
  if (!selector) return;

  // 获取标签列表
  const tags = await fetchTags();

  // 清空现有选项
  selector.innerHTML = '';

  if (tags.length === 0) {
    selector.innerHTML = '<div style="color: #999; font-size: 0.9em;">暂无标签</div>';
    return;
  }

  // 添加标签选项
  tags.forEach(tag => {
    if (!tag.is_enabled) return; // 只显示启用的标签

    const tagOption = document.createElement('div');
    tagOption.className = 'tag-option';
    tagOption.dataset.tagId = tag.id;
    tagOption.dataset.tagName = tag.name;
    tagOption.innerHTML = `
      <span style="display: inline-block; width: 12px; height: 12px; background-color: ${tag.color}; border-radius: 2px; margin-right: 6px;"></span>
      ${tag.name}
    `;

    // 点击切换选中状态
    tagOption.addEventListener('click', function() {
      this.classList.toggle('selected');
      updateSelectedTagsForNewArticle();
    });

    selector.appendChild(tagOption);
  });

  // 初始化选中的标签
  updateSelectedTagsForNewArticle();
}

// 更新建文章选中的标签
function updateSelectedTagsForNewArticle() {
  const selectedTags = [];
  document.querySelectorAll('#articleTagSelector .tag-option.selected').forEach(option => {
    selectedTags.push(option.dataset.tagName);
  });

  // 更新隐藏的输入框
  const tagsInput = document.getElementById('articleTags');
  if (tagsInput) {
    tagsInput.value = JSON.stringify(selectedTags);
  }
}

// 填充上传文章模态框的标签选择器
async function populateTagSelectorForUpload() {
  const selector = document.getElementById('uploadTagSelector');
  if (!selector) return;

  // 获取标签列表
  const tags = await fetchTags();

  // 清空现有选项
  selector.innerHTML = '';

  if (tags.length === 0) {
    selector.innerHTML = '<div style="color: #999; font-size: 0.9em;">暂无标签</div>';
    return;
  }

  // 添加标签选项
  tags.forEach(tag => {
    if (!tag.is_enabled) return; // 只显示启用的标签

    const tagOption = document.createElement('div');
    tagOption.className = 'tag-option';
    tagOption.dataset.tagId = tag.id;
    tagOption.dataset.tagName = tag.name;
    tagOption.innerHTML = `
      <span style="display: inline-block; width: 12px; height: 12px; background-color: ${tag.color}; border-radius: 2px; margin-right: 6px;"></span>
      ${tag.name}
    `;

    // 点击切换选中状态
    tagOption.addEventListener('click', function() {
      this.classList.toggle('selected');
    });

    selector.appendChild(tagOption);
  });
}

// 填充上传文章模态框的分类选择器
async function populateCategorySelectorForUpload() {
  const selector = document.getElementById('uploadCategory');
  if (!selector) return;

  // 获取分类列表
  const categories = await fetchCategories();

  // 清空现有选项
  selector.innerHTML = '';

  if (categories.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = '暂无分类';
    selector.appendChild(option);
    return;
  }

  // 添加分类选项
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.name;
    option.textContent = category.name;
    selector.appendChild(option);
  });
}

// 填充新建文章模态框的分类选择器
async function populateCategorySelectorForNewArticle() {
  const selector = document.getElementById('articleCategory');
  if (!selector) return;

  // 获取分类列表
  const categories = await fetchCategories();

  // 清空现有选项
  selector.innerHTML = '';

  if (categories.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = '暂无分类';
    selector.appendChild(option);
    return;
  }

  // 添加分类选项
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.name;
    option.textContent = category.name;
    selector.appendChild(option);
  });
}

// 从后端API获取数据
async function fetchAdminData(page = 1, limit = 10, userPage = 1, userLimit = 10, commentsPage = 1, commentsLimit = 10) {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // 获取文章数据（带分页）
    const passagesResponse = await fetch(`/api/admin/passages?page=${page}&limit=${limit}`, {
      headers: headers
    });
    const passagesResult = await passagesResponse.json();

    if (passagesResult.success && passagesResult.data) {
      if (passagesResult.data.length > 0) {
        updateArticlesTable(passagesResult.data);
        const totalArticles = passagesResult.pagination?.total || passagesResult.data.length;
        updateStatCard('totalArticles', totalArticles);
        // 更新分页信息
        updatePagination(passagesResult.pagination);
      } else {
        showEmptyState('articlesTableBody', '暂无文章');
        updateStatCard('totalArticles', 0);
        // 隐藏分页
        hidePagination();
      }
    } else {
      showEmptyState('articlesTableBody', '暂无文章');
      updateStatCard('totalArticles', 0);
      hidePagination();
    }

    // 获取用户数据（带分页）
    const usersResponse = await fetch(`/api/admin/users?page=${userPage}&limit=${userLimit}`, {
      headers: headers
    });
    const usersResult = await usersResponse.json();

    if (usersResult.success && usersResult.data) {
      if (usersResult.data.length > 0) {
        updateUsersTable(usersResult.data);
        const totalUsers = usersResult.pagination?.total || usersResult.data.length;
        updateStatCard('totalUsers', totalUsers);
        // 更新用户分页信息
        updateUserPagination(usersResult.pagination);
      } else {
        showEmptyState('usersTableBody', '暂无用户', 7);
        updateStatCard('totalUsers', 0);
        // 隐藏用户分页
        hideUserPagination();
      }
    } else {
      showEmptyState('usersTableBody', '暂无用户', 7);
      updateStatCard('totalUsers', 0);
      hideUserPagination();
    }

    // 获取评论数据（带分页）
    const commentsResponse = await fetch(`/api/admin/comments?page=${commentsPage}&limit=${commentsLimit}`, {
      headers: headers
    });
    const commentsResult = await commentsResponse.json();

    if (commentsResult.success && commentsResult.data) {
      if (commentsResult.data.length > 0) {
        updateCommentsTable(commentsResult.data);
        // 更新评论分页信息
        updateCommentsPagination(commentsResult.pagination);
      } else {
        showEmptyState('commentsTableBody', '暂无评论', 6);
        // 隐藏评论分页
        hideCommentsPagination();
      }
    } else {
      showEmptyState('commentsTableBody', '暂无评论', 6);
      hideCommentsPagination();
    }

    // 获取统计数据
    const statsResponse = await fetch('/api/admin/stats', {
      headers: headers
    });
    const statsResult = await statsResponse.json();

    console.log('统计数据响应:', statsResult);

    if (statsResult.success && statsResult.data) {
      updateStatCard('todayVisits', statsResult.data.today_visits || 0);

      // 更新今日访问量对比信息
      const todayVisitsCard = document.querySelector('#todayVisits').closest('.stat-card');
      const changeElement = todayVisitsCard.querySelector('.stat-change');
      if (changeElement && statsResult.data.yesterday_visits !== undefined) {
        const yesterdayVisits = statsResult.data.yesterday_visits;
        const changePercent = statsResult.data.visits_change_percent || 0;
        const trend = statsResult.data.visits_trend || 'stable';

        if (trend === 'up') {
          changeElement.className = 'stat-change positive';
          changeElement.textContent = `较昨日 +${changePercent.toFixed(1)}%`;
        } else if (trend === 'down') {
          changeElement.className = 'stat-change negative';
          changeElement.textContent = `较昨日 ${changePercent.toFixed(1)}%`;
        } else {
          changeElement.className = 'stat-change neutral';
          changeElement.textContent = '较昨日持平';
        }
      }
    } else {
      console.error('获取统计数据失败:', statsResult);
    }
  } catch (error) {
    console.error('获取管理数据失败:', error);
  }
}

// 显示空状态
function showEmptyState(tableId, message, colspan = 6) {
  const tbody = document.querySelector(`#${tableId}`);
  if (!tbody) return;

  const token = localStorage.getItem('auth_token');
  let displayMessage = message;

  if (!token) {
    displayMessage = '请先登录以查看数据';
  }

  tbody.innerHTML = `
    <tr>
      <td colspan="${colspan}" style="text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 48px; margin-bottom: 10px;">📭</div>
        <div>${displayMessage}</div>
        ${!token ? '<div style="margin-top: 10px; font-size: 0.9em;"><a href="#loginModal" onclick="document.getElementById(\'loginBtn\').click(); return false;" style="color: #007bff; text-decoration: none;">点击登录</a></div>' : ''}
      </td>
    </tr>
  `;
}

// 分页相关变量
let currentPage = 1;
let currentLimit = 10;
let totalPages = 1;

// 更新分页信息
function updatePagination(pagination) {
  if (!pagination) {
    hidePagination();
    return;
  }

  const page = parseInt(pagination.page) || 1;
  const limit = parseInt(pagination.limit) || 10;
  const total = parseInt(pagination.total) || 0;

  currentPage = page;
  currentLimit = limit;
  totalPages = Math.ceil(total / limit);

  // 显示分页容器
  const paginationContainer = document.getElementById('paginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'flex';
  }

  // 更新分页信息文本
  const start = (page - 1) * limit + 1;
  const end = Math.min(page * limit, total);
  const paginationInfo = document.getElementById('paginationInfo');
  if (paginationInfo) {
    paginationInfo.textContent = `显示 ${start}-${end} 条，共 ${total} 条`;
  }

  // 更新上一页/下一页按钮状态
  const prevBtn = document.getElementById('prevPageBtn');
  const nextBtn = document.getElementById('nextPageBtn');
  if (prevBtn) prevBtn.disabled = page <= 1;
  if (nextBtn) nextBtn.disabled = page >= totalPages;

  // 生成页码按钮
  generatePageButtons(page, totalPages);
}

// 隐藏分页
function hidePagination() {
  const paginationContainer = document.getElementById('paginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'none';
  }
}

// 生成页码按钮
function generatePageButtons(currentPage, totalPages) {
  const pagesContainer = document.getElementById('paginationPages');
  if (!pagesContainer) return;

  pagesContainer.innerHTML = '';

  // 计算显示的页码范围
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  // 确保至少显示5个页码（如果有足够多的页）
  if (endPage - startPage < 4) {
    if (startPage === 1) {
      endPage = Math.min(totalPages, 5);
    } else if (endPage === totalPages) {
      startPage = Math.max(1, totalPages - 4);
    }
  }

  // 添加第一页
  if (startPage > 1) {
    addPageButton(1, pagesContainer);
    if (startPage > 2) {
      addEllipsis(pagesContainer);
    }
  }

  // 添加页码按钮
  for (let i = startPage; i <= endPage; i++) {
    addPageButton(i, pagesContainer, i === currentPage);
  }

  // 添加最后一页
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      addEllipsis(pagesContainer);
    }
    addPageButton(totalPages, pagesContainer);
  }
}

// 添加页码按钮
function addPageButton(page, container, isActive = false) {
  const button = document.createElement('button');
  button.className = `pagination-page ${isActive ? 'active' : ''}`;
  button.textContent = page;
  button.addEventListener('click', () => {
    if (page !== currentPage) {
      fetchAdminData(page, currentLimit);
    }
  });
  container.appendChild(button);
}

// 添加省略号
function addEllipsis(container) {
  const ellipsis = document.createElement('span');
  ellipsis.className = 'pagination-page ellipsis';
  ellipsis.textContent = '...';
  container.appendChild(ellipsis);
}

// 切换到上一页
function goToPrevPage() {
  if (currentPage > 1) {
    fetchAdminData(currentPage - 1, currentLimit);
  }
}

// 切换到下一页
function goToNextPage() {
  if (currentPage < totalPages) {
    fetchAdminData(currentPage + 1, currentLimit);
  }
}

// 解析JWT token获取用户名
function getUsernameFromToken() {
  const token = localStorage.getItem('auth_token');
  if (!token) {
    return '管理员';
  }

  try {
    // JWT token由三部分组成：header.payload.signature
    const parts = token.split('.');
    if (parts.length !== 3) {
      return '管理员';
    }

    // 解码payload部分（base64url编码）
    const payload = parts[1];
    // 将base64url转换为base64
    const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');
    // 解码base64
    const decoded = atob(base64);
    // 解析JSON
    const claims = JSON.parse(decoded);

    return claims.username || '管理员';
  } catch (error) {
    console.error('解析token失败:', error);
    return '管理员';
  }
}

// 更新欢迎信息
async function updateWelcomeMessage() {
  const username = getUsernameFromToken();
  const welcomeTitle = document.querySelector('.welcome-text h2');
  if (welcomeTitle) {
    welcomeTitle.textContent = `欢迎回来，${username}`;
  }

  // 获取全局头像设置
  let avatarPath = '/img/avatar.png';
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/template', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();
      if (settings.global_avatar) {
        avatarPath = settings.global_avatar;
      }
    }
  } catch (error) {
    console.error('获取全局头像设置失败:', error);
  }

  // 更新头像为图片
  const avatar = document.querySelector('.admin-avatar');
  if (avatar) {
    avatar.innerHTML = `<img src="${avatarPath}" alt="${username}" class="avatar-image">`;
  }
}

// 绑定分页按钮事件
document.addEventListener('DOMContentLoaded', function() {
  // 更新欢迎信息
  updateWelcomeMessage();

  const prevBtn = document.getElementById('prevPageBtn');
  const nextBtn = document.getElementById('nextPageBtn');
  const refreshBtn = document.getElementById('refreshArticlesBtn');

  if (prevBtn) {
    prevBtn.addEventListener('click', goToPrevPage);
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', goToNextPage);
  }
  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
      fetchAdminData(currentPage, currentLimit);
    });
  }

  // 用户分页按钮
  const prevUserBtn = document.getElementById('prevUserPageBtn');
  const nextUserBtn = document.getElementById('nextUserPageBtn');

  if (prevUserBtn) {
    prevUserBtn.addEventListener('click', goToPrevUserPage);
  }
  if (nextUserBtn) {
    nextUserBtn.addEventListener('click', goToNextUserPage);
  }

  // 评论分页按钮
  const prevCommentsBtn = document.getElementById('prevCommentsPageBtn');
  const nextCommentsBtn = document.getElementById('nextCommentsPageBtn');
  const refreshCommentsBtn = document.getElementById('refreshCommentsBtn');

  if (prevCommentsBtn) {
    prevCommentsBtn.addEventListener('click', goToPrevCommentsPage);
  }
  if (nextCommentsBtn) {
    nextCommentsBtn.addEventListener('click', goToNextCommentsPage);
  }
  if (refreshCommentsBtn) {
    refreshCommentsBtn.addEventListener('click', () => {
      fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, currentCommentsPage, currentCommentsLimit);
    });
  }

  // 分类管理按钮
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const refreshCategoriesBtn = document.getElementById('refreshCategoriesBtn');

  if (addCategoryBtn) {
    addCategoryBtn.addEventListener('click', () => {
      document.getElementById('categoryModalTitle').textContent = '添加分类';
      document.getElementById('categoryForm').reset();
      delete document.getElementById('categoryForm').dataset.categoryId;
      openModal('categoryModal');
    });
  }
  if (refreshCategoriesBtn) {
    refreshCategoriesBtn.addEventListener('click', loadCategoriesAndTags);
  }

  // 标签管理按钮
  const addTagBtn = document.getElementById('addTagBtn');
  const refreshTagsBtn = document.getElementById('refreshTagsBtn');
  const tagCategoryFilter = document.getElementById('tagCategoryFilter');

  if (addTagBtn) {
    addTagBtn.addEventListener('click', async () => {
      await loadCategoriesAndTags();
      document.getElementById('tagModalTitle').textContent = '添加标签';
      document.getElementById('tagForm').reset();
      delete document.getElementById('tagForm').dataset.tagId;
      openModal('tagModal');
    });
  }
  if (refreshTagsBtn) {
    refreshTagsBtn.addEventListener('click', loadCategoriesAndTags);
  }
  if (tagCategoryFilter) {
    tagCategoryFilter.addEventListener('change', async function() {
      const categoryID = this.value;
      const tags = await fetchTags(categoryID);
      updateTagsTable(tags);
    });
  }
});

// 用户分页相关变量
let currentUserPage = 1;
let currentUserLimit = 10;
let totalUserPages = 1;

// 更新用户分页信息
function updateUserPagination(pagination) {
  if (!pagination) {
    hideUserPagination();
    return;
  }

  const page = parseInt(pagination.page) || 1;
  const limit = parseInt(pagination.limit) || 10;
  const total = parseInt(pagination.total) || 0;

  currentUserPage = page;
  currentUserLimit = limit;
  totalUserPages = Math.ceil(total / limit);

  // 显示分页容器
  const paginationContainer = document.getElementById('userPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'flex';
  }

  // 更新分页信息文本
  const start = (page - 1) * limit + 1;
  const end = Math.min(page * limit, total);
  const paginationInfo = document.getElementById('userPaginationInfo');
  if (paginationInfo) {
    paginationInfo.textContent = `显示 ${start}-${end} 条，共 ${total} 条`;
  }

  // 更新上一页/下一页按钮状态
  const prevBtn = document.getElementById('prevUserPageBtn');
  const nextBtn = document.getElementById('nextUserPageBtn');
  if (prevBtn) prevBtn.disabled = page <= 1;
  if (nextBtn) nextBtn.disabled = page >= totalUserPages;

  // 生成页码按钮
  generateUserPageButtons(page, totalUserPages);
}

// 隐藏用户分页
function hideUserPagination() {
  const paginationContainer = document.getElementById('userPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'none';
  }
}

// 生成用户页码按钮
function generateUserPageButtons(currentPage, totalPages) {
  const pagesContainer = document.getElementById('userPaginationPages');
  if (!pagesContainer) return;

  pagesContainer.innerHTML = '';

  // 计算显示的页码范围
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  // 确保至少显示5个页码（如果有足够多的页）
  if (endPage - startPage < 4) {
    if (startPage === 1) {
      endPage = Math.min(totalPages, 5);
    } else if (endPage === totalPages) {
      startPage = Math.max(1, totalPages - 4);
    }
  }

  // 添加第一页
  if (startPage > 1) {
    addUserPageButton(1, pagesContainer);
    if (startPage > 2) {
      addUserEllipsis(pagesContainer);
    }
  }

  // 添加页码按钮
  for (let i = startPage; i <= endPage; i++) {
    addUserPageButton(i, pagesContainer, i === currentPage);
  }

  // 添加最后一页
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      addUserEllipsis(pagesContainer);
    }
    addUserPageButton(totalPages, pagesContainer);
  }
}

// 添加用户页码按钮
function addUserPageButton(page, container, isActive = false) {
  const button = document.createElement('button');
  button.className = `pagination-page ${isActive ? 'active' : ''}`;
  button.textContent = page;
  button.addEventListener('click', () => {
    if (page !== currentUserPage) {
      fetchAdminData(currentPage, currentLimit, page, currentUserLimit);
    }
  });
  container.appendChild(button);
}

// 添加用户省略号
function addUserEllipsis(container) {
  const ellipsis = document.createElement('span');
  ellipsis.className = 'pagination-page ellipsis';
  ellipsis.textContent = '...';
  container.appendChild(ellipsis);
}

// 切换到用户上一页
function goToPrevUserPage() {
  if (currentUserPage > 1) {
    fetchAdminData(currentPage, currentLimit, currentUserPage - 1, currentUserLimit);
  }
}

// 切换到用户下一页
function goToNextUserPage() {
  if (currentUserPage < totalUserPages) {
    fetchAdminData(currentPage, currentLimit, currentUserPage + 1, currentUserLimit);
  }
}

// 评论分页相关变量
let currentCommentsPage = 1;
let currentCommentsLimit = 10;
let totalCommentsPages = 1;

// 更新评论表格
function updateCommentsTable(comments) {
  const tbody = document.querySelector('#comments tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  comments.forEach(comment => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>#${comment.id}</td>
      <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${comment.content}</td>
      <td>${comment.passage_id}</td>
      <td>${comment.username}</td>
      <td>${comment.created_at}</td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-delete" data-action="delete-comment" data-id="${comment.id}">删除</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // 重新绑定事件
  bindActionButtons();
}

// 更新评论分页信息
function updateCommentsPagination(pagination) {
  if (!pagination) {
    hideCommentsPagination();
    return;
  }

  const page = parseInt(pagination.page) || 1;
  const limit = parseInt(pagination.limit) || 10;
  const total = parseInt(pagination.total) || 0;

  currentCommentsPage = page;
  currentCommentsLimit = limit;
  totalCommentsPages = Math.ceil(total / limit);

  // 显示分页容器
  const paginationContainer = document.getElementById('commentsPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'flex';
  }

  // 更新分页信息文本
  const start = (page - 1) * limit + 1;
  const end = Math.min(page * limit, total);
  const paginationInfo = document.getElementById('commentsPaginationInfo');
  if (paginationInfo) {
    paginationInfo.textContent = `显示 ${start}-${end} 条，共 ${total} 条`;
  }

  // 更新上一页/下一页按钮状态
  const prevBtn = document.getElementById('prevCommentsPageBtn');
  const nextBtn = document.getElementById('nextCommentsPageBtn');
  if (prevBtn) prevBtn.disabled = page <= 1;
  if (nextBtn) nextBtn.disabled = page >= totalCommentsPages;

  // 生成页码按钮
  generateCommentsPageButtons(page, totalCommentsPages);
}

// 隐藏评论分页
function hideCommentsPagination() {
  const paginationContainer = document.getElementById('commentsPaginationContainer');
  if (paginationContainer) {
    paginationContainer.style.display = 'none';
  }
}

// 生成评论页码按钮
function generateCommentsPageButtons(currentPage, totalPages) {
  const pagesContainer = document.getElementById('commentsPaginationPages');
  if (!pagesContainer) return;

  pagesContainer.innerHTML = '';

  // 计算显示的页码范围
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  // 确保至少显示5个页码（如果有足够多的页）
  if (endPage - startPage < 4) {
    if (startPage === 1) {
      endPage = Math.min(totalPages, 5);
    } else if (endPage === totalPages) {
      startPage = Math.max(1, totalPages - 4);
    }
  }

  // 添加第一页
  if (startPage > 1) {
    addCommentsPageButton(1, pagesContainer);
    if (startPage > 2) {
      addCommentsEllipsis(pagesContainer);
    }
  }

  // 添加页码按钮
  for (let i = startPage; i <= endPage; i++) {
    addCommentsPageButton(i, pagesContainer, i === currentPage);
  }

  // 添加最后一页
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      addCommentsEllipsis(pagesContainer);
    }
    addCommentsPageButton(totalPages, pagesContainer);
  }
}

// 添加评论页码按钮
function addCommentsPageButton(page, container, isActive = false) {
  const button = document.createElement('button');
  button.className = `pagination-page ${isActive ? 'active' : ''}`;
  button.textContent = page;
  button.addEventListener('click', () => {
    if (page !== currentCommentsPage) {
      fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, page, currentCommentsLimit);
    }
  });
  container.appendChild(button);
}

// 添加评论省略号
function addCommentsEllipsis(container) {
  const ellipsis = document.createElement('span');
  ellipsis.className = 'pagination-page ellipsis';
  ellipsis.textContent = '...';
  container.appendChild(ellipsis);
}

// 切换到评论上一页
function goToPrevCommentsPage() {
  if (currentCommentsPage > 1) {
    fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, currentCommentsPage - 1, currentCommentsLimit);
  }
}

// 切换到评论下一页
function goToNextCommentsPage() {
  if (currentCommentsPage < totalCommentsPages) {
    fetchAdminData(currentPage, currentLimit, currentUserPage, currentUserLimit, currentCommentsPage + 1, currentCommentsLimit);
  }
}

// 更新文章表格
function updateArticlesTable(articles) {
  const tbody = document.querySelector('#articles tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  articles.forEach(article => {
    const row = document.createElement('tr');

    // 构建状态标签
    let statusBadge = `<span class="status ${article.status || 'published'}">${getStatusText(article.status || 'published')}</span>`;

    // 如果是定时发布，添加定时标识
    if (article.is_scheduled) {
      statusBadge += ` <span class="status scheduled" title="定时发布">⏰ ${article.published_at ? formatDate(article.published_at) : '未设置'}</span>`;
    }

    // 构建可见性标签
    const visibility = article.visibility || 'public';
    const visibilityText = visibility === 'public' ? '公开' : '私密';
    const visibilityClass = visibility === 'public' ? 'visibility-public' : 'visibility-private';

    row.innerHTML = `
      <td>#${article.id}</td>
      <td>${article.title}</td>
      <td>管理员</td>
      <td>${article.created_at || '2024-01-01'}</td>
      <td>${statusBadge}</td>
      <td><span class="visibility ${visibilityClass}">${visibilityText}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-view" data-action="view" data-id="${article.id}">查看</button>
        <button class="btn btn-sm btn-edit" data-action="edit" data-id="${article.id}">编辑</button>
        <button class="btn btn-sm btn-upload" data-action="upload" data-id="${article.id}">上传附件</button>
        <button class="btn btn-sm btn-delete" data-action="delete" data-id="${article.id}">删除</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  // 重新绑定事件
  bindActionButtons();
}

// 格式化日期
function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// 更新用户表格
function updateUsersTable(users) {
  const tbody = document.querySelector('#users tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  users.forEach(user => {
    const row = document.createElement('tr');
    const roleText = user.role === 'admin' ? '管理员' : (user.role === 'editor' ? '编辑' : '普通用户');
    const statusText = user.status === 'active' ? '正常' : (user.status === 'restricted' ? '受限' : '禁用');
    const statusColor = user.status === 'active' ? '#00b894' : (user.status === 'restricted' ? '#fdcb6e' : '#e74c3c');

    row.innerHTML = `
      <td>#${user.id}</td>
      <td>${user.username}</td>
      <td>${user.email}</td>
      <td>${user.created_at || '2024-01-01'}</td>
      <td>${roleText}</td>
      <td><span style="color:${statusColor};">${statusText}</span></td>
      <td class="action-buttons">
        <button class="btn btn-sm btn-view" data-action="view-user" data-id="${user.id}">详情</button>
        <button class="btn btn-sm btn-edit" data-action="edit-user" data-id="${user.id}">编辑</button>
        ${user.role !== 'admin' ? `<button class="btn btn-sm btn-delete" data-action="delete-user" data-id="${user.id}">删除</button>` : ''}
      </td>
    `;
    tbody.appendChild(row);
  });

  // 重新绑定事件
  bindActionButtons();
}

// 更新统计卡片
function updateStatCard(id, value) {
  const element = document.getElementById(id);
  if (element) {
    element.textContent = value;
  }
}

// 获取认证头（全局函数）
function getAuthHeaders() {
  const token = localStorage.getItem('auth_token');
  return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// 统计分析相关函数
let viewTrendChart = null;

// 加载热门文章
async function loadMostViewedArticles() {
  const limit = document.getElementById('mostViewedLimit')?.value || 10;
  const tbody = document.getElementById('mostViewedTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载中...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=most-viewed&limit=${limit}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无数据</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((article, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${article.title}</td>
          <td>${article.author}</td>
          <td>${article.view_count}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载失败</td></tr>';
    }
  } catch (error) {
    console.error('加载热门文章失败:', error);
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载失败</td></tr>';
  }
}

// 加载访问来源
async function loadViewSources() {
  const days = document.getElementById('viewSourcesDays')?.value || 30;
  const tbody = document.getElementById('viewSourcesTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">加载中...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-sources&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">暂无数据</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((source, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${source.country}</td>
          <td>${source.count}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">加载失败</td></tr>';
    }
  } catch (error) {
    console.error('加载访问来源失败:', error);
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">加载失败</td></tr>';
  }
}

// 加载访问来源（按城市）
async function loadViewByCity() {
  const days = document.getElementById('viewByCityDays')?.value || 30;
  const tbody = document.getElementById('viewByCityTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载中...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-by-city&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无数据</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((city, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${city.city}</td>
          <td>${city.region}</td>
          <td>${city.count}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载失败</td></tr>';
    }
  } catch (error) {
    console.error('加载城市统计失败:', error);
    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">加载失败</td></tr>';
  }
}

// 加载访问来源（按IP）
async function loadViewByIP() {
  const days = document.getElementById('viewByIPDays')?.value || 30;
  const tbody = document.getElementById('viewByIPTableBody');
  
  if (!tbody) return;
  
  tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">加载中...</td></tr>';
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-by-ip&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      if (result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">暂无数据</td></tr>';
        return;
      }
      
      tbody.innerHTML = result.data.map((ipData, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${ipData.ip}</td>
          <td>${ipData.country || '-'}</td>
          <td>${ipData.city || '-'}</td>
          <td>${ipData.region || '-'}</td>
          <td>${ipData.count}</td>
          <td>${ipData.firstVisit}</td>
          <td>${ipData.lastVisit}</td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">加载失败</td></tr>';
    }
  } catch (error) {
    console.error('加载IP统计失败:', error);
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">加载失败</td></tr>';
  }
}

// 加载阅读趋势
async function loadViewTrend() {
  const days = document.getElementById('viewTrendDays')?.value || 30;
  const canvas = document.getElementById('viewTrendChart');
  
  if (!canvas) return;
  
  try {
    const response = await fetch(`/api/admin/analytics?action=view-trend&days=${days}`, {
      headers: getAuthHeaders()
    });
    const result = await response.json();
    
    if (result.success && result.data) {
      drawViewTrendChart(result.data);
    }
  } catch (error) {
    console.error('加载阅读趋势失败:', error);
  }
}

// 绘制阅读趋势图表
function drawViewTrendChart(data) {
  const canvas = document.getElementById('viewTrendChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // 清空画布
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (!data || data.length === 0) {
    ctx.font = '16px Arial';
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.textAlign = 'center';
    ctx.fillText('暂无数据', canvas.width / 2, canvas.height / 2);
    return;
  }
  
  const padding = 50;
  const chartWidth = canvas.width - padding * 2;
  const chartHeight = canvas.height - padding * 2;
  
  // 找出最大值
  const maxCount = Math.max(...data.map(d => d.count));
  
  // 绘制坐标轴
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, canvas.height - padding);
  ctx.lineTo(canvas.width - padding, canvas.height - padding);
  ctx.stroke();
  
  // 绘制数据点和连线
  const stepX = chartWidth / (data.length - 1 || 1);
  
  ctx.beginPath();
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
  ctx.lineWidth = 2;
  
  data.forEach((point, index) => {
    const x = padding + index * stepX;
    const y = canvas.height - padding - (point.count / maxCount) * chartHeight;
    
    if (index === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });
  ctx.stroke();
  
  // 绘制数据点
  data.forEach((point, index) => {
    const x = padding + index * stepX;
    const y = canvas.height - padding - (point.count / maxCount) * chartHeight;
    
    ctx.beginPath();
    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fill();
    
    // 显示数值
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(point.count, x, y - 10);
    
    // 显示日期
    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
    ctx.font = '10px Arial';
    ctx.fillText(point.date.substring(5), x, canvas.height - padding + 15);
  });
}

// 初始化统计分析
function initAnalytics() {
  // 绑定热门文章下拉框
  const mostViewedLimit = document.getElementById('mostViewedLimit');
  if (mostViewedLimit) {
    mostViewedLimit.addEventListener('change', loadMostViewedArticles);
  }
  
  // 绑定访问来源下拉框
  const viewSourcesDays = document.getElementById('viewSourcesDays');
  if (viewSourcesDays) {
    viewSourcesDays.addEventListener('change', loadViewSources);
  }
  
  // 绑定访问来源（按城市）下拉框
  const viewByCityDays = document.getElementById('viewByCityDays');
  if (viewByCityDays) {
    viewByCityDays.addEventListener('change', loadViewByCity);
  }
  
  // 绑定访问来源（按IP）下拉框
  const viewByIPDays = document.getElementById('viewByIPDays');
  if (viewByIPDays) {
    viewByIPDays.addEventListener('change', loadViewByIP);
  }
  
  // 绑定阅读趋势下拉框
  const viewTrendDays = document.getElementById('viewTrendDays');
  if (viewTrendDays) {
    viewTrendDays.addEventListener('change', loadViewTrend);
  }
  
  // 初始加载数据
  loadMostViewedArticles();
  loadViewSources();
  loadViewByCity();
  loadViewByIP();
  loadViewTrend();
}

// 获取状态文本
function getStatusText(status) {
  const statusMap = {
    'published': '已发布',
    'draft': '草稿',
    'pending': '待审核'
  };
  return statusMap[status] || status;
}

// 绑定操作按钮事件
function bindActionButtons() {
  document.querySelectorAll('.action-buttons button').forEach(button => {
    // 移除旧的事件监听器
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    newButton.addEventListener('click', async function() {
      const action = this.getAttribute('data-action');
      const itemId = this.getAttribute('data-id');
      
      if (action === 'delete' || action === 'delete-comment' || action === 'delete-user' || action === 'delete-category') {
        currentAction = action;
        currentItemId = itemId;

        let message = '';
        if (action === 'delete') {
          message = `确定要删除文章 #${itemId} 吗？此操作不可撤销。`;
        } else if (action === 'delete-comment') {
          message = `确定要删除评论 #${itemId} 吗？此操作不可撤销。`;
        } else if (action === 'delete-user') {
          message = `确定要删除用户 #${itemId} 吗？此操作不可撤销。`;
        } else if (action === 'delete-category') {
          message = `确定要删除分类 #${itemId} 吗？此操作不可撤销。`;
        }

        document.getElementById('confirmMessage').textContent = message;
        openModal('confirmModal');
      } else if (action === 'edit') {
              // 从后端获取文章详情
              try {
                const token = localStorage.getItem('auth_token');
      
                const headers = {
                  'Content-Type': 'application/json'
                };
                if (token) {
                  headers['Authorization'] = `Bearer ${token}`;
                }
      
                const response = await fetch(`/api/admin/passages?id=${itemId}`, {
                  headers: headers
                });
                const result = await response.json();
      
                if (result.success && result.data) {
                  // 先填充分类下拉框
                  await populateCategorySelect('editCategory', result.data.category || '');

                  // 填充编辑表单
                  document.getElementById('editTitle').value = result.data.title || '';
                  document.getElementById('editAuthor').value = result.data.author || '管理员';
                  document.getElementById('editContent').value = result.data.content || '';
                  document.getElementById('editShowTitle').checked = result.data.show_title !== false;

                  // 填充状态和可见性
                  document.getElementById('editStatus').value = result.data.status || 'published';
                  document.getElementById('editVisibility').value = result.data.visibility || 'public';

                  // 填充定时发布选项
                  const isScheduled = result.data.is_scheduled || false;
                  document.getElementById('editIsScheduled').checked = isScheduled;

                  // 显示/隐藏发布时间输入框
                  const publishedAtGroup = document.getElementById('editPublishedAtGroup');
                  if (isScheduled) {
                    publishedAtGroup.style.display = 'block';
                    // 填充发布时间
                    if (result.data.published_at) {
                      const publishedDate = new Date(result.data.published_at);
                      // 转换为 datetime-local 格式 (YYYY-MM-DDTHH:mm)
                      const localDateTime = new Date(publishedDate.getTime() - publishedDate.getTimezoneOffset() * 60000)
                        .toISOString()
                        .slice(0, 16);
                      document.getElementById('editPublishedAt').value = localDateTime;
                    }
                  } else {
                    publishedAtGroup.style.display = 'none';
                    document.getElementById('editPublishedAt').value = '';
                  }

                  // 解析并填充标签
                  let selectedTags = [];
                  if (result.data.tags) {
                    try {
                      selectedTags = JSON.parse(result.data.tags);
                    } catch (e) {
                      // 如果解析失败，尝试按逗号分割
                      selectedTags = result.data.tags.split(',').map(t => t.trim()).filter(t => t);
                    }
                  }
                  await populateTagSelector(selectedTags);

                  // 保存当前编辑的文章ID
                  document.getElementById('editForm').dataset.articleId = itemId;

                  openModal('editModal');
                } else {
                  showToast('获取文章详情失败：' + (result.message || '未知错误'), 'error');
                }
              } catch (error) {
                console.error('获取文章详情失败:', error);
                showToast('获取文章详情失败，请稍后重试', 'error');
              }
            } else if (action === 'upload') {
        // 打开上传附件模态框
        document.getElementById('uploadAttachmentArticleId').textContent = '#' + itemId;
        document.getElementById('uploadAttachmentArticleId').dataset.articleId = itemId;
        document.getElementById('attachmentFile').value = '';
        document.getElementById('uploadAttachmentProgress').style.display = 'none';
        document.getElementById('uploadAttachmentResult').style.display = 'none';
        openModal('uploadAttachmentModal');
      } else if (action === 'view') {
        // 从后端获取文章详情并显示
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/passages?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // 填充详情模态框
            document.getElementById('viewArticleId').textContent = '#' + result.data.id;
            document.getElementById('viewArticleTitle').textContent = result.data.title || '';
            document.getElementById('viewArticleAuthor').textContent = result.data.author || '管理员';
            document.getElementById('viewArticleStatus').textContent = getStatusText(result.data.status || 'published');
            document.getElementById('viewArticleDate').textContent = result.data.created_at || '';
            document.getElementById('viewArticleContent').textContent = result.data.content || '';
            
            openModal('viewArticleModal');
          } else {
            showToast('获取文章详情失败：' + (result.message || '未知错误'), 'error');
          }
        } catch (error) {
          console.error('获取文章详情失败:', error);
          showToast('获取文章详情失败，请稍后重试', 'error');
        }
      } else if (action === 'edit-user') {
        // 从后端获取用户详情
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/users?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // 填充编辑表单
            document.getElementById('editUserName').value = result.data.username || '';
            document.getElementById('editUserEmail').value = result.data.email || '';
            document.getElementById('editUserRole').value = result.data.role || 'user';
            document.getElementById('editUserStatus').value = result.data.status || 'active';
            document.getElementById('editUserPassword').value = ''; // 密码留空

            // 保存当前编辑的用户ID
            document.getElementById('editUserForm').dataset.userId = itemId;

            openModal('editUserModal');
          } else {
            showToast('获取用户详情失败：' + (result.message || '未知错误'), 'error');
          }
        } catch (error) {
          console.error('获取用户详情失败:', error);
          showToast('获取用户详情失败，请稍后重试', 'error');
        }
      } else if (action === 'view-user') {
        // 从后端获取用户详情并显示
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/users?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // 填充详情模态框
            document.getElementById('viewUserId').textContent = '#' + result.data.id;
            document.getElementById('viewUserName').textContent = result.data.username || '';
            document.getElementById('viewUserEmail').textContent = result.data.email || '';
            document.getElementById('viewUserRole').textContent = result.data.role || '普通用户';
            document.getElementById('viewUserStatus').textContent = result.data.status || '正常';
            document.getElementById('viewUserDate').textContent = result.data.created_at || '';
            
            openModal('viewUserModal');
          } else {
            showToast('获取用户详情失败：' + (result.message || '未知错误'), 'error');
          }
        } catch (error) {
          console.error('获取用户详情失败:', error);
          showToast('获取用户详情失败，请稍后重试', 'error');
        }
      } else if (action === 'edit-comment') {
        alert(`编辑评论 #${itemId}`);
      } else if (action === 'view-comment') {
        // 查找评论行并提取数据
        const row = this.closest('tr');
        const cells = row.querySelectorAll('td');
        
        if (cells.length >= 6) {
          // 填充详情模态框
          document.getElementById('viewCommentId').textContent = cells[0].textContent;
          document.getElementById('viewCommentContent').textContent = cells[1].textContent;
          document.getElementById('viewCommentArticle').textContent = cells[2].textContent;
          document.getElementById('viewCommentUser').textContent = cells[3].textContent;
          document.getElementById('viewCommentDate').textContent = cells[4].textContent;
          document.getElementById('viewCommentStatus').textContent = cells[5].textContent.trim();
          
          openModal('viewCommentModal');
        } else {
          alert('查看评论 #${itemId} 的详细信息');
        }
      } else if (action === 'delete-tag') {
        currentAction = action;
        currentItemId = itemId;
        document.getElementById('confirmMessage').textContent = `确定要删除标签 #${itemId} 吗？此操作不可撤销。`;
        openModal('confirmModal');
      } else if (action === 'edit-tag') {
        // 从后端获取标签详情
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/tags?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // 填充编辑表单
            document.getElementById('tagModalTitle').textContent = '编辑标签';
            document.getElementById('tagName').value = result.data.name || '';
            document.getElementById('tagDescription').value = result.data.description || '';
            document.getElementById('tagColor').value = result.data.color || '#007bff';
            document.getElementById('tagCategory').value = result.data.category_id || 0;
            document.getElementById('tagSortOrder').value = result.data.sort_order || 0;
            document.getElementById('tagEnabled').checked = result.data.is_enabled;

            // 保存当前编辑的标签ID
            document.getElementById('tagForm').dataset.tagId = itemId;

            openModal('tagModal');
          } else {
            showToast('获取标签详情失败：' + (result.message || '未知错误'), 'error');
          }
        } catch (error) {
          console.error('获取标签详情失败:', error);
          showToast('获取标签详情失败，请稍后重试', 'error');
        }
      } else if (action === 'edit-category') {
        // 从后端获取分类详情
        try {
          const token = localStorage.getItem('auth_token');
          const headers = {
            'Content-Type': 'application/json'
          };
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(`/api/admin/categories?id=${itemId}`, {
            headers: headers
          });
          const result = await response.json();

          if (result.success && result.data) {
            // 填充编辑表单
            document.getElementById('categoryModalTitle').textContent = '编辑分类';
            document.getElementById('categoryName').value = result.data.name || '';
            document.getElementById('categoryDescription').value = result.data.description || '';
            document.getElementById('categoryIcon').value = result.data.icon || '';
            document.getElementById('categorySortOrder').value = result.data.sort_order || 0;
            document.getElementById('categoryEnabled').checked = result.data.is_enabled;

            // 保存当前编辑的分类ID
            document.getElementById('categoryForm').dataset.categoryId = itemId;

            openModal('categoryModal');
          } else {
            showToast('获取分类详情失败：' + (result.message || '未知错误'), 'error');
          }
        } catch (error) {
          console.error('获取分类详情失败:', error);
          showToast('获取分类详情失败，请稍后重试', 'error');
        }
      }
    });
  });
}

// 导航栏滚动隐藏/显示逻辑
let lastScrollTop = 0;
let isNavHidden = false;
const nav = document.getElementById('mainNav');
const scrollIndicator = document.getElementById('scrollIndicator');
const scrollProgress = document.getElementById('scrollProgress');

// 初始状态 - 在顶部
nav.classList.add('scrolled-top');

// 监听滚动事件
window.addEventListener('scroll', function() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
  const scrollPercent = (scrollTop / scrollHeight) * 100;

  // 更新滚动指示器
  if (scrollTop > 100) {
    scrollIndicator.classList.add('active');
    scrollProgress.style.height = `${scrollPercent}%`;
  } else {
    scrollIndicator.classList.remove('active');
  }

  // 检测滚动方向
  if (scrollTop > lastScrollTop && scrollTop > 50) {
    // 向下滚动且不在顶部 - 隐藏导航栏
    if (!isNavHidden) {
      nav.classList.add('hidden');
      isNavHidden = true;
    }
  } else if (scrollTop < lastScrollTop || scrollTop <= 50) {
    // 向上滚动或接近顶部 - 显示导航栏
    if (isNavHidden) {
      nav.classList.remove('hidden');
      isNavHidden = false;
    }

    // 更新导航栏样式
    if (scrollTop === 0) {
      nav.classList.add('scrolled-top');
      nav.classList.remove('scrolled');
    } else {
      nav.classList.remove('scrolled-top');
      nav.classList.add('scrolled');
    }
  }

  lastScrollTop = scrollTop;
}, { passive: true });

// 页面加载后添加动画
window.addEventListener('load', function() {
  document.body.style.opacity = '0';
  document.body.style.transition = 'opacity 0.5s ease';

  setTimeout(() => {
    document.body.style.opacity = '1';
  }, 100);

  // 初始化空状态
  showEmptyState('articlesTableBody', '暂无文章', 6);
  showEmptyState('usersTableBody', '暂无用户', 7);
  showEmptyState('commentsTableBody', '暂无评论', 6);

  // 从后端获取数据
  fetchAdminData();

  // 加载分类和标签数据
  loadCategoriesAndTags();

  // 为卡片添加延迟动画
  const cards = document.querySelectorAll('.stat-card');
  cards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
    
    setTimeout(() => {
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, 200 + (index * 50));
  });
});

// 鼠标悬停时暂停光标闪烁
const mainTitle = document.getElementById('main-title');
if (mainTitle) {
  mainTitle.addEventListener('mouseenter', function() {
    this.style.animationPlayState = 'paused';
  });
  
  mainTitle.addEventListener('mouseleave', function() {
    this.style.animationPlayState = 'running';
  });
}

// 标签页切换功能
document.querySelectorAll('.tab-btn').forEach(button => {
  button.addEventListener('click', async function() {
    // 移除所有按钮的active类
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });

    // 为当前按钮添加active类
    this.classList.add('active');

    // 隐藏所有标签页
    document.querySelectorAll('.tab-pane').forEach(pane => {
      pane.classList.remove('active');
    });

    // 显示对应的标签页
    const tabId = this.getAttribute('data-tab');
    const targetPane = document.getElementById(tabId);
    if (targetPane) {
      targetPane.classList.add('active');

      // 如果切换到标签管理标签页，加载数据
      if (tabId === 'tags') {
        await loadCategoriesAndTags();
      }

      // 如果切换到统计分析标签页，初始化统计图表
      if (tabId === 'analytics') {
        initAnalytics();
      }

      // 如果切换到附件管理标签页，加载附件列表
      if (tabId === 'attachments') {
        await loadAttachments();
      }
    }
  });
});

// 模态框管理
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.add('closing');
    setTimeout(() => {
      modal.classList.remove('active', 'closing');
      document.body.style.overflow = 'auto';
    }, 300);
  }
}

// 模态框打开/关闭事件
document.querySelectorAll('[data-modal]').forEach(element => {
  if (element.classList.contains('modal-close') || element.hasAttribute('data-modal')) {
    element.addEventListener('click', function() {
      const modalId = this.getAttribute('data-modal');
      closeModal(modalId);
    });
  }
});

// 打开上传文章模态框
document.getElementById('uploadArticleBtn').addEventListener('click', async () => {
  // 加载标签选择器
  await populateTagSelectorForUpload();
  // 加载分类选择器
  await populateCategorySelectorForUpload();
  openModal('uploadModal');
});

// 打开新建文章模态框
document.getElementById('newArticleBtn').addEventListener('click', async () => {
  // 加载标签选择器
  await populateTagSelectorForNewArticle();
  // 加载分类选择器
  await populateCategorySelectorForNewArticle();
  openModal('articleModal');
});

// 打开添加用户模态框
document.getElementById('addUserBtn').addEventListener('click', () => {
  openModal('userModal');
});

// 标签选择功能
document.querySelectorAll('.tag-option').forEach(tag => {
  tag.addEventListener('click', function() {
    this.classList.toggle('selected');
  });
});

// 添加标签功能（上传文章模态框）
document.getElementById('addUploadTagBtn').addEventListener('click', function() {
  const tagInput = document.getElementById('uploadTagInput');
  const tagText = tagInput.value.trim();

  if (tagText) {
    const tagSelector = document.getElementById('uploadTagSelector');
    const newTag = document.createElement('div');
    newTag.className = 'tag-option selected';
    newTag.dataset.tagName = tagText;
    newTag.textContent = tagText;
    newTag.addEventListener('click', function() {
      this.classList.toggle('selected');
    });

    tagSelector.appendChild(newTag);
    tagInput.value = '';
  }
});

// 文件上传功能
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const uploadPreview = document.getElementById('uploadPreview');

// 存储选中的文件
let selectedFiles = [];

uploadArea.addEventListener('click', () => {
  fileInput.click();
});

uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const files = e.dataTransfer.files;
  handleFiles(files);
});

fileInput.addEventListener('change', () => {
  const files = fileInput.files;
  handleFiles(files);
});

function handleFiles(files) {
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    
    // 检查文件大小（最大10MB）
    if (file.size > 10 * 1024 * 1024) {
      showToast(`文件 ${file.name} 超过10MB限制`, 'error');
      continue;
    }
    
    // 添加到选中的文件列表
    selectedFiles.push(file);
    
    // 创建预览项
    const reader = new FileReader();
    reader.onload = function(e) {
      const uploadItem = document.createElement('div');
      uploadItem.className = 'upload-item';
      uploadItem.dataset.fileIndex = selectedFiles.length - 1; // 存储文件索引
      
      // 判断文件类型
      if (file.type.startsWith('image/')) {
        uploadItem.innerHTML = `
          <img src="${e.target.result}" alt="${file.name}">
          <button class="upload-remove">×</button>
        `;
      } else {
        const fileType = file.name.split('.').pop().toUpperCase();
        uploadItem.innerHTML = `
          <div style="background:#f0f0f0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#666;">
            <div style="font-size:2em;">📄</div>
            <div style="font-size:0.8em; margin-top:5px; text-align:center; padding:0 5px;">${fileType}</div>
          </div>
          <button class="upload-remove">×</button>
        `;
      }
      
      // 添加删除功能
      const removeBtn = uploadItem.querySelector('.upload-remove');
      removeBtn.addEventListener('click', function() {
        const index = parseInt(uploadItem.dataset.fileIndex);
        selectedFiles.splice(index, 1); // 从数组中移除
        uploadItem.remove();
      });
      
      uploadPreview.appendChild(uploadItem);
    };
    
    reader.readAsDataURL(file);
  }
}

// 表单提交
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const title = document.getElementById('uploadTitle').value;
  if (!title) {
    showToast('请输入文章标题', 'warning');
    return;
  }
  
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '上传中...';
  submitBtn.disabled = true;
  
  try {
    // 获取文件和文章内容
    const files = selectedFiles;
    const content = document.getElementById('uploadContent').value.trim();

    // 检查是否至少提供了一种方式
    if (files.length === 0 && !content) {
      showToast('请选择要上传的文件或输入文章内容', 'warning');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      return;
    }

    let result;

    // 如果有文件上传,先上传文件
    if (files.length > 0) {
      // 创建FormData
      const formData = new FormData();
      formData.append('file', files[0]);

      // 添加日期参数
      const year = document.getElementById('uploadYear').value;
      const month = document.getElementById('uploadMonth').value;
      const day = document.getElementById('uploadDay').value;

      if (year) formData.append('year', year);
      if (month) formData.append('month', month);
      if (day) formData.append('day', day);

      // 发送上传请求
      const token = localStorage.getItem('auth_token');
      const headers = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const uploadResponse = await fetch('/api/upload', {
        method: 'POST',
        headers: headers,
        body: formData
      });

      // 检查HTTP状态码
      if (!uploadResponse.ok) {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;

        // 尝试解析错误信息
        let errorMessage = '上传失败：';
        try {
          const uploadResult = await uploadResponse.json();
          const errorCode = uploadResult.code || 'UNKNOWN_ERROR';

          // 根据HTTP状态码和错误码显示提示
          switch (uploadResponse.status) {
            case 405:
              errorMessage += '请求方法不允许，请刷新页面重试';
              break;
            case 400:
              switch (errorCode) {
                case 'PARSE_FORM_FAILED':
                  errorMessage += '表单解析失败，请重试';
                  break;
                case 'NO_FILE_PROVIDED':
                  errorMessage += '未选择文件，请选择要上传的文件';
                  break;
                default:
                  errorMessage += uploadResult.message || '请求参数错误';
              }
              break;
            case 413:
              errorMessage += '文件过大，请确保文件不超过10MB';
              break;
            case 415:
              errorMessage += '不支持的文件类型，仅支持 .md, .jpg, .jpeg, .png, .gif, .webp, .bmp, .svg 文件';
              break;
            case 500:
              switch (errorCode) {
                case 'FILE_SAVE_FAILED':
                  errorMessage += '文件保存失败，请检查服务器权限或联系管理员';
                  break;
                default:
                  errorMessage += '服务器内部错误，请稍后重试';
              }
              break;
            default:
              errorMessage += uploadResult.message || `服务器返回错误 (${uploadResponse.status})`;
          }
        } catch (e) {
          errorMessage += `服务器返回错误 (${uploadResponse.status})，请稍后重试`;
        }

        showToast(errorMessage, 'error');
        return;
      }

      result = await uploadResponse.json();

      if (!result.success) {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        showToast('上传失败：' + (result.message || '未知错误'), 'error');
        return;
      }
    } else {
      // 直接使用输入的内容创建文章
      result = {
        success: true,
        data: {
          content: content,
          is_markdown: true
        }
      };
    }

    // 获取表单数据
    const title = document.getElementById('uploadTitle').value;
    const author = document.getElementById('uploadAuthor').value;
    const category = document.getElementById('uploadCategory').value;
    const status = document.getElementById('uploadStatus').value;

    // 获取选中的标签
    const selectedTags = [];
    document.querySelectorAll('#uploadTagSelector .tag-option.selected').forEach(option => {
      selectedTags.push(option.dataset.tagName);
    });

    // 获取文章内容
    let articleContent = '';
    if (result.data && result.data.content) {
      articleContent = result.data.content;
    }

    // 创建文章
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const createResponse = await fetch('/api/admin/passages', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({
        title: title,
        content: articleContent,
        author: author,
        category: category,
        tags: selectedTags.join(','),
        status: status
      })
    });

    const createResult = await createResponse.json();

    if (createResult.success) {
      submitBtn.textContent = '创建成功!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('uploadModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
        this.reset();

        // 清空预览和文件列表
        uploadPreview.innerHTML = '';
        selectedFiles = [];

        // 刷新文章列表
        fetchAdminData();

        showToast('文章创建成功！', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('创建失败：' + (createResult.message || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('创建文章失败:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('创建失败，无法连接到服务器，请检查网络连接后重试', 'error');
  }
});

document.getElementById('articleForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const title = document.getElementById('articleTitle').value;
  if (!title) {
    showToast('请输入文章标题', 'warning');
    return;
  }

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '保存中...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/admin/passages', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({
        title: title,
        content: document.getElementById('articleContent').value,
        author: document.getElementById('articleAuthor').value,
        category: document.getElementById('articleCategory').value,
        tags: document.getElementById('articleTags').value,
      })
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '保存成功!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('articleModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
        this.reset();

        // 刷新文章列表
        fetchAdminData();

        showToast('文章创建成功！', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('保存失败：' + (result.message || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存文章失败:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('保存失败，请稍后重试', 'error');
  }
});

document.getElementById('editForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const articleId = this.dataset.articleId;
  if (!articleId) {
    showToast('无法确定要编辑的文章', 'error');
    return;
  }

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '保存中...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // 获取定时发布时间
    const isScheduled = document.getElementById('editIsScheduled').checked;
    let publishedAt = null;
    if (isScheduled) {
      const publishedAtInput = document.getElementById('editPublishedAt').value;
      if (publishedAtInput) {
        // 将 datetime-local 格式转换为 ISO 8601 格式
        publishedAt = new Date(publishedAtInput).toISOString();
      }
    }

    const response = await fetch(`/api/admin/passages?id=${articleId}`, {
      method: 'PUT',
      headers: headers,
      body: JSON.stringify({
        title: document.getElementById('editTitle').value,
        content: document.getElementById('editContent').value,
        author: document.getElementById('editAuthor').value,
        category: document.getElementById('editCategory').value,
        show_title: document.getElementById('editShowTitle').checked,
        tags: document.getElementById('editTags').value,
        status: document.getElementById('editStatus').value,
        visibility: document.getElementById('editVisibility').value,
        is_scheduled: isScheduled,
        published_at: publishedAt
      })
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '保存成功!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('editModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

        // 刷新文章列表
        fetchAdminData();

        showToast('文章修改已保存！', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('保存失败：' + (result.message || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存文章失败:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('保存失败，请稍后重试', 'error');
  }
});

// 定时发布复选框事件监听器
document.getElementById('editIsScheduled').addEventListener('change', function(e) {
  const publishedAtGroup = document.getElementById('editPublishedAtGroup');
  const publishedAtInput = document.getElementById('editPublishedAt');

  if (e.target.checked) {
    // 显示发布时间输入框
    publishedAtGroup.style.display = 'block';

    // 如果没有设置时间，默认设置为明天同一时间
    if (!publishedAtInput.value) {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const localDateTime = new Date(tomorrow.getTime() - tomorrow.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
      publishedAtInput.value = localDateTime;
    }
  } else {
    // 隐藏发布时间输入框
    publishedAtGroup.style.display = 'none';
    publishedAtInput.value = '';
  }
});

document.getElementById('userForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '创建中...';
  submitBtn.disabled = true;

  setTimeout(() => {
    submitBtn.textContent = '创建成功!';
    submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

    setTimeout(() => {
      closeModal('userModal');
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
      this.reset();
      showToast('用户创建成功！', 'success');
    }, 2000);
  }, 1500);
});

// 编辑用户表单提交
document.getElementById('editUserForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const userId = this.dataset.userId;
  if (!userId) {
    showToast('无法确定要编辑的用户', 'error');
    return;
  }

  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '保存中...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // 构建更新数据
    const updates = {
      username: document.getElementById('editUserName').value,
      email: document.getElementById('editUserEmail').value,
      role: document.getElementById('editUserRole').value,
      status: document.getElementById('editUserStatus').value,
    };

    // 只有当密码不为空时才更新密码
    const password = document.getElementById('editUserPassword').value;
    if (password) {
      updates.password = password;
    }

    const response = await fetch(`/api/admin/users?id=${userId}`, {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(updates)
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '保存成功!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('editUserModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

        // 刷新用户列表
        fetchAdminData();

        showToast('用户修改已保存！', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('保存失败：' + (result.message || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存用户失败:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('保存失败，请稍后重试', 'error');
  }
});

// 分类表单提交
document.getElementById('categoryForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const categoryId = this.dataset.categoryId;
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '保存中...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const categoryData = {
      name: document.getElementById('categoryName').value,
      description: document.getElementById('categoryDescription').value,
      icon: document.getElementById('categoryIcon').value,
      sort_order: parseInt(document.getElementById('categorySortOrder').value) || 0,
      is_enabled: document.getElementById('categoryEnabled').checked,
    };

    let url = '/api/admin/categories';
    let method = 'POST';

    if (categoryId) {
      url += `?id=${categoryId}`;
      method = 'PUT';
    }

    const response = await fetch(url, {
      method: method,
      headers: headers,
      body: JSON.stringify(categoryData)
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '保存成功!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('categoryModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
        this.reset();
        delete this.dataset.categoryId;

        // 刷新分类和标签列表
        loadCategoriesAndTags();

        showToast(categoryId ? '分类修改已保存！' : '分类创建成功！', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('保存失败：' + (result.message || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存分类失败:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('保存失败，请稍后重试', 'error');
  }
});

// 标签表单提交
document.getElementById('tagForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const tagId = this.dataset.tagId;
  const submitBtn = this.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '保存中...';
  submitBtn.disabled = true;

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const tagData = {
      name: document.getElementById('tagName').value,
      description: document.getElementById('tagDescription').value,
      color: document.getElementById('tagColor').value,
      category_id: parseInt(document.getElementById('tagCategory').value) || 0,
      sort_order: parseInt(document.getElementById('tagSortOrder').value) || 0,
      is_enabled: document.getElementById('tagEnabled').checked,
    };

    let url = '/api/admin/tags';
    let method = 'POST';

    if (tagId) {
      url += `?id=${tagId}`;
      method = 'PUT';
    }

    const response = await fetch(url, {
      method: method,
      headers: headers,
      body: JSON.stringify(tagData)
    });

    const result = await response.json();

    if (result.success) {
      submitBtn.textContent = '保存成功!';
      submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';

      setTimeout(() => {
        closeModal('tagModal');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.background = 'rgba(255, 183, 122, 0.8)';
        this.reset();
        delete this.dataset.tagId;

        // 刷新标签列表
        loadCategoriesAndTags();

        showToast(tagId ? '标签修改已保存！' : '标签创建成功！', 'success');
      }, 2000);
    } else {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast('保存失败：' + (result.message || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存标签失败:', error);
    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
    showToast('保存失败，请稍后重试', 'error');
  }
});

// 操作按钮功能
let currentAction = null;
let currentItemId = null;

// 按钮事件绑定在 bindActionButtons 函数中处理

// 确认操作
document.getElementById('confirmAction').addEventListener('click', async function() {
  if (currentAction && currentItemId) {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    try {
      let apiUrl = '';
      if (currentAction === 'delete') {
        apiUrl = `/api/admin/passages?id=${currentItemId}`;
      } else if (currentAction === 'delete-comment') {
        apiUrl = `/api/admin/comments?id=${currentItemId}`;
      } else if (currentAction === 'delete-user') {
        apiUrl = `/api/admin/users?id=${currentItemId}`;
      } else if (currentAction === 'delete-category') {
        apiUrl = `/api/admin/categories?id=${currentItemId}`;
      } else if (currentAction === 'delete-tag') {
        apiUrl = `/api/admin/tags?id=${currentItemId}`;
      } else if (currentAction === 'delete-main-card') {
        apiUrl = `/api/about/main-cards/delete?id=${currentItemId}`;
      } else if (currentAction === 'delete-sub-card') {
        apiUrl = `/api/about/sub-cards/delete?id=${currentItemId}`;
      }

      const response = await fetch(apiUrl, {
        method: 'DELETE',
        headers: headers
      });

      const result = await response.json();

      if (result.success) {
        const row = document.querySelector(`button[data-action="${currentAction}"][data-id="${currentItemId}"]`).closest('tr');
        if (row) {
          row.style.opacity = '0.5';
          row.style.transition = 'opacity 0.3s ease';

          setTimeout(() => {
            row.remove();
          }, 300);
        }
        closeModal('confirmModal');
        showToast('删除成功！', 'success');
        // 刷新数据
        if (currentAction === 'delete-category' || currentAction === 'delete-tag') {
          loadCategoriesAndTags();
        } else if (currentAction === 'delete-main-card') {
          loadMainCards();
          loadSubCards();
        } else if (currentAction === 'delete-sub-card') {
          loadSubCards();
        } else {
          fetchAdminData();
        }
      } else {
        showToast('删除失败：' + (result.message || '未知错误'), 'error');
      }
    } catch (error) {
      console.error('删除失败:', error);
      alert('删除失败，请稍后重试');
    }
  }
});

// 点击模态框外部关闭
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', function(e) {
    if (e.target === this) {
      const modalId = this.id;
      closeModal(modalId);
    }
  });
});

// ESC键关闭模态框
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(modal => {
      const modalId = modal.id;
      closeModal(modalId);
    });
  }
});
</script>

<!-- 登录模态框 -->
<div class="modal" id="loginModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>用户登录</h3>
      <button class="modal-close" data-modal="loginModal">×</button>
    </div>
    <div class="modal-body">
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">用户名</label>
          <input type="text" id="loginUsername" class="form-control" placeholder="请输入用户名" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="loginPassword">密码</label>
          <input type="password" id="loginPassword" class="form-control" placeholder="请输入密码" required autocomplete="current-password">
        </div>
        <div class="form-group" id="loginError" style="display: none; color: #e74c3c; font-size: 0.9em;"></div>
        <button type="submit" id="loginSubmitBtn" class="btn-primary" style="width: 100%;">登录</button>
      </form>
      <div style="margin-top: 20px; text-align: center; font-size: 0.9em;">
        <a href="#" id="openRegisterModal" style="color: #007bff; text-decoration: none;">还没有账号？立即注册</a>
      </div>
    </div>
  </div>
</div>

<!-- 注册模态框 -->
<div class="modal" id="registerModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>用户注册</h3>
      <button class="modal-close" data-modal="registerModal">×</button>
    </div>
    <div class="modal-body">
      <form id="registerForm">
        <div class="form-group">
          <label for="registerUsername">用户名</label>
          <input type="text" id="registerUsername" class="form-control" placeholder="请输入用户名（3-20个字符，字母数字下划线）" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="registerEmail">邮箱</label>
          <input type="email" id="registerEmail" class="form-control" placeholder="请输入邮箱" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="registerPassword">密码</label>
          <input type="password" id="registerPassword" class="form-control" placeholder="请输入密码（至少6个字符）" required autocomplete="new-password">
        </div>
        <div class="form-group" id="registerError" style="display: none; color: #e74c3c; font-size: 0.9em;"></div>
        <button type="submit" id="registerSubmitBtn" class="btn-primary" style="width: 100%;">注册</button>
      </form>
      <div style="margin-top: 20px; text-align: center; font-size: 0.9em;">
        <a href="#" id="openLoginModal" style="color: #007bff; text-decoration: none;">已有账号？立即登录</a>
      </div>
    </div>
  </div>
</div>

<!-- 模态框样式 -->
<style>
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  max-width: 500px;
  width: 100%;
  animation: slideIn 0.3s ease;
  position: relative;
}

.modal-content::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  height: 3px;
  background: linear-gradient(90deg, #007bff, #00b894);
  width: 0%;
  transition: width 3s linear;
}

.modal.active .modal-content::after {
  width: 100%;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  background: rgba(0, 123, 255, 0.1);
  backdrop-filter: blur(40px) saturate(200%);
  -webkit-backdrop-filter: blur(40px) saturate(200%);
  border: 1px solid rgba(255, 255, 255, 0.5);
  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
  padding: 20px 30px;
  color: #007bff;
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 1.5em;
  font-weight: 600;
}

.modal-close {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.5em;
  cursor: pointer;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: rotate(90deg);
}

.modal-body {
  padding: 30px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  font-size: 1em;
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  color: rgba(255, 255, 255, 0.9);
  transition: all 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: rgba(255, 255, 255, 0.5);
  background: rgba(0, 0, 0, 0);
}

.btn-primary {
  background: rgba(0, 0, 0, 0);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: rgba(255, 255, 255, 0.9);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-primary:disabled:hover {
  background: rgba(0, 0, 0, 0);
  border-color: rgba(255, 255, 255, 0.3);
  transform: none;
}

.btn-danger {
  background: rgba(231, 76, 60, 0.2);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(231, 76, 60, 0.4);
  color: rgba(255, 255, 255, 0.95);
  padding: 12px 30px;
  border-radius: 8px;
  font-size: 1em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
}

.btn-danger:hover {
  background: rgba(231, 76, 60, 0.35);
  border-color: rgba(231, 76, 60, 0.6);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
}

.btn-danger:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
}

.btn-danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-danger:disabled:hover {
  background: rgba(231, 76, 60, 0.2);
  border-color: rgba(231, 76, 60, 0.4);
  transform: none;
  box-shadow: none;
}
</style>

<script>
// 设置相关功能
let originalAppearanceSettings = {};

// 加载设置
async function loadSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/appearance', {
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();

      // 保存原始设置值
      originalAppearanceSettings = { ...settings };

      // 填充表单
      document.getElementById('backgroundImage').value = settings.background_image || '/img/test.png';
      document.getElementById('globalOpacity').value = settings.global_opacity || '0.15';
      document.getElementById('opacityValue').textContent = settings.global_opacity || '0.15';
      document.getElementById('backgroundSize').value = settings.background_size || 'cover';
      document.getElementById('backgroundPosition').value = settings.background_position || 'center';
      document.getElementById('backgroundRepeat').value = settings.background_repeat || 'no-repeat';
      document.getElementById('backgroundAttachment').value = settings.background_attachment || 'fixed';
      document.getElementById('blurAmount').value = settings.blur_amount || '20px';
      document.getElementById('saturateAmount').value = settings.saturate_amount || '180%';
      document.getElementById('darkModeEnabled').checked = settings.dark_mode_enabled || false;
      document.getElementById('navbarGlassColor').value = settings.navbar_glass_color || 'rgba(255, 255, 255, 0.85)';
      document.getElementById('navbarTextColor').value = settings.navbar_text_color || '#333333';
      document.getElementById('cardGlassColor').value = settings.card_glass_color || 'rgba(255, 255, 255, 0.75)';
      document.getElementById('footerGlassColor').value = settings.footer_glass_color || 'rgba(255, 255, 255, 0.9)';

      // 更新颜色选择器
      updateColorPickers();

      // 应用暗色模式
      applyDarkMode(settings.dark_mode_enabled || false);

      // 应用毛玻璃颜色
      applyGlassColors(settings.navbar_glass_color, settings.card_glass_color, settings.footer_glass_color);

      // 更新预览
      updatePreview();
    } else {
      console.error('加载设置失败:', response.statusText);
    }
  } catch (error) {
    console.error('加载设置失败:', error);
  }
}

// 保存设置
async function saveSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // 获取当前表单值
    const currentSettings = {
      background_image: document.getElementById('backgroundImage').value,
      global_opacity: document.getElementById('globalOpacity').value,
      background_size: document.getElementById('backgroundSize').value,
      background_position: document.getElementById('backgroundPosition').value,
      background_repeat: document.getElementById('backgroundRepeat').value,
      background_attachment: document.getElementById('backgroundAttachment').value,
      blur_amount: document.getElementById('blurAmount').value,
      saturate_amount: document.getElementById('saturateAmount').value,
      dark_mode_enabled: document.getElementById('darkModeEnabled').checked,
      navbar_glass_color: document.getElementById('navbarGlassColor').value,
      navbar_text_color: document.getElementById('navbarTextColor').value,
      card_glass_color: document.getElementById('cardGlassColor').value,
      footer_glass_color: document.getElementById('footerGlassColor').value
    };

    // 只发送发生变化的字段
    const changedSettings = {};
    for (const key in currentSettings) {
      const originalValue = originalAppearanceSettings[key];
      const currentValue = currentSettings[key];

      // 调试每个字段的比对
      if (key === 'navbar_text_color') {
        console.log('navbar_text_color 比对:');
        console.log('  原始值:', originalValue, '(类型:', typeof originalValue, ')');
        console.log('  当前值:', currentValue, '(类型:', typeof currentValue, ')');
        console.log('  是否相等:', currentValue === originalValue);
      }

      if (currentValue !== originalValue) {
        changedSettings[key] = currentValue;
      }
    }

    // 调试信息
    console.log('原始设置:', originalAppearanceSettings);
    console.log('当前设置:', currentSettings);
    console.log('变更设置:', changedSettings);

    // 如果没有变化，提示用户
    if (Object.keys(changedSettings).length === 0) {
      showToast('没有检测到任何变化', 'warning');
      return;
    }

    console.log('发送变更的外观字段:', changedSettings);

    const response = await fetch('/api/settings/appearance', {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(changedSettings)
    });

    if (response.ok) {
      showToast('设置保存成功！', 'success');
      // 更新原始设置值
      Object.assign(originalAppearanceSettings, changedSettings);

      // 如果暗色模式设置有变化，应用新设置
      if ('dark_mode_enabled' in changedSettings) {
        applyDarkMode(changedSettings.dark_mode_enabled);
      }

      updatePreview();
    } else {
      const result = await response.json();
      showToast('保存失败：' + (result.error || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存设置失败:', error);
    showToast('保存失败，请稍后重试', 'error');
  }
}

// 重置设置
function resetSettings() {
  if (confirm('确定要重置为默认设置吗？')) {
    document.getElementById('backgroundImage').value = '/img/test.png';
    document.getElementById('globalOpacity').value = '0.15';
    document.getElementById('opacityValue').textContent = '0.15';
    document.getElementById('backgroundSize').value = 'cover';
    document.getElementById('backgroundPosition').value = 'center';
    document.getElementById('backgroundRepeat').value = 'no-repeat';
    document.getElementById('backgroundAttachment').value = 'fixed';
    document.getElementById('blurAmount').value = '20px';
    document.getElementById('saturateAmount').value = '180%';
    document.getElementById('darkModeEnabled').checked = false;
    document.getElementById('navbarGlassColor').value = 'rgba(255, 255, 255, 0.85)';
    document.getElementById('navbarTextColor').value = '#333333';
    document.getElementById('cardGlassColor').value = 'rgba(255, 255, 255, 0.75)';
    document.getElementById('footerGlassColor').value = 'rgba(255, 255, 255, 0.9)';
    updateColorPickers();
    applyDarkMode(false);
    applyGlassColors('rgba(255, 255, 255, 0.85)', 'rgba(255, 255, 255, 0.75)', 'rgba(255, 255, 255, 0.9)');
    updatePreview();
  }
}

// 更新预览
function updatePreview() {
  const previewBox = document.getElementById('previewBox');
  if (!previewBox) return;

  const backgroundImage = document.getElementById('backgroundImage').value;
  const globalOpacity = document.getElementById('globalOpacity').value;
  const backgroundSize = document.getElementById('backgroundSize').value;
  const backgroundPosition = document.getElementById('backgroundPosition').value;
  const backgroundRepeat = document.getElementById('backgroundRepeat').value;
  const backgroundAttachment = document.getElementById('backgroundAttachment').value;
  const blurAmount = document.getElementById('blurAmount').value;
  const saturateAmount = document.getElementById('saturateAmount').value;

  // 更新预览框的样式
  previewBox.style.backgroundImage = `url('${backgroundImage}')`;
  previewBox.style.backgroundSize = backgroundSize;
  previewBox.style.backgroundPosition = backgroundPosition;
  previewBox.style.backgroundRepeat = backgroundRepeat;
  previewBox.style.backgroundAttachment = backgroundAttachment;

  // 更新::before伪元素的样式（通过CSS变量）
  previewBox.style.setProperty('--blur-amount', blurAmount);
  previewBox.style.setProperty('--saturate-amount', saturateAmount);
  previewBox.style.setProperty('--global-opacity', globalOpacity);

  // 更新预览框的背景层
  const beforeElement = document.createElement('style');
  beforeElement.textContent = `
    #previewBox::before {
      background-image: url('${backgroundImage}') !important;
      background-size: ${backgroundSize} !important;
      background-position: ${backgroundPosition} !important;
      background-repeat: ${backgroundRepeat} !important;
      background-attachment: ${backgroundAttachment} !important;
      filter: blur(${blurAmount}) saturate(${saturateAmount}) !important;
    }
    #previewBox {
      background: rgba(255, 255, 255, ${globalOpacity}) !important;
      backdrop-filter: blur(${blurAmount}) saturate(${saturateAmount}) !important;
      -webkit-backdrop-filter: blur(${blurAmount}) saturate(${saturateAmount}) !important;
    }
  `;

  // 移除旧的样式
  const oldStyle = document.getElementById('preview-style');
  if (oldStyle) {
    oldStyle.remove();
  }

  beforeElement.id = 'preview-style';
  document.head.appendChild(beforeElement);
}

// 应用暗色模式
function applyDarkMode(enabled) {
  if (enabled) {
    document.documentElement.classList.add('dark-mode');
  } else {
    document.documentElement.classList.remove('dark-mode');
  }
}

// 更新颜色选择器
function updateColorPickers() {
  const navbarColor = document.getElementById('navbarGlassColor').value;
  const navbarTextColor = document.getElementById('navbarTextColor').value;
  const cardColor = document.getElementById('cardGlassColor').value;
  const footerColor = document.getElementById('footerGlassColor').value;

  // 解析 rgba 并更新颜色选择器
  if (navbarColor.startsWith('rgba')) {
    const rgba = parseRgba(navbarColor);
    if (rgba) {
      document.getElementById('navbarGlassColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
    }
  }

  // 更新导航栏文字颜色选择器（支持 hex 和 rgb 格式）
  if (navbarTextColor.startsWith('#')) {
    document.getElementById('navbarTextColorPicker').value = navbarTextColor;
  } else if (navbarTextColor.startsWith('rgb')) {
    const rgb = parseRgba(navbarTextColor);
    if (rgb) {
      document.getElementById('navbarTextColorPicker').value = rgbaToHex(rgb.r, rgb.g, rgb.b);
    }
  }

  if (cardColor.startsWith('rgba')) {
    const rgba = parseRgba(cardColor);
    if (rgba) {
      document.getElementById('cardGlassColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
    }
  }

  if (footerColor.startsWith('rgba')) {
    const rgba = parseRgba(footerColor);
    if (rgba) {
      document.getElementById('footerGlassColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
    }
  }
}

// 应用毛玻璃颜色
function applyGlassColors(navbarColor, cardColor, footerColor) {
  // 设置 CSS 变量
  document.documentElement.style.setProperty('--navbar-glass-color', navbarColor);
  document.documentElement.style.setProperty('--card-glass-color', cardColor);
  document.documentElement.style.setProperty('--footer-glass-color', footerColor);
}

// 解析 rgba 字符串
function parseRgba(rgbaStr) {
  const match = rgbaStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
  if (match) {
    return {
      r: parseInt(match[1]),
      g: parseInt(match[2]),
      b: parseInt(match[3]),
      a: match[4] ? parseFloat(match[4]) : 1
    };
  }
  return null;
}

// 将 RGB 转换为 Hex
function rgbaToHex(r, g, b) {
  const toHex = (n) => {
    const hex = n.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  };
  return '#' + toHex(r) + toHex(g) + toHex(b);
}

// 透明度滑块变化事件

document.addEventListener('DOMContentLoaded', async function() {

  // 页面加载时自动加载设置

  await loadSettings();

  await loadTemplateSettings();

  await loadMusicSettings();

  await loadMusicPlaylist();

  const opacitySlider = document.getElementById('globalOpacity');

  const opacityValue = document.getElementById('opacityValue');

  if (opacitySlider && opacityValue) {
    opacitySlider.addEventListener('input', function() {
      opacityValue.textContent = this.value;
      updatePreview();
    });
  }

  // 保存外观设置按钮
  const saveBtn = document.getElementById('saveSettingsBtn');
  if (saveBtn) {
    saveBtn.addEventListener('click', saveSettings);
  }

  // 保存模板设置按钮
  const saveTemplateBtn = document.getElementById('saveTemplateSettingsBtn');
  if (saveTemplateBtn) {
    saveTemplateBtn.addEventListener('click', saveTemplateSettings);
  }

  // 保存音乐设置按钮
  const saveMusicSettingsBtn = document.getElementById('saveMusicSettingsBtn');
  if (saveMusicSettingsBtn) {
    saveMusicSettingsBtn.addEventListener('click', saveMusicSettings);
  }

  // 初始化音乐拖拽上传功能
  initMusicDragDrop();

  // 音乐播放器颜色选择器
  const musicPlayerColorPicker = document.getElementById('musicPlayerColorPicker');
  const musicPlayerColorInput = document.getElementById('musicPlayerColor');
  if (musicPlayerColorPicker && musicPlayerColorInput) {
    musicPlayerColorPicker.addEventListener('input', function() {
      const currentRgba = musicPlayerColorInput.value;
      const rgba = parseRgba(currentRgba);
      if (rgba) {
        const newRgba = `rgba(${this.value.match(/\w\w/g).map(x => parseInt(x, 16)).join(', ')}, ${rgba.a})`;
        musicPlayerColorInput.value = newRgba;
      }
    });
  }

  // Live2D 启用/禁用切换
  const live2dEnabled = document.getElementById('live2dEnabled');
  const live2dConfig = document.getElementById('live2dConfig');
  if (live2dEnabled && live2dConfig) {
    live2dEnabled.addEventListener('change', function() {
      live2dConfig.style.display = this.checked ? 'block' : 'none';
    });
  }

  // 重置设置按钮
  const resetBtn = document.getElementById('resetSettingsBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', resetSettings);
  }

  // 颜色选择器事件监听
  const colorPickers = [
    { picker: 'navbarGlassColorPicker', input: 'navbarGlassColor' },
    { picker: 'navbarTextColorPicker', input: 'navbarTextColor' },
    { picker: 'cardGlassColorPicker', input: 'cardGlassColor' },
    { picker: 'footerGlassColorPicker', input: 'footerGlassColor' }
  ];

  colorPickers.forEach(({ picker, input }) => {
    const pickerEl = document.getElementById(picker);
    const inputEl = document.getElementById(input);

    if (pickerEl && inputEl) {
      pickerEl.addEventListener('input', function() {
        // 获取当前 rgba 值
        const currentRgba = inputEl.value;
        const rgba = parseRgba(currentRgba);

        if (rgba) {
          // 保持透明度，只更新颜色
          const newRgba = `rgba(${this.value.match(/\w\w/g).map(x => parseInt(x, 16)).join(', ')}, ${rgba.a})`;
          inputEl.value = newRgba;
        }
      });

      inputEl.addEventListener('input', function() {
        updateColorPickers();
      });
    }
  });

  // 监听所有设置输入的变化，实时更新预览
  const settingInputs = [
    'backgroundImage', 'backgroundSize', 'backgroundPosition',
    'backgroundRepeat', 'backgroundAttachment', 'blurAmount', 'saturateAmount'
  ];

  settingInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', updatePreview);
      input.addEventListener('change', updatePreview);
    }
  });

  // 当切换到设置标签页时加载设置
  const settingsTab = document.querySelector('[data-tab="settings"]');
  if (settingsTab) {
    settingsTab.addEventListener('click', function() {
      loadSettings();
      loadTemplateSettings();
    });
  }
});

// 存储原始模板设置值，用于比对差异
let originalTemplateSettings = {};

// 加载模板设置
async function loadTemplateSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/template', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();

      // 保存原始设置值
      originalTemplateSettings = { ...settings };

      // 填充表单
      document.getElementById('templateName').value = settings.name || '';
      document.getElementById('templateGreting').value = settings.greting || '';
      document.getElementById('templateYear').value = settings.year || '';
      document.getElementById('templateFoodes').value = settings.foodes || '';
      document.getElementById('globalAvatar').value = settings.global_avatar || '/img/avatar.png';

      // 填充文章标题设置
      document.getElementById('templateArticleTitle').checked = settings.article_title || false;
      document.getElementById('templateArticleTitlePrefix').value = settings.article_title_prefix || '';

      // 填充切换界面提示设置
      document.getElementById('templateSwitchNotice').checked = settings.switch_notice || false;
      document.getElementById('templateSwitchNoticeText').value = settings.switch_notice_text || '';

      // 填充外部链接设置
      document.getElementById('externalLinkWarning').checked = settings.external_link_warning || false;
      document.getElementById('externalLinkWhitelist').value = settings.external_link_whitelist || '';
      document.getElementById('externalLinkWarningText').value = settings.external_link_warning_text || '';

      // 填充 Live2D 设置
      document.getElementById('live2dEnabled').checked = settings.live2d_enabled || false;
      document.getElementById('live2dShowOnIndex').checked = settings.live2d_show_on_index !== false;
      document.getElementById('live2dShowOnPassage').checked = settings.live2d_show_on_passage !== false;
      document.getElementById('live2dShowOnCollect').checked = settings.live2d_show_on_collect !== false;
      document.getElementById('live2dShowOnAbout').checked = settings.live2d_show_on_about !== false;
      document.getElementById('live2dShowOnAdmin').checked = settings.live2d_show_on_admin || false;
      document.getElementById('live2dModelId').value = settings.live2d_model_id || '1';
      document.getElementById('live2dModelPath').value = settings.live2d_model_path || '';
      document.getElementById('live2dCDNPath').value = settings.live2d_cdn_path || 'https://unpkg.com/live2d-widget-model@1.0.5/';
      document.getElementById('live2dPosition').value = settings.live2d_position || 'right';
      document.getElementById('live2dWidth').value = settings.live2d_width || '280px';
      document.getElementById('live2dHeight').value = settings.live2d_height || '250px';

      // 显示/隐藏 Live2D 详细配置
      const live2dConfig = document.getElementById('live2dConfig');
      live2dConfig.style.display = settings.live2d_enabled ? 'block' : 'none';

      // 填充赞助设置
      document.getElementById('sponsorEnabled').checked = settings.sponsor_enabled || false;
      document.getElementById('sponsorTitle').value = settings.sponsor_title || '感谢您的支持';
      document.getElementById('sponsorImage').value = settings.sponsor_image || '/img/avatar.png';
      document.getElementById('sponsorDescription').value = settings.sponsor_description || '如果您觉得这个博客对您有帮助，欢迎赞助支持！';
      document.getElementById('sponsorButtonText').value = settings.sponsor_button_text || '❤️ 赞助支持';
    } else {
      console.error('加载模板设置失败');
    }
  } catch (error) {
    console.error('加载模板设置失败:', error);
  }
}

// 保存模板设置
async function saveTemplateSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // 获取当前表单值
    const currentSettings = {
      name: document.getElementById('templateName').value,
      greting: document.getElementById('templateGreting').value,
      year: document.getElementById('templateYear').value,
      foodes: document.getElementById('templateFoodes').value,
      global_avatar: document.getElementById('globalAvatar').value,
      article_title: document.getElementById('templateArticleTitle').checked,
      article_title_prefix: document.getElementById('templateArticleTitlePrefix').value,
      switch_notice: document.getElementById('templateSwitchNotice').checked,
      switch_notice_text: document.getElementById('templateSwitchNoticeText').value,
      external_link_warning: document.getElementById('externalLinkWarning').checked,
      external_link_whitelist: document.getElementById('externalLinkWhitelist').value,
      external_link_warning_text: document.getElementById('externalLinkWarningText').value,
      live2d_enabled: document.getElementById('live2dEnabled').checked,
      live2d_show_on_index: document.getElementById('live2dShowOnIndex').checked,
      live2d_show_on_passage: document.getElementById('live2dShowOnPassage').checked,
      live2d_show_on_collect: document.getElementById('live2dShowOnCollect').checked,
      live2d_show_on_about: document.getElementById('live2dShowOnAbout').checked,
      live2d_show_on_admin: document.getElementById('live2dShowOnAdmin').checked,
      live2d_model_id: document.getElementById('live2dModelId').value,
      live2d_model_path: document.getElementById('live2dModelPath').value,
      live2d_cdn_path: document.getElementById('live2dCDNPath').value,
      live2d_position: document.getElementById('live2dPosition').value,
      live2d_width: document.getElementById('live2dWidth').value,
      live2d_height: document.getElementById('live2dHeight').value,
      sponsor_enabled: document.getElementById('sponsorEnabled').checked,
      sponsor_title: document.getElementById('sponsorTitle').value,
      sponsor_image: document.getElementById('sponsorImage').value,
      sponsor_description: document.getElementById('sponsorDescription').value,
      sponsor_button_text: document.getElementById('sponsorButtonText').value
    };

    // 只发送发生变化的字段
    const changedSettings = {};
    for (const key in currentSettings) {
      if (currentSettings[key] !== originalTemplateSettings[key]) {
        changedSettings[key] = currentSettings[key];
      }
    }

    // 如果没有变化，提示用户
    if (Object.keys(changedSettings).length === 0) {
      showToast('没有检测到任何变化', 'warning');
      return;
    }

    console.log('发送变更的字段:', changedSettings);

    const response = await fetch('/api/settings/template', {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(changedSettings)
    });

    if (response.ok) {
      showToast('模板设置保存成功！', 'success');
      // 更新原始设置值
      Object.assign(originalTemplateSettings, changedSettings);
    } else {
      const result = await response.json();
      showToast('保存失败：' + (result.error || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存模板设置失败:', error);
    showToast('保存失败，请稍后重试', 'error');
  }
}

// 存储原始音乐设置值
let originalMusicSettings = {};

// 加载音乐设置
async function loadMusicSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/settings/music', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const settings = await response.json();

      // 保存原始设置值
      originalMusicSettings = { ...settings };

      // 填充表单
      document.getElementById('musicEnabled').checked = settings.enabled || false;
      document.getElementById('musicAutoPlay').checked = settings.auto_play || false;
      document.getElementById('musicControlSize').value = settings.control_size || 'medium';
      document.getElementById('musicPlayerColor').value = settings.player_color || 'rgba(66, 133, 244, 0.9)';
      document.getElementById('musicPosition').value = settings.position || 'bottom-right';
      document.getElementById('musicCustomCSS').value = settings.custom_css || '';

      // 更新颜色选择器
      const playerColor = settings.player_color || 'rgba(66, 133, 244, 0.9)';
      const rgba = parseRgba(playerColor);
      if (rgba) {
        document.getElementById('musicPlayerColorPicker').value = rgbaToHex(rgba.r, rgba.g, rgba.b);
      }
    } else {
      console.error('加载音乐设置失败');
    }
  } catch (error) {
    console.error('加载音乐设置失败:', error);
  }
}

// 保存音乐设置
async function saveMusicSettings() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // 获取当前表单值
    const currentSettings = {
      enabled: document.getElementById('musicEnabled').checked,
      auto_play: document.getElementById('musicAutoPlay').checked,
      control_size: document.getElementById('musicControlSize').value,
      player_color: document.getElementById('musicPlayerColor').value,
      position: document.getElementById('musicPosition').value,
      custom_css: document.getElementById('musicCustomCSS').value
    };

    // 只发送发生变化的字段
    const changedSettings = {};
    for (const key in currentSettings) {
      if (currentSettings[key] !== originalMusicSettings[key]) {
        changedSettings[key] = currentSettings[key];
      }
    }

    // 如果没有变化，提示用户
    if (Object.keys(changedSettings).length === 0) {
      showToast('没有检测到任何变化', 'warning');
      return;
    }

    console.log('发送变更的音乐设置字段:', changedSettings);

    const response = await fetch('/api/settings/music', {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(changedSettings)
    });

    if (response.ok) {
      showToast('音乐设置保存成功！', 'success');
      // 更新原始设置值
      Object.assign(originalMusicSettings, changedSettings);
    } else {
      const result = await response.json();
      showToast('保存失败：' + (result.error || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('保存音乐设置失败:', error);
    showToast('保存失败，请稍后重试', 'error');
  }
}

// 音乐文件上传队列管理
let musicUploadQueue = [];
let isUploading = false;
let uploadAbortController = null;

// 初始化音乐拖拽上传功能
function initMusicDragDrop() {
  const dropZone = document.getElementById('musicDropZone');
  const fileInput = document.getElementById('musicFileUpload');
  const browseLink = document.querySelector('.browse-link');

  if (!dropZone || !fileInput) return;

  // 点击上传区域触发文件选择
  dropZone.addEventListener('click', () => {
    fileInput.click();
  });

  // 点击"点击选择文件"链接触发文件选择
  if (browseLink) {
    browseLink.addEventListener('click', (e) => {
      e.stopPropagation();
      fileInput.click();
    });
  }

  // 文件选择事件
  fileInput.addEventListener('change', (e) => {
    handleFileSelect(e.target.files);
    fileInput.value = ''; // 清空以便可以重复选择相同文件
  });

  // 拖拽事件
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // 拖拽进入
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('dragover');
    }, false);
  });

  // 拖拽离开
  dropZone.addEventListener('dragleave', (e) => {
    // 只有当离开整个拖拽区域时才移除样式
    if (!dropZone.contains(e.relatedTarget)) {
      dropZone.classList.remove('dragover');
    }
  }, false);

  // 拖拽放下
  dropZone.addEventListener('drop', (e) => {
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    handleFileSelect(files);
  }, false);

  // 清空上传列表按钮
  const clearUploadBtn = document.getElementById('clearUploadBtn');
  if (clearUploadBtn) {
    clearUploadBtn.addEventListener('click', () => {
      if (isUploading) {
        showToast('正在上传中，请先取消上传', 'warning');
        return;
      }
      musicUploadQueue = [];
      updateUploadListUI();
    });
  }

  // 开始上传按钮
  const uploadAllBtn = document.getElementById('uploadAllMusicBtn');
  if (uploadAllBtn) {
    uploadAllBtn.addEventListener('click', startBatchUpload);
  }

  // 取消上传按钮
  const cancelUploadBtn = document.getElementById('cancelUploadBtn');
  if (cancelUploadBtn) {
    cancelUploadBtn.addEventListener('click', cancelBatchUpload);
  }
}

// 处理文件选择
function handleFileSelect(files) {
  if (!files || files.length === 0) return;

  const validFiles = Array.from(files).filter(file => {
    // 验证文件类型
    const validTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/wave', 'audio/ogg', 'audio/x-m4a', 'audio/mp4'];
    const validExtensions = ['.mp3', '.wav', '.ogg', '.m4a'];
    const extension = '.' + file.name.split('.').pop().toLowerCase();

    const isValidType = validTypes.includes(file.type) || validExtensions.includes(extension);

    if (!isValidType) {
      showToast(`跳过不支持的文件: ${file.name}`, 'warning');
    }

    return isValidType;
  });

  if (validFiles.length === 0) {
    showToast('没有有效的音频文件', 'warning');
    return;
  }

  // 添加到上传队列
  validFiles.forEach(file => {
    // 检查是否已存在
    const exists = musicUploadQueue.some(item => item.file.name === file.name && item.file.size === file.size);
    if (!exists) {
      musicUploadQueue.push({
        file: file,
        id: Date.now() + Math.random(),
        status: 'pending', // pending, uploading, success, error
        progress: 0,
        error: null
      });
    }
  });

  updateUploadListUI();
}

// 更新上传列表UI
function updateUploadListUI() {
  const uploadList = document.getElementById('musicUploadList');
  const uploadItems = document.getElementById('musicUploadItems');

  if (!uploadList || !uploadItems) return;

  if (musicUploadQueue.length === 0) {
    uploadList.style.display = 'none';
    return;
  }

  uploadList.style.display = 'block';

  uploadItems.innerHTML = musicUploadQueue.map((item, index) => `
    <div class="upload-item" data-id="${item.id}">
      <div class="upload-item-cover">
        <div class="cover-preview ${item.coverFile ? 'has-cover' : ''}" onclick="triggerCoverSelect('${item.id}')">
          ${item.coverFile ?
            `<img src="${item.coverPreview}" alt="封面">
             <div class="cover-remove-btn" onclick="event.stopPropagation(); removeCover('${item.id}')">×</div>` :
            '<span class="cover-placeholder">🖼️</span>'
          }
          <div class="cover-upload-hint">点击上传封面</div>
        </div>
        <input type="file" class="cover-input" id="coverInput-${item.id}" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" onchange="handleCoverSelect('${item.id}', this)">
      </div>
      <div class="upload-item-icon" style="display: none;">🎵</div>
      <div class="upload-item-info">
        <div class="upload-item-name">${item.file.name}</div>
        <div class="upload-item-meta">
          <span>${formatFileSize(item.file.size)}</span>
          <span>${item.file.type || 'audio/*'}</span>
        </div>
      </div>
      <div class="upload-item-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${item.progress}%"></div>
        </div>
        <div class="progress-text">${item.progress}%</div>
      </div>
      <div class="upload-item-status ${item.status}">
        ${getStatusText(item.status)}
      </div>
      <div class="upload-item-action">
        <button class="remove-upload-btn" onclick="removeUploadItem('${item.id}')" ${item.status === 'uploading' ? 'disabled' : ''}>×</button>
      </div>
    </div>
  `).join('');
}

// 格式化文件大小
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// 获取状态文本
function getStatusText(status) {
  const statusMap = {
    'pending': '等待上传',
    'uploading': '上传中',
    'success': '上传成功',
    'error': '上传失败'
  };
  return statusMap[status] || status;
}

// 移除上传项
function removeUploadItem(id) {
  if (isUploading) {
    showToast('正在上传中，请先取消上传', 'warning');
    return;
  }
  musicUploadQueue = musicUploadQueue.filter(item => item.id != id);
  updateUploadListUI();
}

// 触发封面选择
function triggerCoverSelect(id) {
  const coverInput = document.getElementById(`coverInput-${id}`);
  if (coverInput) {
    coverInput.click();
  }
}

// 处理封面选择
function handleCoverSelect(id, input) {
  const file = input.files[0];
  if (!file) return;

  // 验证文件类型
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
  if (!validTypes.includes(file.type)) {
    showToast('请选择有效的图片文件（JPG、PNG、GIF、WebP）', 'error');
    input.value = '';
    return;
  }

  // 验证文件大小（限制 5MB）
  if (file.size > 5 * 1024 * 1024) {
    showToast('封面图片大小不能超过 5MB', 'error');
    input.value = '';
    return;
  }

  // 创建预览
  const reader = new FileReader();
  reader.onload = function(e) {
    const item = musicUploadQueue.find(i => i.id == id);
    if (item) {
      item.coverFile = file;
      item.coverPreview = e.target.result;
      updateUploadListUI();
    }
  };
  reader.readAsDataURL(file);
}

// 移除封面
function removeCover(id) {
  const item = musicUploadQueue.find(i => i.id == id);
  if (item) {
    item.coverFile = null;
    item.coverPreview = null;

    // 清空输入框
    const coverInput = document.getElementById(`coverInput-${id}`);
    if (coverInput) {
      coverInput.value = '';
    }

    updateUploadListUI();
  }
}

// 开始批量上传
async function startBatchUpload() {
  if (isUploading) {
    showToast('正在上传中...', 'info');
    return;
  }

  const pendingItems = musicUploadQueue.filter(item => item.status === 'pending');
  if (pendingItems.length === 0) {
    showToast('没有等待上传的文件', 'warning');
    return;
  }

  isUploading = true;
  uploadAbortController = new AbortController();

  const uploadAllBtn = document.getElementById('uploadAllMusicBtn');
  const cancelUploadBtn = document.getElementById('cancelUploadBtn');
  if (uploadAllBtn) uploadAllBtn.disabled = true;
  if (cancelUploadBtn) cancelUploadBtn.disabled = false;

  let successCount = 0;
  let failCount = 0;

  // 顺序上传文件
  for (const item of pendingItems) {
    if (!isUploading) break; // 如果已取消上传

    item.status = 'uploading';
    updateUploadListUI();

    try {
      await uploadSingleMusicFile(item, uploadAbortController.signal);
      item.status = 'success';
      item.progress = 100;
      successCount++;
    } catch (error) {
      item.status = 'error';
      item.error = error.message;
      failCount++;
      console.error(`上传文件 ${item.file.name} 失败:`, error);
    }

    updateUploadListUI();
  }

  isUploading = false;
  uploadAbortController = null;

  if (uploadAllBtn) uploadAllBtn.disabled = false;
  if (cancelUploadBtn) cancelUploadBtn.disabled = true;

  // 显示上传结果
  if (successCount > 0) {
    showToast(`成功上传 ${successCount} 个文件`, 'success');
    // 重新加载播放列表
    loadMusicPlaylist();
  }
  if (failCount > 0) {
    showToast(`${failCount} 个文件上传失败`, 'error');
  }

  // 延迟清空成功的上传项
  setTimeout(() => {
    musicUploadQueue = musicUploadQueue.filter(item => item.status !== 'success');
    updateUploadListUI();
  }, 2000);
}

// 上传单个音乐文件
function uploadSingleMusicFile(item, signal) {
  return new Promise((resolve, reject) => {
    const formData = new FormData();
    formData.append('file', item.file);

    // 从文件名提取标题（去掉扩展名）
    const title = item.file.name.replace(/\.[^/.]+$/, '');
    formData.append('title', title);
    formData.append('artist', '未知艺术家');

    // 如果有封面文件，添加到表单
    if (item.coverFile) {
      formData.append('cover', item.coverFile);
    }

    const token = localStorage.getItem('auth_token');
    const headers = {};
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    // 使用 XMLHttpRequest 以支持进度监控
    const xhr = new XMLHttpRequest();

    // 上传进度
    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 100);
        item.progress = percentComplete;
        updateUploadListUI();
      }
    });

    // 上传完成
    xhr.addEventListener('load', () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve();
      } else {
        try {
          const result = JSON.parse(xhr.responseText);
          reject(new Error(result.error || '上传失败'));
        } catch (e) {
          reject(new Error(`上传失败: ${xhr.status}`));
        }
      }
    });

    // 上传错误
    xhr.addEventListener('error', () => {
      reject(new Error('网络错误'));
    });

    // 上传中止
    xhr.addEventListener('abort', () => {
      reject(new Error('上传已取消'));
    });

    // 监听中止信号
    signal.addEventListener('abort', () => {
      xhr.abort();
    });

    xhr.open('POST', '/api/music/upload');
    if (token) {
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
    }

    xhr.send(formData);
  });
}

// 取消批量上传
function cancelBatchUpload() {
  if (!isUploading) return;

  if (uploadAbortController) {
    uploadAbortController.abort();
  }

  isUploading = false;
  uploadAbortController = null;

  // 重置所有正在上传的项目状态
  musicUploadQueue.forEach(item => {
    if (item.status === 'uploading') {
      item.status = 'pending';
      item.progress = 0;
    }
  });

  updateUploadListUI();
  showToast('已取消上传', 'info');

  const uploadAllBtn = document.getElementById('uploadAllMusicBtn');
  const cancelUploadBtn = document.getElementById('cancelUploadBtn');
  if (uploadAllBtn) uploadAllBtn.disabled = false;
  if (cancelUploadBtn) cancelUploadBtn.disabled = true;
}

// 音乐文件上传（保留旧函数以兼容）
async function uploadMusicFile() {
  const fileInput = document.getElementById('musicFileUpload');

  if (!fileInput.files || fileInput.files.length === 0) {
    showToast('请选择要上传的音乐文件', 'warning');
    return;
  }

  handleFileSelect(fileInput.files);
  fileInput.value = '';
}

// 加载音乐播放列表
async function loadMusicPlaylist() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/music/playlist', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      const playlist = await response.json();
      updateMusicPlaylistUI(playlist);
    } else {
      console.error('加载播放列表失败');
    }
  } catch (error) {
    console.error('加载播放列表失败:', error);
  }
}

// 更新音乐播放列表 UI
function updateMusicPlaylistUI(playlist) {
  const container = document.getElementById('musicPlaylistContainer');
  if (!container) return;

  if (!playlist || playlist.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无音乐文件</div>';
    return;
  }

  container.innerHTML = playlist.map((track, index) => {
    // 移除文件名中的时间戳和下划线前缀
    let displayTitle = track.title;
    const timestampMatch = displayTitle.match(/^\d+_/);
    if (timestampMatch) {
      displayTitle = displayTitle.substring(timestampMatch[0].length);
    }
    
    return `
    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(0, 0, 0, 0.05);">
      <div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: rgba(0, 0, 0, 0.05); display: flex; align-items: center; justify-content: center;">
        ${track.cover_image ? 
          `<img src="${track.cover_image}" alt="${track.title}" style="width: 100%; height: 100%; object-fit: cover;">` : 
          '<span style="font-size: 24px;">🎵</span>'
        }
      </div>
      <div style="flex: 1;">
        <div style="font-weight: 500;">${displayTitle}</div>
        <div style="font-size: 0.85em; color: #666;">${track.artist}</div>
      </div>
      <div style="font-size: 0.85em; color: #999;">${track.duration}</div>
      <div style="display: flex; gap: 5px;">
        <button onclick="editMusicTitle(${track.id}, '${displayTitle.replace(/'/g, "\\'")}')" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">编辑标题</button>
        <button onclick="changeMusicCover(${track.id})" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">更换封面</button>
        <button onclick="deleteMusicTrack(${track.id})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">删除</button>
      </div>
    </div>
    `;
  }).join('');
}

// 删除音乐文件
async function deleteMusicTrack(trackId) {
  if (!confirm('确定要删除这首音乐吗？')) {
    return;
  }

  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch(`/api/music/${trackId}`, {
      method: 'DELETE',
      headers: headers
    });

    if (response.ok) {
      showToast('删除成功！', 'success');
      loadMusicPlaylist();
    } else {
      const result = await response.json();
      showToast('删除失败：' + (result.error || '未知错误'), 'error');
    }
  } catch (error) {
    console.error('删除音乐失败:', error);
    showToast('删除失败，请稍后重试', 'error');
  }
}

// 更换音乐封面
async function changeMusicCover(trackId) {
  // 创建文件选择器
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/jpeg,image/jpg,image/png,image/gif,image/webp';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // 验证文件类型
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      showToast('请选择有效的图片文件（JPEG, PNG, GIF, WebP）', 'error');
      return;
    }
    
    // 验证文件大小（最大 5MB）
    if (file.size > 5 * 1024 * 1024) {
      showToast('图片大小不能超过 5MB', 'error');
      return;
    }
    
    // 创建 FormData
    const formData = new FormData();
    formData.append('cover', file);
    
    try {
      const token = localStorage.getItem('auth_token');
      const headers = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(`/api/music/${trackId}`, {
        method: 'PUT',
        body: formData,
        headers: headers
      });
      
      if (response.ok) {
        const result = await response.json();
        showToast('封面更新成功！', 'success');
        loadMusicPlaylist(); // 重新加载播放列表以显示新封面
      } else {
        const result = await response.json();
        showToast('封面更新失败：' + (result.message || '未知错误'), 'error');
      }
    } catch (error) {
      console.error('更新封面失败:', error);
      showToast('更新封面失败，请稍后重试', 'error');
    }
  };
  
  // 触发文件选择
  input.click();
}

// 编辑音乐标题
function editMusicTitle(trackId, currentTitle) {
  // 创建模态框
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;
  
  modal.innerHTML = `
    <div style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
      <h3 style="margin: 0 0 20px 0;">编辑标题</h3>
      <input type="text" id="musicTitleInput" value="${currentTitle}" 
             style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; box-sizing: border-box;">
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="cancelBtn" style="padding: 8px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">取消</button>
        <button id="saveBtn" style="padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">保存</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // 绑定事件
  const input = modal.querySelector('#musicTitleInput');
  const cancelBtn = modal.querySelector('#cancelBtn');
  const saveBtn = modal.querySelector('#saveBtn');
  
  cancelBtn.onclick = () => {
    document.body.removeChild(modal);
  };
  
  saveBtn.onclick = async () => {
    const newTitle = input.value.trim();
    if (!newTitle) {
      showToast('标题不能为空', 'error');
      return;
    }
    
    try {
      const token = localStorage.getItem('auth_token');
      const headers = {
        'Content-Type': 'application/json'
      };
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(`/api/music/${trackId}?action=title`, {
        method: 'PUT',
        body: JSON.stringify({ title: newTitle }),
        headers: headers
      });
      
      if (response.ok) {
        const result = await response.json();
        showToast('标题更新成功！', 'success');
        document.body.removeChild(modal);
        loadMusicPlaylist(); // 重新加载播放列表以显示新标题
      } else {
        const result = await response.json();
        showToast('标题更新失败：' + (result.message || '未知错误'), 'error');
      }
    } catch (error) {
      console.error('更新标题失败:', error);
      showToast('更新标题失败，请稍后重试', 'error');
    }
  };
  
  // 点击模态框外部关闭
  modal.onclick = (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  };
  
  // 按 ESC 键关闭
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      document.body.removeChild(modal);
      document.removeEventListener('keydown', handleEsc);
    }
  };
  document.addEventListener('keydown', handleEsc);
}

// 关于页面卡片管理
let mainCards = [];
let subCards = [];

// 加载主卡片
async function loadMainCards() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/about/main-cards/admin', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      mainCards = await response.json();
      updateMainCardsTable();
      updateMainCardFilter();
    } else {
      showToast('加载主卡片失败', 'error');
    }
  } catch (error) {
    console.error('加载主卡片失败:', error);
    showToast('加载主卡片失败', 'error');
  }
}

// 更新主卡片表格
function updateMainCardsTable() {
  const tbody = document.getElementById('mainCardsTableBody');
  if (!tbody) return;

  if (mainCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">暂无主卡片</td></tr>';
    return;
  }

  tbody.innerHTML = mainCards.map(card => `
    <tr>
      <td>${card.sort_order}</td>
      <td>${card.icon || ''}</td>
      <td>${card.title}</td>
      <td>${card.layout_type}</td>
      <td>${getSubCardCount(card.id)}</td>
      <td>
        <span class="status ${card.is_enabled ? 'active' : 'inactive'}">
          ${card.is_enabled ? '启用' : '禁用'}
        </span>
      </td>
      <td>
        <button class="btn-secondary" onclick="editMainCard(${card.id})">编辑</button>
        <button class="btn-secondary" onclick="toggleMainCardEnabled(${card.id}, ${card.is_enabled})">
          ${card.is_enabled ? '禁用' : '启用'}
        </button>
        <button class="btn-danger" onclick="deleteMainCard(${card.id})">删除</button>
      </td>
    </tr>
  `).join('');
}

// 获取次卡片数量
function getSubCardCount(mainCardId) {
  return subCards.filter(sub => sub.main_card_id === mainCardId).length;
}

// 更新主卡片过滤器
function updateMainCardFilter() {
  const select = document.getElementById('subCardMainCardFilter');
  if (!select) return;

  const currentValue = select.value;
  select.innerHTML = '<option value="">全部主卡片</option>' +
    mainCards.map(card => `<option value="${card.id}">${card.title}</option>`).join('');
  select.value = currentValue;
}

// 加载次卡片
async function loadSubCards() {
  try {
    const token = localStorage.getItem('auth_token');
    const headers = {
      'Content-Type': 'application/json'
    };
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch('/api/about/sub-cards/admin', {
      method: 'GET',
      headers: headers
    });

    if (response.ok) {
      subCards = await response.json();
      updateSubCardsTable();
      updateMainCardsTable();
    } else {
      showToast('加载次卡片失败', 'error');
    }
  } catch (error) {
    console.error('加载次卡片失败:', error);
    showToast('加载次卡片失败', 'error');
  }
}

// 更新次卡片表格
function updateSubCardsTable() {
  const tbody = document.getElementById('subCardsTableBody');
  if (!tbody) return;

  const filterValue = document.getElementById('subCardMainCardFilter').value;
  let filteredCards = subCards;

  if (filterValue) {
    filteredCards = subCards.filter(sub => sub.main_card_id === parseInt(filterValue));
  }

  if (filteredCards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">暂无次卡片</td></tr>';
    return;
  }

  tbody.innerHTML = filteredCards.map(card => {
    const mainCard = mainCards.find(m => m.id === card.main_card_id);
    return `
      <tr>
        <td>${card.sort_order}</td>
        <td>${card.icon || ''}</td>
        <td>${card.title}</td>
        <td>${card.description.substring(0, 30)}${card.description.length > 30 ? '...' : ''}</td>
        <td>${card.link_url || '-'}</td>
        <td>
          <span class="status ${card.is_enabled ? 'active' : 'inactive'}">
            ${card.is_enabled ? '启用' : '禁用'}
          </span>
        </td>
        <td>
          <button class="btn-secondary" onclick="editSubCard(${card.id})">编辑</button>
          <button class="btn-secondary" onclick="toggleSubCardEnabled(${card.id}, ${card.is_enabled})">
            ${card.is_enabled ? '禁用' : '启用'}
          </button>
          <button class="btn-danger" onclick="deleteSubCard(${card.id})">删除</button>
        </td>
      </tr>
    `;
  }).join('');
}

// 添加主卡片
async function addMainCard() {
  // 清空表单
  document.getElementById('mainCardModalTitle').textContent = '添加主卡片';
  document.getElementById('mainCardForm').reset();
  document.getElementById('mainCardId').value = '';
  document.getElementById('mainCardSortOrder').value = mainCards.length + 1;
  document.getElementById('mainCardEnabled').checked = true;

  // 打开模态框
  openModal('mainCardModal');
}

// 编辑主卡片
async function editMainCard(id) {
  const card = mainCards.find(c => c.id === id);
  if (!card) return;

  // 填充编辑表单
  document.getElementById('mainCardModalTitle').textContent = '编辑主卡片';
  document.getElementById('mainCardId').value = card.id;
  document.getElementById('mainCardTitle').value = card.title || '';
  document.getElementById('mainCardIcon').value = card.icon || '';
  document.getElementById('mainCardLayoutType').value = card.layout_type || 'grid';
  document.getElementById('mainCardCustomCss').value = card.custom_css || '';
  document.getElementById('mainCardSortOrder').value = card.sort_order || 0;
  document.getElementById('mainCardEnabled').checked = card.is_enabled;

  // 打开模态框
  openModal('mainCardModal');
}

// 删除主卡片
async function deleteMainCard(id) {
  currentAction = 'delete-main-card';
  currentItemId = id;
  document.getElementById('confirmMessage').textContent = `确定要删除这个主卡片吗？所有关联的次卡片也会被删除。此操作不可撤销。`;
  openModal('confirmModal');
}

// 切换主卡片启用状态
async function toggleMainCardEnabled(id, currentStatus) {
  try {
    const token = localStorage.getItem('auth_token');
    const response = await fetch(`/api/about/main-cards/enabled?id=${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        enabled: !currentStatus
      })
    });

    if (response.ok) {
      loadMainCards();
    } else {
      showToast('操作失败', 'error');
    }
  } catch (error) {
    console.error('切换状态失败:', error);
    showToast('操作失败', 'error');
  }
}

// 添加次卡片
async function addSubCard() {
  const mainCardId = document.getElementById('subCardMainCardFilter').value;
  if (!mainCardId) {
    showToast('请先选择一个主卡片', 'warning');
    return;
  }

  // 清空表单
  document.getElementById('subCardModalTitle').textContent = '添加次卡片';
  document.getElementById('subCardForm').reset();
  document.getElementById('subCardId').value = '';

  // 填充主卡片下拉框选项
  const mainCardSelect = document.getElementById('subCardMainCardId');
  mainCardSelect.innerHTML = '<option value="">请选择主卡片</option>' +
    mainCards.map(card => `<option value="${card.id}">${card.title}</option>`).join('');
  mainCardSelect.value = mainCardId;

  document.getElementById('subCardSortOrder').value = subCards.filter(s => s.main_card_id === parseInt(mainCardId)).length + 1;
  document.getElementById('subCardEnabled').checked = true;

  // 打开模态框
  openModal('subCardModal');
}

// 编辑次卡片
async function editSubCard(id) {
  const card = subCards.find(c => c.id === id);
  if (!card) return;

  // 填充编辑表单
  document.getElementById('subCardModalTitle').textContent = '编辑次卡片';
  document.getElementById('subCardId').value = card.id;

  // 填充主卡片下拉框选项
  const mainCardSelect = document.getElementById('subCardMainCardId');
  mainCardSelect.innerHTML = '<option value="">请选择主卡片</option>' +
    mainCards.map(card => `<option value="${card.id}">${card.title}</option>`).join('');
  mainCardSelect.value = card.main_card_id;

  document.getElementById('subCardTitle').value = card.title || '';
  document.getElementById('subCardDescription').value = card.description || '';
  document.getElementById('subCardIcon').value = card.icon || '';
  document.getElementById('subCardLinkUrl').value = card.link_url || '';
  document.getElementById('subCardCustomCss').value = card.custom_css || '';
  document.getElementById('subCardSortOrder').value = card.sort_order || 0;
  document.getElementById('subCardEnabled').checked = card.is_enabled;

  // 打开模态框
  openModal('subCardModal');
}

// 删除次卡片
async function deleteSubCard(id) {
  currentAction = 'delete-sub-card';
  currentItemId = id;
  document.getElementById('confirmMessage').textContent = `确定要删除这个次卡片吗？此操作不可撤销。`;
  openModal('confirmModal');
}

// 切换次卡片启用状态
async function toggleSubCardEnabled(id, currentStatus) {
  try {
    const token = localStorage.getItem('auth_token');
    const response = await fetch(`/api/about/sub-cards/enabled?id=${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        enabled: !currentStatus
      })
    });

    if (response.ok) {
      loadSubCards();
    } else {
      showToast('操作失败', 'error');
    }
  } catch (error) {
    console.error('切换状态失败:', error);
    showToast('操作失败', 'error');
  }
}

// 初始化关于页面卡片管理
document.addEventListener('DOMContentLoaded', function() {
  // 添加主卡片按钮
  const addMainCardBtn = document.getElementById('addMainCardBtn');
  if (addMainCardBtn) {
    addMainCardBtn.addEventListener('click', addMainCard);
  }

  // 添加次卡片按钮
  const addSubCardBtn = document.getElementById('addSubCardBtn');
  if (addSubCardBtn) {
    addSubCardBtn.addEventListener('click', addSubCard);
  }

  // 刷新按钮
  const refreshAboutCardsBtn = document.getElementById('refreshAboutCardsBtn');
  if (refreshAboutCardsBtn) {
    refreshAboutCardsBtn.addEventListener('click', function() {
      loadMainCards();
      loadSubCards();
    });
  }

  // 主卡片过滤器变化
  const subCardMainCardFilter = document.getElementById('subCardMainCardFilter');
  if (subCardMainCardFilter) {
    subCardMainCardFilter.addEventListener('change', updateSubCardsTable);
  }

  // 当切换到关于页面标签时加载数据
  const aboutTab = document.querySelector('[data-tab="about"]');
  if (aboutTab) {
    aboutTab.addEventListener('click', function() {
      loadMainCards();
      loadSubCards();
    });
  }

  // 主卡片表单提交
  const mainCardForm = document.getElementById('mainCardForm');
  if (mainCardForm) {
    mainCardForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const cardId = document.getElementById('mainCardId').value;
      const title = document.getElementById('mainCardTitle').value;
      const icon = document.getElementById('mainCardIcon').value;
      const layoutType = document.getElementById('mainCardLayoutType').value;
      const customCss = document.getElementById('mainCardCustomCss').value;
      const sortOrder = parseInt(document.getElementById('mainCardSortOrder').value);
      const isEnabled = document.getElementById('mainCardEnabled').checked;

      try {
        const token = localStorage.getItem('auth_token');
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        };

        let url = '/api/about/main-cards';
        let method = 'POST';

        if (cardId) {
          url = `/api/about/main-cards/update?id=${cardId}`;
          method = 'PUT';
        }

        const response = await fetch(url, {
          method: method,
          headers: headers,
          body: JSON.stringify({
            title: title,
            icon: icon,
            layout_type: layoutType,
            custom_css: customCss,
            sort_order: sortOrder,
            is_enabled: isEnabled
          })
        });

        if (response.ok) {
          showToast(cardId ? '更新成功' : '添加成功', 'success');
          closeModal('mainCardModal');
          loadMainCards();
        } else {
          showToast('操作失败', 'error');
        }
      } catch (error) {
        console.error('操作失败:', error);
        showToast('操作失败', 'error');
      }
    });
  }

  // 次卡片表单提交
  const subCardForm = document.getElementById('subCardForm');
  if (subCardForm) {
    subCardForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const cardId = document.getElementById('subCardId').value;
      const mainCardId = parseInt(document.getElementById('subCardMainCardId').value);
      const title = document.getElementById('subCardTitle').value;
      const description = document.getElementById('subCardDescription').value;
      const icon = document.getElementById('subCardIcon').value;
      const linkUrl = document.getElementById('subCardLinkUrl').value;
      const customCss = document.getElementById('subCardCustomCss').value;
      const sortOrder = parseInt(document.getElementById('subCardSortOrder').value);
      const isEnabled = document.getElementById('subCardEnabled').checked;

      try {
        const token = localStorage.getItem('auth_token');
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        };

        let url = '/api/about/sub-cards';
        let method = 'POST';

        if (cardId) {
          url = `/api/about/sub-cards/update?id=${cardId}`;
          method = 'PUT';
        }

        const response = await fetch(url, {
          method: method,
          headers: headers,
          body: JSON.stringify({
            main_card_id: mainCardId,
            title: title,
            description: description,
            icon: icon,
            link_url: linkUrl,
            custom_css: customCss,
            sort_order: sortOrder,
            is_enabled: isEnabled
          })
        });

        if (response.ok) {
          showToast(cardId ? '更新成功' : '添加成功', 'success');
          closeModal('subCardModal');
          loadSubCards();
        } else {
          showToast('操作失败', 'error');
        }
      } catch (error) {
        console.error('操作失败:', error);
        showToast('操作失败', 'error');
      }
    });
  }
});
</script>

<!-- 文件管理器脚本 -->
<script>
// 文件管理器对象
const FileManager = {
  currentPath: 'img',
  currentRoot: 'img',
  selectedFile: null,
  filesToUpload: [],

  // 获取认证头
  getAuthHeader() {
    const token = localStorage.getItem('auth_token');
    return token ? `Bearer ${token}` : '';
  },

  // 初始化
  init() {
    this.bindEvents();
    this.loadTree();
    this.loadFiles();
  },

  // 绑定事件
  bindEvents() {
    // 上传按钮
    document.getElementById('fmUploadBtn').addEventListener('click', () => this.openUploadModal());

    // 新建文件夹按钮
    document.getElementById('fmCreateDirBtn').addEventListener('click', () => this.openCreateDirModal());

    // 返回按钮
    document.getElementById('fmBackBtn').addEventListener('click', () => this.goBack());

    // 点击外部关闭上下文菜单
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.fm-context-menu') && !e.target.closest('.fm-file-item')) {
        this.hideContextMenu();
      }
    });

    // 键盘事件
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        this.hideContextMenu();
      }
    });
  },

  // 加载目录树
  async loadTree() {
    try {
      const roots = ['img', 'markdown', 'attachments', 'music'];
      const treeContainer = document.getElementById('fmTree');
      treeContainer.innerHTML = '';

      for (const root of roots) {
        const rootItem = this.createTreeItem(root, true);
        treeContainer.appendChild(rootItem);

        // 加载子目录
        await this.loadSubDirectories(root, rootItem);
      }
    } catch (error) {
      console.error('加载目录树失败:', error);
    }
  },

  // 加载子目录
  async loadSubDirectories(path, parentElement) {
    try {
      const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`, {
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });
      const result = await response.json();

      if (result.success && result.data.files) {
        const directories = result.data.files.filter(f => f.is_dir);

        if (directories.length > 0) {
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'fm-tree-children';

          for (const dir of directories) {
            const dirPath = `${path}/${dir.name}`;
            const dirItem = this.createTreeItem(dir.name, false, dirPath);
            childrenContainer.appendChild(dirItem);

            // 递归加载子目录
            await this.loadSubDirectories(dirPath, dirItem);
          }

          parentElement.appendChild(childrenContainer);
        }
      }
    } catch (error) {
      console.error('加载子目录失败:', error);
    }
  },

  // 创建树节点
  createTreeItem(name, isRoot, path = null) {
    const item = document.createElement('div');
    item.className = 'fm-tree-item';
    if (isRoot && name === this.currentRoot) {
      item.classList.add('active');
    }

    const icon = document.createElement('span');
    icon.className = 'fm-tree-icon';
    icon.textContent = isRoot ? '📁' : '📂';
    item.appendChild(icon);

    const text = document.createElement('span');
    text.textContent = name;
    item.appendChild(text);

    const itemPath = path || name;
    item.addEventListener('click', (e) => {
      e.stopPropagation();
      this.navigateTo(itemPath);
      
      // 更新选中状态
      document.querySelectorAll('.fm-tree-item').forEach(el => el.classList.remove('active'));
      item.classList.add('active');
    });

    return item;
  },

  // 加载文件列表
  async loadFiles() {
    try {
      const response = await fetch(`/api/files?path=${encodeURIComponent(this.currentPath)}`, {
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });
      const result = await response.json();

      if (result.success) {
        this.renderFiles(result.data.files);
        this.updateBreadcrumb(result.data.currentPath);
        this.updateBackButton(result.data.parentPath);
        this.updateFileCount(result.data.files.length);
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('加载文件失败:', error);
      showToast('加载文件失败', 'error');
    }
  },

  // 渲染文件列表
  renderFiles(files) {
    const fileList = document.getElementById('fmFileList');
    const emptyState = document.getElementById('fmEmptyState');

    if (files.length === 0) {
      fileList.innerHTML = '';
      emptyState.style.display = 'flex';
      return;
    }

    emptyState.style.display = 'none';

    // 先显示目录，再显示文件
    const sortedFiles = [...files].sort((a, b) => {
      if (a.is_dir && !b.is_dir) return -1;
      if (!a.is_dir && b.is_dir) return 1;
      return a.name.localeCompare(b.name);
    });

    fileList.innerHTML = sortedFiles.map(file => this.createFileItem(file)).join('');

    // 绑定文件项事件
    fileList.querySelectorAll('.fm-file-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const path = item.dataset.path;
        const isDir = item.dataset.isDir === 'true';

        if (isDir) {
          this.navigateTo(path);
        } else {
          this.openFile(path);
        }
      });

      item.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const path = item.dataset.path;
        const isDir = item.dataset.isDir === 'true';
        this.showContextMenu(e, path, isDir);
      });
    });
  },

  // 创建文件项HTML
  createFileItem(file) {
    let icon = '📄';

    if (file.is_dir) {
      icon = '📁';
    } else if (['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'].includes(file.extension)) {
      icon = `<img src="/${file.path}/${file.name}" alt="${file.name}" onerror="this.parentElement.innerHTML='🖼️'">`;
    } else if (file.extension === '.md') {
      icon = '📝';
    }

    const size = this.formatFileSize(file.size);
    const fullPath = `${file.path}/${file.name}`;

    return `
      <div class="fm-file-item" data-path="${fullPath}" data-is-dir="${file.is_dir}">
        <div class="fm-file-icon">${icon}</div>
        <div class="fm-file-name">${file.name}</div>
        <div class="fm-file-meta">${file.is_dir ? '文件夹' : size}</div>
      </div>
    `;
  },

  // 格式化文件大小
  formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  },

  // 更新面包屑
  updateBreadcrumb(path) {
    document.getElementById('fmBreadcrumb').textContent = path || '/';
  },

  // 更新返回按钮状态
  updateBackButton(parentPath) {
    const backBtn = document.getElementById('fmBackBtn');
    backBtn.disabled = !parentPath;
  },

  // 更新文件计数
  updateFileCount(count) {
    document.getElementById('fmInfo').textContent = `${count} 个项目`;
  },

  // 导航到目录
  navigateTo(path) {
    this.currentPath = path;
    this.loadFiles();
  },

  // 返回上级目录
  goBack() {
    const parentPath = this.getParentPath(this.currentPath);
    if (parentPath) {
      this.navigateTo(parentPath);
    }
  },

  // 获取父目录路径
  getParentPath(path) {
    if (path === this.currentRoot) {
      return null;
    }
    const parts = path.split('/');
    parts.pop();
    const parent = parts.join('/');
    return parent || this.currentRoot;
  },

  // 打开文件
  openFile(path) {
    const fileName = path.split('/').pop();
    const extension = fileName.split('.').pop().toLowerCase();

    // 图片文件：全屏展示
    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(extension)) {
      const imageUrl = `/${path}`;
      this.showImagePreview(imageUrl);
      return;
    }

    // Markdown 文件：跳转到文章页面
    if (extension === 'md') {
      // 移除 markdown/ 前缀和 .md 后缀
      const passagePath = path.replace(/^markdown\//, '').replace(/\.md$/, '');
      window.location.href = `/passage/${passagePath}`;
      return;
    }

    // 其他文件类型：下载
    this.downloadFile(path);
  },

  // 展示图片预览
  showImagePreview(imageUrl) {
    // 创建图片预览模态框
    const preview = document.createElement('div');
    preview.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    `;

    const img = document.createElement('img');
    img.src = imageUrl;
    img.style.cssText = `
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
    `;

    const closeHint = document.createElement('div');
    closeHint.textContent = '点击关闭';
    closeHint.style.cssText = `
      position: absolute;
      bottom: 30px;
      color: white;
      font-size: 16px;
      opacity: 0.7;
    `;

    preview.appendChild(img);
    preview.appendChild(closeHint);

    // 点击关闭
    preview.addEventListener('click', () => {
      document.body.removeChild(preview);
    });

    // ESC 键关闭
    const closeHandler = (e) => {
      if (e.key === 'Escape') {
        document.body.removeChild(preview);
        document.removeEventListener('keydown', closeHandler);
      }
    };
    document.addEventListener('keydown', closeHandler);

    document.body.appendChild(preview);
  },

  // 下载文件
  async downloadFile(path) {
    try {
      const response = await fetch(`/api/files/download?path=${encodeURIComponent(path)}`, {
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });

      if (!response.ok) {
        const result = await response.json();
        showToast(result.message || '下载失败', 'error');
        return;
      }

      const fileName = path.split('/').pop();
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('下载失败:', error);
      showToast('下载失败', 'error');
    }
  },

  // 显示上下文菜单
  showContextMenu(event, path, isDir) {
    this.selectedFile = { path, isDir };

    // 移除旧的菜单
    const oldMenu = document.querySelector('.fm-context-menu');
    if (oldMenu) {
      oldMenu.remove();
    }

    // 创建新菜单
    const menu = document.createElement('div');
    menu.className = 'fm-context-menu';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';

    // 判断文件类型
    const fileName = path.split('/').pop();
    const extension = fileName.split('.').pop().toLowerCase();
    const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(extension);
    const isMarkdown = extension === 'md';

    const items = [
      { action: 'open', label: '打开', icon: '📂' },
      { action: 'download', label: '下载', icon: '⬇️', hide: isDir },
      { action: 'rename', label: '重命名', icon: '✏️' },
      { action: 'delete', label: '删除', icon: '🗑️', danger: true }
    ];

    items.forEach(item => {
      if (item.hide) return;

      const menuItem = document.createElement('div');
      menuItem.className = 'fm-context-menu-item' + (item.danger ? ' danger' : '');
      menuItem.innerHTML = `<span>${item.icon}</span>${item.label}`;
      menuItem.addEventListener('click', () => {
        this.handleContextAction(item.action);
        this.hideContextMenu();
      });
      menu.appendChild(menuItem);
    });

    document.body.appendChild(menu);
    menu.classList.add('active');
  },

  // 隐藏上下文菜单
  hideContextMenu() {
    const menu = document.querySelector('.fm-context-menu');
    if (menu) {
      menu.remove();
    }
  },

  // 处理上下文菜单操作
  handleContextAction(action) {
    if (!this.selectedFile) return;

    switch (action) {
      case 'open':
        if (this.selectedFile.isDir) {
          this.navigateTo(this.selectedFile.path);
        } else {
          this.openFile(this.selectedFile.path);
        }
        break;
      case 'download':
        this.downloadFile(this.selectedFile.path);
        break;
      case 'rename':
        this.openRenameModal();
        break;
      case 'delete':
        this.openDeleteModal();
        break;
    }
  },

  // 打开上传模态框
  openUploadModal() {
    // 使用现有的上传模态框
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.style.display = 'none';
    input.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length > 0) {
        this.uploadFiles(files);
      }
      input.remove();
    });
    document.body.appendChild(input);
    input.click();
  },

  // 上传文件
  async uploadFiles(files) {
    for (const file of files) {
      try {
        const formData = new FormData();
        formData.append('file', file);

        const response = await fetch(`/api/files?path=${encodeURIComponent(this.currentPath)}`, {
          method: 'POST',
          headers: {
            'Authorization': this.getAuthHeader()
          },
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          showToast(`成功上传 ${file.name}`, 'success');
        } else {
          showToast(`上传 ${file.name} 失败`, 'error');
        }
      } catch (error) {
        console.error('上传失败:', error);
        showToast(`上传 ${file.name} 失败`, 'error');
      }
    }

    this.loadFiles();
    this.loadTree();
  },

  // 打开创建目录模态框
  openCreateDirModal() {
    const dirName = prompt('请输入文件夹名称:');
    if (dirName && dirName.trim()) {
      this.createDirectory(dirName.trim());
    }
  },

  // 创建目录
  async createDirectory(dirName) {
    try {
      const response = await fetch('/api/files/create-dir', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.getAuthHeader()
        },
        body: JSON.stringify({
          path: this.currentPath,
          dir_name: dirName
        })
      });

      const result = await response.json();

      if (result.success) {
        showToast('文件夹创建成功', 'success');
        this.loadFiles();
        this.loadTree();
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('创建目录失败:', error);
      showToast('创建文件夹失败', 'error');
    }
  },

  // 打开重命名模态框
  openRenameModal() {
    if (!this.selectedFile) return;

    const oldName = this.selectedFile.path.split('/').pop();
    const newName = prompt('请输入新名称:', oldName);

    if (newName && newName.trim() && newName.trim() !== oldName) {
      this.renameFile(newName.trim());
    }
  },

  // 重命名文件
  async renameFile(newName) {
    if (!this.selectedFile) return;

    try {
      const response = await fetch('/api/files', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': this.getAuthHeader()
        },
        body: JSON.stringify({
          old_path: this.selectedFile.path,
          new_name: newName
        })
      });

      const result = await response.json();

      if (result.success) {
        showToast('重命名成功', 'success');
        this.loadFiles();
        this.loadTree();
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('重命名失败:', error);
      showToast('重命名失败', 'error');
    }
  },

  // 打开删除确认模态框
  openDeleteModal() {
    if (!this.selectedFile) return;

    const fileName = this.selectedFile.path.split('/').pop();
    if (confirm(`确定要删除 "${fileName}" 吗？此操作不可恢复！`)) {
      this.deleteFile();
    }
  },

  // 删除文件
  async deleteFile() {
    if (!this.selectedFile) return;

    try {
      const response = await fetch(`/api/files?path=${encodeURIComponent(this.selectedFile.path)}`, {
        method: 'DELETE',
        headers: {
          'Authorization': this.getAuthHeader()
        }
      });

      const result = await response.json();

      if (result.success) {
        showToast('删除成功', 'success');
        this.loadFiles();
        this.loadTree();
      } else {
        showToast(result.message, 'error');
      }
    } catch (error) {
      console.error('删除失败:', error);
      showToast('删除失败', 'error');
    }
  }
};

// 上传附件功能
const AttachmentUploader = {
  currentArticleId: null,

  init() {
    const uploadBtn = document.getElementById('uploadAttachmentBtn');
    if (uploadBtn) {
      uploadBtn.addEventListener('click', () => this.uploadAttachment());
    }
  },

  async uploadAttachment() {
    const fileInput = document.getElementById('attachmentFile');
    const articleIdElement = document.getElementById('uploadAttachmentArticleId');
    const progressDiv = document.getElementById('uploadAttachmentProgress');
    const resultDiv = document.getElementById('uploadAttachmentResult');
    const progressBar = document.getElementById('uploadAttachmentProgressBar');
    const statusDiv = document.getElementById('uploadAttachmentStatus');
    const fileInfoDiv = document.getElementById('uploadAttachmentFileInfo');

    if (!fileInput.files || fileInput.files.length === 0) {
      showToast('请选择要上传的文件', 'error');
      return;
    }

    const file = fileInput.files[0];
    this.currentArticleId = articleIdElement.dataset.articleId;

    // 显示进度
    progressDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    progressBar.style.width = '0%';
    statusDiv.textContent = '正在上传...';

    const formData = new FormData();
    formData.append('file', file);
    formData.append('passage_id', this.currentArticleId);

    try {
      const token = localStorage.getItem('auth_token');
      const response = await fetch('/api/attachments', {
        method: 'POST',
        headers: token ? { 'Authorization': `Bearer ${token}` } : {},
        body: formData
      });

      const result = await response.json();

      // 更新进度
      progressBar.style.width = '100%';

      if (result.success) {
        statusDiv.textContent = '上传成功！';
        
        // 显示结果
        resultDiv.style.display = 'block';
        fileInfoDiv.innerHTML = `
          <div><strong>文件名：</strong>${result.data.fileName}</div>
          <div><strong>文件大小：</strong>${this.formatFileSize(result.data.size)}</div>
          <div><strong>文件类型：</strong>${result.data.type}</div>
          <div><strong>访问URL：</strong><a href="${result.data.url}" target="_blank" style="color: #007bff;">${result.data.url}</a></div>
        `;

        showToast('附件上传成功！', 'success');

        // 3秒后关闭模态框
        setTimeout(() => {
          closeModal('uploadAttachmentModal');
        }, 3000);
      } else {
        statusDiv.textContent = '上传失败：' + (result.message || '未知错误');
        showToast('附件上传失败：' + (result.message || '未知错误'), 'error');
      }
    } catch (error) {
      console.error('上传附件失败:', error);
      progressBar.style.width = '100%';
      statusDiv.textContent = '上传失败：网络错误';
      showToast('附件上传失败，请稍后重试', 'error');
    }
  },

  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
};

// 当切换到文件管理标签页时初始化
document.addEventListener('DOMContentLoaded', () => {
  // 初始化上传附件功能
  AttachmentUploader.init();

  const fileManagerTab = document.querySelector('[data-tab="filemanager"]');
  if (fileManagerTab) {
    fileManagerTab.addEventListener('click', () => {
      setTimeout(() => {
        if (!FileManager.initialized) {
          FileManager.init();
          FileManager.initialized = true;
        }
      }, 100);
    });
  }
});
</script>

<!-- ECC加密工具 -->
<script src="/js/ecc-encrypt.js"></script>
<script src="/js/login.js"></script>
<!-- 模态框动画控制脚本 -->
<script src="/js/modal-animations.js"></script>
<!-- 键盘快捷键脚本 -->
<script src="/js/keyboard-shortcuts.js"></script>

<!-- Live2D 看板娘配置 -->
<script>
(function() {
  const live2dEnabled = {{.Live2DEnabled}};
  const live2dShowOnAdmin = {{.Live2DShowOnAdmin}};

  if (!live2dEnabled || !live2dShowOnAdmin) {
    return;
  }

  const live2dConfig = {
    waifuPath: 'https://fastly.jsdelivr.net/npm/live2d-widget@1.0.0/dist/waifu-tips.json',
    cdnPath: '{{.Live2DCDNPath}}',
    cubism2Path: 'https://fastly.jsdelivr.net/npm/live2d-widget@1.0.0/dist/live2d.min.js',
    cubism5Path: 'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
    modelId: {{.Live2DModelId}},
    modelPath: '{{.Live2DModelPath}}',
    tools: ['switch-model', 'switch-texture', 'photo', 'info', 'quit'],
    drag: true,
    logLevel: 'error',
    position: '{{.Live2DPosition}}',
    width: '{{.Live2DWidth}}',
    height: '{{.Live2DHeight}}'
  };

  window.addEventListener('load', function() {
    setTimeout(function() {
      try {
        if (document.querySelector('script[src*="autoload.js"]')) {
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/autoload.js';
        script.async = true;

        script.onload = function() {
          console.log('Live2D 看板娘加载完成');
          if (typeof initWidget === 'function') {
            try {
              initWidget(live2dConfig);
            } catch (e) {
              console.warn('Live2D 看板娘初始化失败:', e);
            }
          }
        };

        script.onerror = function() {
          console.warn('Live2D 看板娘加载失败，可能是网络问题或 CDN 不可用');
        };

        document.body.appendChild(script);
      } catch (error) {
        console.warn('Live2D 看板娘初始化错误:', error);
      }
    }, 1000);
  });
})();
</script>

<!-- 附件管理 JavaScript -->
<script>
(function() {
  // 附件管理全局变量
  let attachmentsData = [];
  let currentPage = 1;
  const pageSize = 20;
  let totalAttachments = 0;
  let selectedAttachments = new Set();

  // DOM 元素
  const elements = {
    uploadBtn: document.getElementById('amUploadBtn'),
    emptyUploadBtn: document.getElementById('amEmptyUploadBtn'),
    refreshBtn: document.getElementById('amRefreshBtn'),
    fileTypeFilter: document.getElementById('amFileTypeFilter'),
    visibilityFilter: document.getElementById('amVisibilityFilter'),
    passageFilter: document.getElementById('amPassageFilter'),
    searchInput: document.getElementById('amSearchInput'),
    tableBody: document.getElementById('attachmentsTableBody'),
    selectAll: document.getElementById('amSelectAll'),
    totalCount: document.getElementById('amTotalCount'),
    totalSize: document.getElementById('amTotalSize'),
    imageCount: document.getElementById('amImageCount'),
    documentCount: document.getElementById('amDocumentCount'),
    paginationContainer: document.getElementById('amPaginationContainer'),
    paginationInfo: document.getElementById('amPaginationInfo'),
    prevPageBtn: document.getElementById('amPrevPageBtn'),
    nextPageBtn: document.getElementById('amNextPageBtn'),
    paginationPages: document.getElementById('amPaginationPages'),
    batchActions: document.getElementById('amBatchActions'),
    selectedCount: document.getElementById('amSelectedCount'),
    batchDeleteBtn: document.getElementById('amBatchDeleteBtn'),
    batchSetPublicBtn: document.getElementById('amBatchSetPublicBtn'),
    batchSetPrivateBtn: document.getElementById('amBatchSetPrivateBtn'),
    cancelSelectionBtn: document.getElementById('amCancelSelectionBtn')
  };

  // 工具函数：格式化文件大小
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // 工具函数：格式化日期
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // 工具函数：获取文件类型图标
  function getFileTypeIcon(fileType) {
    const icons = {
      image: '🖼️',
      document: '📄',
      video: '🎬',
      audio: '🎵',
      archive: '📦'
    };
    return icons[fileType] || '📎';
  }

  // 工具函数：获取可见性标签
  function getVisibilityBadge(visibility) {
    const badges = {
      public: '<span class="status published">公开</span>',
      private: '<span class="status draft">私密</span>',
      protected: '<span class="status pending">受保护</span>'
    };
    return badges[visibility] || visibility;
  }

  // 加载附件列表
  window.loadAttachments = async function loadAttachments() {
    try {
      const params = new URLSearchParams({
        limit: pageSize,
        offset: (currentPage - 1) * pageSize
      });

      // 添加筛选参数
      const fileType = elements.fileTypeFilter.value;
      const visibility = elements.visibilityFilter.value;
      const passageId = elements.passageFilter.value;
      const search = elements.searchInput.value.trim();

      if (fileType) params.append('file_type', fileType);
      if (visibility) params.append('visibility', visibility);
      if (passageId) params.append('passage_id', passageId);

      const response = await fetch(`/api/admin/attachments?${params.toString()}`);
      const result = await response.json();

      if (result.success) {
        attachmentsData = result.data || [];
        totalAttachments = result.total || 0;

        // 如果有搜索关键词，在前端过滤
        if (search) {
          attachmentsData = attachmentsData.filter(att => 
            att.file_name.toLowerCase().includes(search.toLowerCase())
          );
          totalAttachments = attachmentsData.length;
        }

        renderAttachments();
        updateStats();
        updatePagination();
      } else {
        showToast('加载附件列表失败: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('加载附件列表失败:', error);
      showToast('加载附件列表失败，请检查网络连接', 'error');
    }
  }

  // 渲染附件列表
  function renderAttachments() {
    if (attachmentsData.length === 0) {
      elements.tableBody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; padding: 40px;">
            <div class="am-empty-state">
              <div class="am-empty-icon">📭</div>
              <p>暂无附件</p>
              <button class="btn-primary" id="amEmptyUploadBtn" style="margin-top: 15px;">
                上传第一个附件
              </button>
            </div>
          </td>
        </tr>
      `;
      return;
    }

    elements.tableBody.innerHTML = attachmentsData.map(attachment => {
      const isSelected = selectedAttachments.has(attachment.id);
      const previewUrl = attachment.file_path;
      const isImage = attachment.file_type === 'image';

      return `
        <tr class="${isSelected ? 'selected' : ''}" data-id="${attachment.id}">
          <td>
            <input type="checkbox" class="am-checkbox" 
                   data-id="${attachment.id}" 
                   ${isSelected ? 'checked' : ''}>
          </td>
          <td>
            ${isImage ? 
              `<img src="${previewUrl}" alt="${attachment.file_name}" 
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                     onclick="window.open('${previewUrl}', '_blank')">` :
              `<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 4px;">
                ${getFileTypeIcon(attachment.file_type)}
               </div>`
            }
          </td>
          <td>
            <div style="font-weight: 500;">${attachment.file_name}</div>
            <div style="font-size: 0.85em; color: #888;">${attachment.stored_name}</div>
          </td>
          <td>${getFileTypeIcon(attachment.file_type)} ${attachment.file_type}</td>
          <td>${formatFileSize(attachment.file_size)}</td>
          <td>${getVisibilityBadge(attachment.visibility)}</td>
          <td>${attachment.passage_id ? `<a href="/passage?id=${attachment.passage_id}" target="_blank">#${attachment.passage_id}</a>` : '-'}</td>
          <td>${formatDate(attachment.uploaded_at)}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-sm btn-view" onclick="viewAttachment(${attachment.id})" title="查看">
                👁️
              </button>
              <button class="btn btn-sm btn-edit" onclick="editAttachment(${attachment.id})" title="编辑权限">
                🔒
              </button>
              <button class="btn btn-sm btn-delete" onclick="deleteAttachment(${attachment.id})" title="删除">
                🗑️
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    // 绑定复选框事件
    document.querySelectorAll('.am-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', handleCheckboxChange);
    });

    // 绑定空状态上传按钮
    const emptyUploadBtn = document.getElementById('amEmptyUploadBtn');
    if (emptyUploadBtn) {
      emptyUploadBtn.addEventListener('click', showUploadModal);
    }
  }

  // 更新统计信息
  function updateStats() {
    elements.totalCount.textContent = totalAttachments;

    let totalSize = 0;
    let imageCount = 0;
    let documentCount = 0;

    attachmentsData.forEach(att => {
      totalSize += att.file_size;
      if (att.file_type === 'image') imageCount++;
      if (att.file_type === 'document') documentCount++;
    });

    elements.totalSize.textContent = formatFileSize(totalSize);
    elements.imageCount.textContent = imageCount;
    elements.documentCount.textContent = documentCount;
  }

  // 更新分页
  function updatePagination() {
    const totalPages = Math.ceil(totalAttachments / pageSize);

    if (totalPages <= 1) {
      elements.paginationContainer.style.display = 'none';
      return;
    }

    elements.paginationContainer.style.display = 'flex';
    elements.paginationInfo.textContent = `显示 ${(currentPage - 1) * pageSize + 1}-${Math.min(currentPage * pageSize, totalAttachments)} 条，共 ${totalAttachments} 条`;

    elements.prevPageBtn.disabled = currentPage === 1;
    elements.nextPageBtn.disabled = currentPage === totalPages;

    // 生成页码
    let pages = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      pages += `<button class="pagination-page ${i === currentPage ? 'active' : ''}" 
                       data-page="${i}">${i}</button>`;
    }

    elements.paginationPages.innerHTML = pages;

    // 绑定页码点击事件
    document.querySelectorAll('#amPaginationPages .pagination-page').forEach(btn => {
      btn.addEventListener('click', () => {
        currentPage = parseInt(btn.dataset.page);
        loadAttachments();
      });
    });
  }

  // 处理复选框变化
  function handleCheckboxChange(e) {
    const id = parseInt(e.target.dataset.id);
    if (e.target.checked) {
      selectedAttachments.add(id);
    } else {
      selectedAttachments.delete(id);
      elements.selectAll.checked = false;
    }
    updateBatchActions();
  }

  // 更新批量操作栏
  function updateBatchActions() {
    const count = selectedAttachments.size;
    elements.selectedCount.textContent = count;
    elements.batchActions.style.display = count > 0 ? 'flex' : 'none';
  }

  // 显示上传模态框
  function showUploadModal() {
    const modalHtml = `
      <div class="modal active" id="uploadModal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>上传附件</h3>
            <button class="modal-close" onclick="closeUploadModal()">×</button>
          </div>
          <div class="modal-body">
            <div class="upload-area" id="uploadArea">
              <div class="upload-icon">📤</div>
              <div class="upload-text">
                <h4>拖拽文件到这里或点击上传</h4>
                <p>支持图片、文档、视频、音频、压缩包</p>
              </div>
              <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            <div class="upload-preview" id="uploadPreview"></div>
            <div class="form-group" style="margin-top: 20px;">
              <label for="uploadPassageId">关联文章（可选）</label>
              <select id="uploadPassageId" class="form-control">
                <option value="">不关联</option>
              </select>
            </div>
          </div>
          <div class="btn-group" style="padding: 0 30px 30px;">
            <button class="btn-secondary" onclick="closeUploadModal()">取消</button>
            <button class="btn-primary" id="confirmUploadBtn" disabled>开始上传</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    initUploadModal();
  }

  // 初始化上传模态框
  function initUploadModal() {
    const modal = document.getElementById('uploadModal');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadPreview = document.getElementById('uploadPreview');
    const confirmUploadBtn = document.getElementById('confirmUploadBtn');
    const passageIdSelect = document.getElementById('uploadPassageId');

    let selectedFiles = [];

    // 加载文章列表
    loadPassageList(passageIdSelect);

    // 点击上传区域
    uploadArea.addEventListener('click', () => fileInput.click());

    // 文件选择
    fileInput.addEventListener('change', (e) => {
      handleFileSelect(e.target.files);
    });

    // 拖拽上传
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFileSelect(e.dataTransfer.files);
    });

    function handleFileSelect(files) {
      selectedFiles = Array.from(files);
      renderPreview();
      confirmUploadBtn.disabled = selectedFiles.length === 0;
    }

    function renderPreview() {
      uploadPreview.innerHTML = selectedFiles.map((file, index) => `
        <div class="upload-item">
          ${file.type.startsWith('image/') ? 
            `<img src="${URL.createObjectURL(file)}" alt="${file.name}">` :
            `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f5f5f5;">
              ${getFileTypeIcon(getFileTypeFromMime(file.type))}
             </div>`
          }
          <button class="upload-remove" onclick="removeUploadFile(${index})">×</button>
          <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 0.75em; padding: 4px; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${file.name}
          </div>
        </div>
      `).join('');
    }

    // 确认上传
    confirmUploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      confirmUploadBtn.disabled = true;
      confirmUploadBtn.textContent = '上传中...';

      const passageId = passageIdSelect.value;

      for (const file of selectedFiles) {
        const formData = new FormData();
        formData.append('file', file);
        if (passageId) {
          formData.append('passage_id', passageId);
        }

        try {
          const response = await fetch('/api/attachments', {
            method: 'POST',
            body: formData
          });
          const result = await response.json();

          if (!result.success) {
            showToast(`上传 ${file.name} 失败: ${result.message}`, 'error');
          }
        } catch (error) {
          console.error('上传失败:', error);
          showToast(`上传 ${file.name} 失败`, 'error');
        }
      }

      showToast('上传完成', 'success');
      closeUploadModal();
      loadAttachments();
    });

    // 全局函数：移除上传文件
    window.removeUploadFile = function(index) {
      selectedFiles.splice(index, 1);
      renderPreview();
      confirmUploadBtn.disabled = selectedFiles.length === 0;
    };
  }

  // 加载文章列表
  async function loadPassageList(selectElement) {
    try {
      const response = await fetch('/api/admin/passages?limit=100');
      const result = await response.json();

      if (result.success && result.data) {
        result.data.forEach(passage => {
          const option = document.createElement('option');
          option.value = passage.id;
          option.textContent = passage.title;
          selectElement.appendChild(option);
        });
      }
    } catch (error) {
      console.error('加载文章列表失败:', error);
    }
  }

  // 关闭上传模态框
  window.closeUploadModal = function() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
      modal.remove();
    }
  };

  // 查看附件
  window.viewAttachment = function(id) {
    const attachment = attachmentsData.find(a => a.id === id);
    if (attachment) {
      window.open(attachment.file_path, '_blank');
    }
  };

  // 编辑附件权限
  window.editAttachment = async function(id) {
    console.log('打开编辑模态框，ID:', id);

    // 先移除已存在的模态框
    const existingModal = document.getElementById('editModal');
    if (existingModal) {
      existingModal.remove();
    }

    // 从API获取最新的附件数据
    try {
      const response = await fetch(`/api/admin/attachments?id=${id}`);
      const result = await response.json();

      if (result.success && result.data) {
        // 后端返回的是数组格式,取第一个元素
        const attachment = Array.isArray(result.data) ? result.data[0] : result.data;
        console.log('从API获取的附件数据:', attachment);

        const modalHtml = `
          <div class="modal active" id="editModal">
            <div class="modal-content">
              <div class="modal-header">
                <h3>编辑附件权限</h3>
                <button class="modal-close" onclick="closeEditModal()">×</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label>文件名</label>
                  <input type="text" class="form-control" value="${attachment.file_name}" disabled>
                </div>
                <div class="form-group">
                  <label for="editVisibility">可见性</label>
                  <select id="editVisibility" class="form-control">
                    <option value="public" ${(attachment.visibility || 'public') === 'public' ? 'selected' : ''}>公开</option>
                    <option value="private" ${(attachment.visibility || 'public') === 'private' ? 'selected' : ''}>私密</option>
                    <option value="protected" ${(attachment.visibility || 'public') === 'protected' ? 'selected' : ''}>受保护</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="editShowInPassage">
                    <input type="checkbox" id="editShowInPassage" ${attachment.show_in_passage ? 'checked' : ''}>
                    在文章中显示
                  </label>
                </div>
              </div>
              <div class="btn-group" style="padding: 0 30px 30px;">
                <button class="btn-secondary" onclick="closeEditModal()">取消</button>
                <button class="btn-primary" onclick="saveAttachmentSettings(${id})">保存</button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
      } else {
        showToast('获取附件信息失败: ' + (result.message || '未知错误'), 'error');
      }
    } catch (error) {
      console.error('获取附件信息失败:', error);
      showToast('获取附件信息失败', 'error');
    }
  };

  // 保存附件设置
  window.saveAttachmentSettings = async function(id) {
    const visibility = document.getElementById('editVisibility').value;
    const showInPassage = document.getElementById('editShowInPassage').checked;

    console.log('保存附件设置:', { id, visibility, showInPassage });

    try {
      const response = await fetch(`/api/admin/attachments?id=${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          visibility: visibility,
          show_in_passage: showInPassage
        })
      });
      const result = await response.json();

      console.log('保存响应:', result);

      if (result.success) {
        showToast('保存成功', 'success');
        closeEditModal();
        console.log('正在重新加载附件列表...');
        await loadAttachments();
        console.log('附件列表重新加载完成');
      } else {
        showToast('保存失败: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('保存失败:', error);
      showToast('保存失败', 'error');
    }
  };

  // 关闭编辑模态框
  window.closeEditModal = function() {
    const modal = document.getElementById('editModal');
    if (modal) {
      modal.classList.add('closing');
      setTimeout(() => {
        modal.remove();
      }, 300);
    }
  };

  // 删除附件
  window.deleteAttachment = async function(id) {
    if (!confirm('确定要删除这个附件吗？此操作不可恢复。')) {
      return;
    }

    try {
      const response = await fetch(`/api/attachments?id=${id}`, {
        method: 'DELETE'
      });
      const result = await response.json();

      if (result.success) {
        showToast('删除成功', 'success');
        selectedAttachments.delete(id);
        updateBatchActions();
        loadAttachments();
      } else {
        showToast('删除失败: ' + result.message, 'error');
      }
    } catch (error) {
      console.error('删除失败:', error);
      showToast('删除失败', 'error');
    }
  };

  // 批量删除
  async function batchDelete() {
    if (selectedAttachments.size === 0) return;

    if (!confirm(`确定要删除选中的 ${selectedAttachments.size} 个附件吗？此操作不可恢复。`)) {
      return;
    }

    let successCount = 0;
    let failCount = 0;

    for (const id of selectedAttachments) {
      try {
        const response = await fetch(`/api/attachments?id=${id}`, {
          method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
          successCount++;
        } else {
          failCount++;
        }
      } catch (error) {
        console.error('删除失败:', error);
        failCount++;
      }
    }

    if (successCount > 0) {
      showToast(`成功删除 ${successCount} 个附件`, 'success');
    }
    if (failCount > 0) {
      showToast(`${failCount} 个附件删除失败`, 'error');
    }

    selectedAttachments.clear();
    updateBatchActions();
    loadAttachments();
  }

  // 批量设置可见性
  async function batchSetVisibility(visibility) {
    if (selectedAttachments.size === 0) return;

    let successCount = 0;
    let failCount = 0;

    for (const id of selectedAttachments) {
      try {
        const response = await fetch(`/api/admin/attachments?id=${id}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            visibility: visibility
          })
        });
        const result = await response.json();

        if (result.success) {
          successCount++;
        } else {
          failCount++;
        }
      } catch (error) {
        console.error('设置失败:', error);
        failCount++;
      }
    }

    if (successCount > 0) {
      showToast(`成功设置 ${successCount} 个附件`, 'success');
    }
    if (failCount > 0) {
      showToast(`${failCount} 个附件设置失败`, 'error');
    }

    loadAttachments();
  }

  // 取消选择
  function cancelSelection() {
    selectedAttachments.clear();
    elements.selectAll.checked = false;
    updateBatchActions();
    renderAttachments();
  }

  // 从MIME类型获取文件类型
  function getFileTypeFromMime(mimeType) {
    if (mimeType.startsWith('image/')) return 'image';
    if (mimeType.startsWith('video/')) return 'video';
    if (mimeType.startsWith('audio/')) return 'audio';
    if (mimeType.includes('pdf') || mimeType.includes('document') || mimeType.includes('word') || mimeType.includes('excel') || mimeType.includes('powerpoint')) return 'document';
    if (mimeType.includes('zip') || mimeType.includes('tar') || mimeType.includes('rar') || mimeType.includes('7z')) return 'archive';
    return 'document';
  }

  // 显示Toast提示
  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <span class="toast-icon">${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}</span>
      <span class="toast-message">${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">×</button>
    `;
    container.appendChild(toast);

    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // 初始化事件监听
  function initEventListeners() {
    // 上传按钮
    if (elements.uploadBtn) {
      elements.uploadBtn.addEventListener('click', showUploadModal);
    }

    // 刷新按钮
    if (elements.refreshBtn) {
      elements.refreshBtn.addEventListener('click', loadAttachments);
    }

    // 筛选器
    if (elements.fileTypeFilter) {
      elements.fileTypeFilter.addEventListener('change', () => {
        currentPage = 1;
        loadAttachments();
      });
    }

    if (elements.visibilityFilter) {
      elements.visibilityFilter.addEventListener('change', () => {
        currentPage = 1;
        loadAttachments();
      });
    }

    if (elements.passageFilter) {
      elements.passageFilter.addEventListener('change', () => {
        currentPage = 1;
        loadAttachments();
      });
    }

    if (elements.searchInput) {
      elements.searchInput.addEventListener('input', debounce(() => {
        currentPage = 1;
        loadAttachments();
      }, 500));
    }

    // 全选框
    if (elements.selectAll) {
      elements.selectAll.addEventListener('change', (e) => {
        const checked = e.target.checked;
        document.querySelectorAll('.am-checkbox').forEach(checkbox => {
          checkbox.checked = checked;
          const id = parseInt(checkbox.dataset.id);
          if (checked) {
            selectedAttachments.add(id);
          } else {
            selectedAttachments.delete(id);
          }
        });
        updateBatchActions();
        renderAttachments();
      });
    }

    // 分页按钮
    if (elements.prevPageBtn) {
      elements.prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadAttachments();
        }
      });
    }

    if (elements.nextPageBtn) {
      elements.nextPageBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(totalAttachments / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          loadAttachments();
        }
      });
    }

    // 批量操作按钮
    if (elements.batchDeleteBtn) {
      elements.batchDeleteBtn.addEventListener('click', batchDelete);
    }

    if (elements.batchSetPublicBtn) {
      elements.batchSetPublicBtn.addEventListener('click', () => batchSetVisibility('public'));
    }

    if (elements.batchSetPrivateBtn) {
      elements.batchSetPrivateBtn.addEventListener('click', () => batchSetVisibility('private'));
    }

    if (elements.cancelSelectionBtn) {
      elements.cancelSelectionBtn.addEventListener('click', cancelSelection);
    }
  }

  // 防抖函数
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // 初始化
  function init() {
    initEventListeners();
    loadAttachments();
  }

  // 页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<!-- 音乐播放器 -->
<link rel="stylesheet" href="/css/music-player.css">
<script src="/js/music-player.js"></script>
</body>
</html>
