<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>归档调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .year-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .year-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .article-item {
            padding: 10px;
            margin: 5px 0;
            background: #f5f5f5;
            border-radius: 3px;
        }
        .article-title {
            font-weight: bold;
            color: #007bff;
        }
        .article-date {
            color: #666;
            font-size: 0.9em;
        }
        .debug-info {
            background: #fff3cd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>归档调试页面</h1>
    
    <div class="debug-info" id="debugInfo">
        <h3>调试信息</h3>
        <p>正在加载数据...</p>
    </div>
    
    <div id="archiveContent"></div>
    
    <script>
        async function loadArchiveData() {
            const debugInfo = document.getElementById('debugInfo');
            const archiveContent = document.getElementById('archiveContent');
            
            try {
                // 获取文章列表
                const passagesResponse = await fetch('/api/passages?limit=1000&offset=0');
                const passagesResult = await passagesResponse.json();
                
                debugInfo.innerHTML = `
                    <h3>调试信息</h3>
                    <p>API响应成功: ${passagesResult.success}</p>
                    <p>文章总数: ${passagesResult.data ? passagesResult.data.length : 0}</p>
                    <p>分页信息: 页码=${passagesResult.pagination?.page}, 每页=${passagesResult.pagination?.limit}, 总数=${passagesResult.pagination?.total}</p>
                `;
                
                if (!passagesResult.success || !passagesResult.data || passagesResult.data.length === 0) {
                    archiveContent.innerHTML = '<p>没有找到文章</p>';
                    return;
                }
                
                const passages = passagesResult.data;
                
                // 按年份分组
                const groupedByYear = {};
                passages.forEach(passage => {
                    const date = new Date(passage.created_at);
                    const year = date.getFullYear();
                    
                    if (!groupedByYear[year]) {
                        groupedByYear[year] = [];
                    }
                    groupedByYear[year].push(passage);
                });
                
                // 按年份降序排序
                const sortedYears = Object.keys(groupedByYear).sort((a, b) => b - a);
                
                let html = '';
                sortedYears.forEach(year => {
                    html += `<div class="year-section">
                        <div class="year-title">${year}年 (${groupedByYear[year].length} 篇文章)</div>`;
                    
                    // 按日期降序排序
                    const yearPassages = groupedByYear[year].sort((a, b) =>
                        new Date(b.created_at) - new Date(a.created_at)
                    );
                    
                    yearPassages.forEach(passage => {
                        const date = new Date(passage.created_at);
                        const formattedDate = date.toLocaleDateString('zh-CN');
                        
                        html += `
                            <div class="article-item">
                                <div class="article-title">${passage.title}</div>
                                <div class="article-date">ID: ${passage.id} | 日期: ${formattedDate} | 状态: ${passage.status}</div>
                            </div>`;
                    });
                    
                    html += '</div>';
                });
                
                archiveContent.innerHTML = html;
                
            } catch (error) {
                debugInfo.innerHTML = `
                    <h3>调试信息</h3>
                    <p style="color: red;">加载失败: ${error.message}</p>
                `;
                console.error('加载失败:', error);
            }
        }
        
        // 页面加载时执行
        loadArchiveData();
    </script>
</body>
</html>